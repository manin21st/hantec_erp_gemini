# 프로그램 명세서: PBMigrator

## 1. 개요

### 1.1. 프로그램 목적
본 프로그램(`PBMigrator`)은 HANTEC ERP 시스템의 PowerBuilder 10 소스 코드(.srw)를 PowerBuilder 10.5 버전과 호환되도록 자동으로 변환하는 것을 목적으로 한다. 사용자가 시각적으로 변환 과정을 확인하고 제어할 수 있는 GUI 환경을 제공하여 작업의 정확성과 안정성을 높인다.

### 1.2. 범위
- **입력**: `worklist.md`에 명시된 PowerBuilder 10 `.srw` 파일 목록.
- **처리**: `gemini.md` 핸드북에 정의된 마이그레이션 규칙(P-01 ~ P-05) 적용.
- **출력**:
    1. 변환된 PowerBuilder 10.5 호환 `.srw` 파일.
    2. 각 파일의 변환 내역을 기록한 Markdown 형식의 보고서.

---

## 2. 요구사항

### 2.1. 기능 요구사항
- **파일 로딩**: `worklist.md` 파일의 경로 목록을 읽어 GUI의 파일 목록에 표시해야 한다.
- **규칙 선택**: 사용자는 GUI를 통해 각 마이그레이션 규칙(P-01 ~ P-05)을 개별적으로 선택하거나 해제할 수 있어야 한다.
- **실시간 비교 (Diff View)**: 원본 코드와 선택된 규칙이 적용된 후의 코드를 나란히 비교하여 보여주는 기능을 제공해야 한다.
- **미리보기**: 실제 파일로 저장하기 전, 변환될 결과를 화면의 'Diff 뷰'에서 미리 확인할 수 있어야 한다.
- **파일 저장**: 사용자의 최종 확인 후, 변환된 코드를 지정된 `target` 경로에 원본과 동일한 하위 폴더 구조를 유지하며 저장해야 한다.
- **보고서 생성**: 파일 저장 시, 적용된 규칙과 그 결과를 요약한 Markdown 보고서를 생성해야 한다.

### 2.2. 비기능 요구사항
- **플랫폼**: Windows 환경에서 실행 가능해야 한다.
- **의존성**: Python 표준 라이브러리(Tkinter, re, os 등) 사용을 기본으로 하며, 외부 라이브러리 설치를 최소화한다.

---

## 3. 시스템 아키텍처

### 3.1. 모듈 구조
```
pb_migrator/
├── main.py             # 프로그램 시작점, GUI 애플리케이션 실행
├── gui.py              # Tkinter 기반의 메인 UI 창 및 위젯 정의, 이벤트 처리
├── engine.py           # 마이그레이션 규칙을 순차적으로 적용하는 핵심 변환 엔진
├── reporting.py        # 변환 결과 보고서(.md) 생성 모듈
└── rules/              # 개별 마이그레이션 규칙 구현 패키지
    ├── __init__.py
    ├── p01_encoding.py     # 파일 인코딩(UTF-16 LE) 및 줄바꿈(CRLF) 처리
    ├── p02_inheritance.py  # 상속 컨트롤 속성 수정
    ├── p03_events.py       # 사용자 이벤트 프로토타입 추가
    ├── p04_std_events.py   # 표준 이벤트(resize, activate) 추가
    └── p05_controls.py     # 불필요한 장식용 컨트롤 제거
```

### 3.2. 컴포넌트 설명
- `main.py`: 프로그램의 진입점. `gui.py`의 메인 애플리케이션 클래스를 인스턴스화하고 실행한다.
- `gui.py`: UI의 모든 시각적 요소(창, 버튼, 텍스트 뷰 등)를 생성하고 배치한다. 사용자 입력(버튼 클릭, 파일 선택 등)을 받아 `engine.py`의 기능을 호출하고, 그 결과를 다시 UI에 반영한다. **파일을 읽을 때 `cp949` 인코딩을 사용하여 한글 깨짐을 원천적으로 방지한다.**
- `engine.py`: `MigrationEngine` 클래스를 포함. 이 클래스는 소스 코드 문자열을 입력받아 `rules` 패키지의 함수들을 순차적으로 적용한 뒤, 변환된 코드 문자열과 변경 내역 로그를 반환한다.
- `rules/`: 각 `pXX_*.py` 파일은 단일 마이그레이션 규칙을 처리하는 함수를 포함한다. 각 함수는 코드 문자열을 입력받아 해당 규칙이 적용된 코드 문자열을 반환한다.
- `reporting.py`: 변환 작업 완료 후, `engine`으로부터 변경 내역 로그를 받아 `checklist.md`와 유사한 형식의 최종 보고서를 생성한다.

---

## 4. GUI 상세 설계

### 4.1. 화면 레이아웃
- **탭 기반 레이아웃**
    1. **'설정 및 실행' 탭**: 좌측에는 파일 목록, 우측에는 마이그레이션 규칙 선택 및 실행 버튼, 그리고 하단에 로그 창을 배치하여 작업의 설정과 실행을 한 곳에서 관리합니다.
    2. **'소스 비교' 탭**: 원본과 변환 후의 코드를 비교하는 Diff 뷰만 배치하여 코드 분석의 가독성과 공간 활용성을 극대화합니다.

### 4.2. 위젯 및 컨트롤
- **메뉴바**: `파일 > 종료` 등 표준 메뉴를 제공합니다.
- **파일 리스트 박스**: 사용자가 마이그레이션할 파일을 선택합니다. 선택 시 '설정 및 실행' 탭으로 자동 이동하며, 하단 상태바에 파일명을 표시합니다.
- **규칙 체크박스**: 각 규칙의 상세 설명을 함께 표시하여 가독성을 높입니다.
- **`[미리보기]` 버튼**: 변환 실행 후, 자동으로 '소스 비교' 탭으로 전환하여 결과를 즉시 보여줍니다.
- **`[최종 저장]` 버튼**: '소스 비교' 탭의 내용을 실제 `target` 폴더에 파일로 저장하고, 결과 보고서를 생성합니다.
- **Diff 뷰**: 좌우 스크롤이 동기화되며, 추가/수정/삭제된 라인을 색상으로 구분하여 표시합니다.
- **상태바**: 창 하단에 위치하며, 현재 선택된 파일이나 작업 상태 등 주요 정보를 표시합니다.

---

## 5. 작업 흐름 (Workflow)
1.  사용자가 `main.py`를 실행하여 GUI 애플리케이션을 시작한다.
2.  프로그램은 자동으로 `worklist.md`를 로드하여 좌측 파일 목록을 채운다.
3.  사용자가 파일 목록에서 특정 파일을 클릭한다.
4.  선택된 파일의 소스 코드가 **`cp949` 인코딩으로** 'Diff 뷰' 왼쪽 창에 표시된다.
5.  사용자가 우측 제어판에서 적용할 규칙을 선택(또는 해제)한다.
6.  사용자가 `[미리보기]` 버튼을 클릭한다.
7.  `gui.py`는 `engine.py`를 호출. `engine`은 선택된 규칙들을 순차 적용하여 변환된 코드 내용을 `gui.py`에 반환한다.
8.  반환된 코드가 'Diff 뷰' 오른쪽 창에 표시된다. 사용자는 스크롤하며 변경 사항을 시각적으로 확인한다.
9.  사용자가 `[최종 저장]` 버튼을 클릭한다.
10. `gui.py`는 `engine.py`에 파일 저장 명령을 내린다. `engine`은 `target` 경로에 변환된 파일을 저장하고, `reporting.py`를 호출하여 작업 보고서를 생성한다.
11. 저장 및 보고서 생성 결과가 하단의 로그 창에 표시된다.

---

## 6. 핵심 변환 규칙
- **P-01 (파일 형식)**: `rules/p01_encoding.py`에서 처리. 최종 저장 시점에 파일 인코딩을 `UTF-16 LE`로, 줄바꿈을 `CRLF`로 변환한다.
- **P-02 (상속 컨트롤 재정의)**: `rules/p02_inheritance.py`에서 처리. 정규표현식을 사용하여 `visible = false` 속성을 찾아 `x`, `y` 좌표 변경으로 수정한다.
- **P-03 (이벤트 프로토타입)**: `rules/p03_events.py`에서 처리. 소스코드에서 사용자 이벤트를 파싱하여 `forward prototypes` 블록에 추가한다.
- **P-04 (표준 이벤트 추가)**: `rules/p04_std_events.py`에서 처리. `resize`, `activate` 이벤트 스크립트 블록을 소스코드에 삽입한다.
- **P-05 (장식용 컨트롤 삭제)**: `rules/p05_controls.py`에서 처리. 정규표현식을 사용하여 대상 컨트롤(`rr_*`, `ln_*`, `gb_*`)과 관련된 모든 코드를 삭제한다.
- **P-06 (깨진 한글 수정)**: **별도 규칙으로 처리하지 않음.** `gui.py`의 파일 로딩 단계에서 원본 파일을 `cp949` 인코딩으로 읽어들여 한글 깨짐 문제를 원천적으로 해결한다.