# 프로그램 명세서: PBMigrator

## 1. 개요

### 1.1. 프로그램 목적
본 프로그램(`PBMigrator`)은 HANTEC ERP 시스템의 PowerBuilder 10 소스 코드(.srw)를 PowerBuilder 10.5 버전과 호환되도록 자동으로 변환하는 것을 목적으로 한다. 사용자가 시각적으로 변환 과정을 확인하고 제어할 수 있는 GUI 환경을 제공하여 작업의 정확성과 안정성을 높인다.

### 1.2. 범위
- **입력**: `source` 폴더 하위의 모든 PowerBuilder 10 `.srw` 파일.
- **처리**: `gemini.md` 핸드북에 정의된 마이그레이션 규칙(P-01 ~ P-08) 적용.
- **출력**:
    1. 변환된 PowerBuilder 10.5 호환 `.srw` 파일.
    2. 각 파일의 변환 내역을 기록한 Markdown 형식의 보고서.

---

## 2. 요구사항

### 2.1. 기능 요구사항
- **파일 로딩**: `source` 폴더 하위의 모든 `.srw` 파일을 재귀적으로 찾아 GUI의 파일 목록에 표시해야 한다.
- **규칙 선택**: 사용자는 GUI를 통해 각 마이그레이션 규칙(P-01 ~ P-08)을 개별적으로 선택하거나 해제할 수 있어야 한다.
- **실시간 비교 (Diff View)**: 원본 코드와 선택된 규칙이 적용된 후의 코드를 나란히 비교하여 보여주는 기능을 제공해야 한다.
- **미리보기**: 실제 파일로 저장하기 전, 변환될 결과를 화면의 'Diff 뷰'에서 미리 확인할 수 있어야 한다.
- **파일 저장**: 사용자의 최종 확인 후, 변환된 코드를 지정된 `target` 경로에 원본과 동일한 하위 폴더 구조를 유지하며 저장해야 한다.
- **일괄 처리**: 사용자가 선택한 여러 파일에 대해 변환, 저장, 보고서 생성 작업을 일괄적으로 수행할 수 있어야 한다. (진행률 표시 및 취소 기능 포함)
- **보고서 생성**: 파일 저장 시, 적용된 규칙과 그 결과를 요약한 Markdown 보고서를 생성해야 한다.

### 2.2. 비기능 요구사항
- **플랫폼**: Windows 환경에서 실행 가능해야 한다.
- **의존성**: Python 표준 라이브러리 외에 외부 라이브러리 설치를 최소화한다. (PyInstaller는 배포용 파일 생성에만 사용)

---

## 3. 시스템 아키텍처

### 3.1. 모듈 구조
```
pb_migrator/
├── main.py             # 프로그램 시작점, GUI 애플리케이션 실행
├── gui.py              # Tkinter 기반의 메인 UI 창 및 위젯 정의, 이벤트 처리
├── engine.py           # 마이그레이션 규칙을 순차적으로 적용하는 핵심 변환 엔진
├── reporting.py        # 변환 결과 보고서(.md) 생성 모듈
└── rules/              # 개별 마이그레이션 규칙 구현 패키지
    ├── __init__.py
    ├── p01_encoding.py
    ├── p02_inheritance.py
    ├── p03_events.py
    ├── p04_std_events.py
    ├── p05_controls.py
    ├── p06_broken_korean.py
    ├── p07_gui_modernization.py
    └── p08_mdi_events.py
```

### 3.2. 컴포넌트 설명
- `main.py`: 프로그램의 진입점. `gui.py`의 메인 애플리케이션 클래스를 인스턴스화하고 실행한다.
- `gui.py`: UI의 모든 시각적 요소(창, 버튼, 텍스트 뷰 등)를 생성하고 배치한다. 사용자 입력(버튼 클릭, 파일 선택 등)을 받아 `engine.py`의 기능을 호출하고, 그 결과를 다시 UI에 반영한다.
- `engine.py`: `MigrationEngine` 클래스를 포함. 이 클래스는 소스 코드 문자열을 입력받아 `rules` 패키지의 함수들을 순차적으로 적용한 뒤, 변환된 코드 문자열과 변경 내역 로그를 반환한다.
- `rules/`: 각 `pXX_*.py` 파일은 단일 마이그레이션 규칙을 처리하는 함수를 포함한다.
- `reporting.py`: 변환 작업 완료 후, `engine`으로부터 변경 내역 로그를 받아 최종 보고서를 생성한다.

---

## 4. GUI 상세 설계

### 4.1. 화면 레이아웃
- **탭 기반 레이아웃**: UI를 '설정 및 실행'과 '소스 비교' 두 개의 탭으로 분리하여 작업 공간의 효율성을 극대화합니다.
- **프로그램 최대화**: 실행 시 자동으로 전체 화면으로 시작하여 사용자의 편의를 돕습니다.
- **메뉴바 및 상태바**: 상단에는 표준 메뉴바, 하단에는 현재 파일 정보를 표시하는 상태바가 위치합니다.

### 4.2. 위젯 및 컨트롤
- **파일 리스트**: `source` 폴더의 `.srw` 파일을 재귀적으로 탐색하여 표시합니다. `Ctrl+A`로 전체 선택, `Ctrl+Click` 및 `Shift+Click`으로 다중 선택이 가능합니다.
- **규칙 체크박스**: 각 규칙 코드(예: P-07)와 함께 상세 설명을 표시하여 가독성을 높였습니다.
- **실행 버튼**: `Preview Changes`, `Save to Target`, `Process Batch` 버튼을 제공합니다.
- **Diff 뷰**: 좌우 코드 비교 창의 스크롤이 동기화되며, 추가/수정/삭제된 라인이 각각 다른 배경색으로 하이라이트되어 변경점을 쉽게 식별할 수 있습니다. 상단에는 색상 범례가 표시됩니다.

---

## 5. 작업 흐름 (Workflow)

1.  사용자가 `main.py` 또는 `PBMigrator.exe`를 실행하면, 프로그램이 **최대화**된 상태로 시작됩니다.
2.  `source` 폴더를 스캔하여 '설정 및 실행' 탭의 파일 목록을 채웁니다.
3.  사용자가 파일 목록에서 특정 파일을 클릭하면, 원본 코드가 '소스 비교' 탭의 원본 창에 로드됩니다.
4.  사용자가 적용할 규칙을 선택하고 `[Preview Changes]` 버튼을 클릭합니다.
5.  프로그램은 변환을 수행한 후, **자동으로 '소스 비교' 탭으로 전환**하여 변경 전후 코드를 나란히 보여줍니다.
6.  사용자는 **스크롤 동기화 및 하이라이팅** 기능을 통해 변경 사항을 검토합니다.
7.  단일 파일 저장은 `[Save to Target]`을, 다중 파일 일괄 변환은 `[Process Batch]` 버튼을 클릭하여 수행합니다.
8.  모든 과정의 상태와 결과는 'Log' 창에 기록됩니다.

---

## 6. 핵심 변환 규칙
- **P-01 (파일 형식)**: 최종 저장 시점에 파일 인코딩을 `UTF-16 LE`로, 줄바꿈을 `CRLF`로 변환한다.
- **P-02 (상속 컨트롤 재정의)**: `visible = false` 속성을 찾아 `x`, `y` 좌표 변경으로 수정한다.
- **P-03 (이벤트 프로토타입)**: 소스코드에서 사용자 이벤트를 파싱하여 `forward prototypes` 블록에 누락된 선언을 추가한다.
- **P-04 (표준 이벤트 추가)**: `resize`, `activate` 이벤트 스크립트 블록을 소스코드에 삽입한다.
- **P-05 (장식용 컨트롤 삭제)**: 대상 컨트롤(`rr_*`, `ln_*`, `gb_*`)과 관련된 모든 코드를 삭제한다.
- **P-06 (깨진 한글 수정)**: `gui.py`의 파일 로딩 단계에서 원본 파일을 `cp949` 인코딩으로 읽어들여 처리한다.
- **P-07 (UI/UX 현대화)**: `r_head`, `r_detail` 컨트롤을 추가하고 기존 컨트롤들을 재배치하여 UI 구조를 개편한다.
- **P-08 (MDI 이벤트 연동)**: MDI 공통 툴바와 연동하기 위한 표준 사용자 이벤트(ue_*)를 추가하고 기존 버튼의 `Clicked!` 이벤트를 호출하도록 연결한다.