# 프로그램 명세서: PBMigrator

## 1. 개요

### 1.1. 프로그램 목적
본 프로그램(`PBMigrator`)은 HANTEC ERP 시스템의 PowerBuilder 10 소스 코드(.srw)를 PowerBuilder 10.5 버전과 호환되도록 자동으로 변환하는 것을 목적으로 한다. 사용자가 시각적으로 변환 과정을 확인하고 제어할 수 있는 GUI 환경을 제공하여 작업의 정확성과 안정성을 높인다.

### 1.2. 범위
- **입력**: `source` 폴더 하위의 모든 PowerBuilder 10 `.srw` 파일. (`_`로 시작하는 폴더는 제외)
- **처리**: `gemini.md` 핸드북에 정의된 단일 마이그레이션 규칙 **P-01** 적용.
- **출력**: 변환된 PowerBuilder 10.5 호환 `.srw` 파일. (모든 처리 내역은 GUI의 로그 창에 기록됨)

---

## 2. 요구사항

### 2.1. 기능 요구사항
- **파일 로딩**: `source` 폴더 하위의 모든 `.srw` 파일을 재귀적으로 찾아 GUI의 파일 목록에 표시해야 한다. (`_`로 시작하는 폴더는 제외)
- **실시간 비교 (Diff View)**: 원본 코드와 변환 후의 코드를 나란히 비교하여 보여주는 기능을 제공해야 한다.
- **자동 변환 및 저장**: 
    - 단일 파일 선택 후 '소스 비교' 탭으로 전환 시, 해당 파일이 자동으로 변환 및 저장되고 결과가 즉시 표시되어야 한다.
    - 여러 파일 선택 후 '변환 실행' 버튼 클릭 시, 모든 파일이 자동으로 변환 및 저장되어야 한다.
- **일괄 처리**: 사용자가 선택한 여러 파일에 대해 변환 및 저장 작업을 일괄적으로 수행할 수 있어야 한다. (진행률 표시 및 취소 기능 포함)
- **로그 기록**: 모든 변환 과정과 규칙 적용 내역, 오류 등을 GUI의 로그 창에 상세히 기록해야 한다.
- **일괄 처리 로그 저장**: 일괄 처리 작업이 완료되거나 중단될 경우, GUI 로그 창의 전체 내용이 `logs` 폴더 아래에 타임스탬프 형식의 `.log` 파일로 자동 저장되어야 한다.

### 2.2. 비기능 요구사항
- **플랫폼**: Windows 환경에서 실행 가능해야 한다.
- **의존성**: Python 표준 라이브러리 외에 외부 라이브러리 설치를 최소화한다. (PyInstaller는 배포용 파일 생성에만 사용)

---

## 3. 시스템 아키텍처

### 3.1. 모듈 구조
```
pb_migrator/
├── main.py             # 프로그램 시작점, GUI 애플리케이션 실행
├── gui.py              # Tkinter 기반의 메인 UI 창 및 위젯 정의, 이벤트 처리
├── engine.py           # 마이그레이션 규칙을 적용하는 핵심 변환 엔진
└── spec.py             # PowerBuilder 소스 코드의 구조를 분석하는 헬퍼 함수 제공
```

### 3.2. 컴포넌트 설명
- `main.py`: 프로그램의 진입점. `gui.py`의 메인 애플리케이션 클래스를 인스턴스화하고 실행한다.
- `gui.py`: UI의 모든 시각적 요소(창, 버튼, 텍스트 뷰 등)를 생성하고 배치한다. 사용자 입력(버튼 클릭, 파일 선택, 탭 전환 등)을 받아 `engine.py`의 기능을 호출하고, 그 결과를 다시 UI에 반영한다.
- `engine.py`: `MigrationEngine` 클래스를 포함. 이 클래스는 소스 코드 문자열을 입력받아, P-01 규칙에 따라 문자열을 직접 수정하여 결과를 반환하는 절차적 로직을 수행한다.
- `spec.py`: `parse_pb_source`와 같은 헬퍼 함수를 포함. 소스 코드 문자열에서 윈도우 이름, 부모 이름, 컨트롤 이름 목록 등 마이그레이션에 필요한 최소한의 정보를 추출하는 역할을 한다.

---

## 4. GUI 상세 설계

### 4.1. 화면 레이아웃
- **탭 기반 레이아웃**: UI를 '설정 및 실행'과 '소스 비교' 두 개의 탭으로 분리하여 작업 공간의 효율성을 극대화합니다.
- **프로그램 최대화**: 실행 시 자동으로 전체 화면으로 시작하여 사용자의 편의를 돕습니다.
- **메뉴바 및 상태바**: 상단에는 표준 메뉴바, 하단에는 현재 파일 정보를 표시하는 상태바가 위치합니다.

### 4.2. 위젯 및 컨트롤
- **파일 리스트**: `source` 폴더의 `.srw` 파일을 재귀적으로 탐색하여 표시합니다. `Ctrl+A`로 전체 선택, `Ctrl+Click` 및 `Shift+Click`으로 다중 선택이 가능합니다.
- **실행 버튼**: 여러 파일을 선택하고 일괄 변환을 시작하기 위한 **[변환 실행]** 버튼 하나만 제공하여 UI를 단순화했습니다.
- **Diff 뷰**: 좌우 코드 비교 창의 스크롤이 동기화되며, 추가/수정/삭제된 라인이 각각 다른 배경색으로 하이라이트되어 변경점을 쉽게 식별할 수 있습니다. 상단에는 색상 범례가 표시됩니다.

---

## 5. 작업 흐름 (Workflow)

1.  사용자가 `main.py` 또는 `PBMigrator.exe`를 실행하면, 프로그램이 **최대화**된 상태로 시작됩니다.
2.  `source` 폴더를 스캔하여 '설정 및 실행' 탭의 파일 목록을 채웁니다. (`_`로 시작하는 폴더는 제외)
3.  사용자는 변환할 파일을 목록에서 한 개 또는 여러 개 선택합니다.
4.  **(단일 파일 처리)**: 파일 하나를 선택한 상태에서 **'소스 비교' 탭을 클릭**하면, 해당 파일이 즉시 변환 및 저장되고 결과가 Diff 뷰에 표시됩니다.
5.  ** (다중 파일 처리)**: 여러 파일을 선택한 상태에서 **[변환 실행] 버튼을 클릭**하면, 진행률 창과 함께 모든 파일이 순차적으로 변환 및 저장됩니다.
6.  모든 과정의 상태와 결과는 'Log' 창에 상세히 기록됩니다. 작업이 완료되거나 중단되면, 이 로그의 전체 내용이 `logs` 폴더 하위에 `.log` 파일로 자동 저장됩니다.

---

## 6. 핵심 변환 규칙

-   **P-01: 부모-자식 윈도우 동기화 (CRITICAL)**
    -   **(목적)**: PowerBuilder 10.5 환경에서 새로운 부모 윈도우의 정의에 맞춰, 자식 윈도우에 불필요하게 남은 컨트롤과 이벤트를 자동으로 **주석 처리**하여 컴파일 오류를 방지하고, 수동 검토 및 복구를 용이하게 합니다.
    -   **(처리 방안)**:
        1.  자식 윈도우 소스에서 상속 관계(`global type ... from ...`)를 파악합니다.
        2.  `target/_reference` 폴더에서 최신 부모 윈도우의 소스를 읽어와 컨트롤 이름 목록을 추출합니다.
        3.  자식 윈도우의 컨트롤 이름 목록과 부모 윈도우의 컨트롤 이름 목록을 비교하여, 부모에 더 이상 존재하지 않는 '오래된 컨트롤(obsolete control)'을 식별합니다.
        4.  오래된 컨트롤이 하나라도 발견되면, 변환될 파일의 **3번째 줄**에 아래와 같은 설명 주석을 **한 번만** 추가합니다.
            -   `//& PBMigrator에 의해 주석 처리된 더 이상 사용되지 않는 컨트롤 및 이벤트 (YYYY-MM-DD).`
        5.  자식 윈도우 소스 코드에서, 식별된 각 '오래된 컨트롤'의 정의 블록(`type...end type`)과 모든 관련 이벤트 블록(`event...end event`)을 찾아, 해당 블록의 **모든 라인 앞에 `//& `를 붙여** 주석 처리합니다.
    -   **(상태)**: `engine.py`의 `apply_rules` 메서드에 절차적, 라인 기반 로직으로 구현 완료. `spec.py`는 컨트롤 이름 목록을 추출하는 헬퍼 함수를 제공합니다.
    -   **(파일 포맷)**: 최종 저장되는 파일은 **U-DOS (UTF-16 LE with BOM)** 형식과 **CRLF** 줄바꿈을 사용해야 합니다.