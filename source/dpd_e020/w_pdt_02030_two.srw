$PBExportHeader$w_pdt_02030_two.srw
$PBExportComments$작업지시등록 [품목- 처방/장치 ]
forward
global type w_pdt_02030_two from w_inherite
end type
type gb_2 from groupbox within w_pdt_02030_two
end type
type gb_1 from groupbox within w_pdt_02030_two
end type
type cb_suju from commandbutton within w_pdt_02030_two
end type
type gb_3 from groupbox within w_pdt_02030_two
end type
type tab_1 from tab within w_pdt_02030_two
end type
type tabpage_1 from userobject within tab_1
end type
type rr_3 from roundrectangle within tabpage_1
end type
type cbx_2 from checkbox within tabpage_1
end type
type rr_2 from roundrectangle within tabpage_1
end type
type p_tabpage1_cancel from uo_picture within tabpage_1
end type
type p_tabpage1_commit from uo_picture within tabpage_1
end type
type p_tabpage1_print from uo_picture within tabpage_1
end type
type p_1 from uo_picture within tabpage_1
end type
type dw_date from datawindow within tabpage_1
end type
type dw_plnlist from u_d_select_sort within tabpage_1
end type
type dw_layout1 from datawindow within tabpage_1
end type
type cbx_1 from checkbox within tabpage_1
end type
type tabpage_1 from userobject within tab_1
rr_3 rr_3
cbx_2 cbx_2
rr_2 rr_2
p_tabpage1_cancel p_tabpage1_cancel
p_tabpage1_commit p_tabpage1_commit
p_tabpage1_print p_tabpage1_print
p_1 p_1
dw_date dw_date
dw_plnlist dw_plnlist
dw_layout1 dw_layout1
cbx_1 cbx_1
end type
type tabpage_2 from userobject within tab_1
end type
type rr_4 from roundrectangle within tabpage_2
end type
type p_4 from uo_picture within tabpage_2
end type
type p_3 from uo_picture within tabpage_2
end type
type p_2 from uo_picture within tabpage_2
end type
type p_tabpage2_insert from uo_picture within tabpage_2
end type
type p_12 from uo_picture within tabpage_2
end type
type p_auto from uo_picture within tabpage_2
end type
type p_last from uo_picture within tabpage_2
end type
type dw_tabpage2 from datawindow within tabpage_2
end type
type st_pordno from statictext within tabpage_2
end type
type rr_9 from roundrectangle within tabpage_2
end type
type tabpage_2 from userobject within tab_1
rr_4 rr_4
p_4 p_4
p_3 p_3
p_2 p_2
p_tabpage2_insert p_tabpage2_insert
p_12 p_12
p_auto p_auto
p_last p_last
dw_tabpage2 dw_tabpage2
st_pordno st_pordno
rr_9 rr_9
end type
type tabpage_3 from userobject within tab_1
end type
type rr_6 from roundrectangle within tabpage_3
end type
type rr_5 from roundrectangle within tabpage_3
end type
type p_8 from uo_picture within tabpage_3
end type
type p_7 from uo_picture within tabpage_3
end type
type p_9 from uo_picture within tabpage_3
end type
type p_11 from uo_picture within tabpage_3
end type
type p_10 from uo_picture within tabpage_3
end type
type dw_tabpage3_1 from datawindow within tabpage_3
end type
type dw_tabpage3_2 from datawindow within tabpage_3
end type
type tabpage_3 from userobject within tab_1
rr_6 rr_6
rr_5 rr_5
p_8 p_8
p_7 p_7
p_9 p_9
p_11 p_11
p_10 p_10
dw_tabpage3_1 dw_tabpage3_1
dw_tabpage3_2 dw_tabpage3_2
end type
type tabpage_4 from userobject within tab_1
end type
type rr_8 from roundrectangle within tabpage_4
end type
type p_6 from uo_picture within tabpage_4
end type
type p_5 from uo_picture within tabpage_4
end type
type dw_jego from datawindow within tabpage_4
end type
type dw_head from datawindow within tabpage_4
end type
type tabpage_4 from userobject within tab_1
rr_8 rr_8
p_6 p_6
p_5 p_5
dw_jego dw_jego
dw_head dw_head
end type
type tabpage_5 from userobject within tab_1
end type
type rr_11 from roundrectangle within tabpage_5
end type
type rr_10 from roundrectangle within tabpage_5
end type
type gb_4 from groupbox within tabpage_5
end type
type dw_buha1 from datawindow within tabpage_5
end type
type gb_12 from groupbox within tabpage_5
end type
type tv_1 from treeview within tabpage_5
end type
type dw_buha2 from datawindow within tabpage_5
end type
type pb_graph from picturebutton within tabpage_5
end type
type pb_space from picturebutton within tabpage_5
end type
type p_print1 from picture within tabpage_5
end type
type p_retrieve1 from picture within tabpage_5
end type
type rb_1 from radiobutton within tabpage_5
end type
type rb_data from radiobutton within tabpage_5
end type
type rb_graph from radiobutton within tabpage_5
end type
type dw_buha3 from datawindow within tabpage_5
end type
type tabpage_5 from userobject within tab_1
rr_11 rr_11
rr_10 rr_10
gb_4 gb_4
dw_buha1 dw_buha1
gb_12 gb_12
tv_1 tv_1
dw_buha2 dw_buha2
pb_graph pb_graph
pb_space pb_space
p_print1 p_print1
p_retrieve1 p_retrieve1
rb_1 rb_1
rb_data rb_data
rb_graph rb_graph
dw_buha3 dw_buha3
end type
type tab_1 from tab within w_pdt_02030_two
tabpage_1 tabpage_1
tabpage_2 tabpage_2
tabpage_3 tabpage_3
tabpage_4 tabpage_4
tabpage_5 tabpage_5
end type
type dw_ban from datawindow within w_pdt_02030_two
end type
type dw_jaje from datawindow within w_pdt_02030_two
end type
type st_2 from statictext within w_pdt_02030_two
end type
type sle_bal from singlelineedit within w_pdt_02030_two
end type
type st_3 from statictext within w_pdt_02030_two
end type
type dw_saupj from datawindow within w_pdt_02030_two
end type
type rr_1 from roundrectangle within w_pdt_02030_two
end type
end forward

global type w_pdt_02030_two from w_inherite
integer width = 4626
integer height = 2504
string title = "작업 지시 등록 [품목- 처방/장치 ] "
gb_2 gb_2
gb_1 gb_1
cb_suju cb_suju
gb_3 gb_3
tab_1 tab_1
dw_ban dw_ban
dw_jaje dw_jaje
st_2 st_2
sle_bal sle_bal
st_3 st_3
dw_saupj dw_saupj
rr_1 rr_1
end type
global w_pdt_02030_two w_pdt_02030_two

type variables
string ispordno  // 작업지시번호
string isholdno  // 할당번호
integer iChoice // 부하현황-율,공수기준
string is_chk    //datawindow 변경여부
String  ls_auto //자동채번여부
String  isgyymm
integer iimoseq
datastore d_pdt_02030_strerr
boolean bomcheck
integer i_level // treeview
string trscode, trsname // 부하현황 조회용
integer ii_factor = 100 // 프린터 줌
boolean   iv_b_down = false, ib_rcal = false
String  is_sysno // 작업지시 기준번호 
String is_gwgbn
String is_seemonth //월 계획 수량 잔량 같이 보기 Flag
end variables

forward prototypes
public subroutine wf_treeview_item ()
public function integer wf_requiredchk_bomrtn (string sitnbr, ref string srtnbr)
public function integer wf_requiredchk_tabpage4 (ref long lrow, ref string scolumn)
public function integer wf_update ()
public function integer wf_requiredchk_tabpage2_final (ref string scolumn, ref long lrow)
public function integer wf_requiredchk_bomrtn2 (long currlow, string sitnbr, ref string srtnbr, string spordno)
public subroutine wf_tabpage1_layout (long lrow)
public function integer wf_requiredchk_tabpage2 (ref string scolumn, ref long lrow)
public function integer wf_requiredchk_tabpage31 (ref long lrow, ref string scolumn)
public function integer wf_reset ()
public function integer wf_treeview_retrieve ()
public function integer wf_treeview_retrieve2 ()
public function integer wf_treeview_retrieve1 ()
public function integer wf_requiredchk_tabpage1 ()
public function integer wf_cnt (long lrow, string sitnbr)
public function string wf_depotno (string oversea_gu, string sjumaechul)
public subroutine wf_item_check (long arg_row, string arg_itnbr, string arg_pspec, string arg_opseq)
end prototypes

public subroutine wf_treeview_item ();/* Treeview내역을 생성 */
Datastore ds_user
Treeviewitem tvi
String sToday
Long 		l_row, L_gbn, H_item, L_parent, L_gbn_b
Long 		L_level[20]
Integer	I_cnt
String 	L_userid
Boolean  B_child

/* 전체내역을 삭제 */
long tvi_hdl = 0

DO UNTIL tab_1.tabpage_5.tv_1.FindItem(RootTreeItem!, 0) = -1	
	      tab_1.tabpage_5.tv_1.DeleteItem(tvi_hdl)
LOOP

/* USER-ID 내역을 Retrieve */
ds_user = Create datastore
ds_user.dataobject = "d_pdt_02605_0"
ds_user.settransobject(sqlca)
If ds_user.retrieve() < 1 Then Return

/* 첫번째 레벨을 등록하고 ........................... */
tvi.Data = 'TOP'
tvi.Label= '부하전체'    
tvi.PictureIndex = 1
tvi.SelectedPictureIndex = 1
tvi.Children = True
h_item = tab_1.tabpage_5.tv_1.InsertItemLast(0, tvi)

I_cnt = 1
L_level[I_cnt] = H_item
L_parent		   = H_item

For L_row=1 to ds_user.rowcount()
	 L_gbn    = Dec(ds_user.object.gubun[L_row])
	 
	 B_child  = False
	 
	 If L_row < ds_user.rowcount() Then
		 If L_gbn < Dec(ds_user.object.gubun[L_row + 1]) Then
		    B_child = True	
		 End if
	 End if

	 /* Root Level */
	 If 	  L_gbn = 1 Then
		 	  L_parent = 1
			  I_cnt    = 1
	 ElseIf L_gbn > L_gbn_b Then
			  I_cnt++		
			  L_level[I_cnt] = H_item
			  L_parent		  = H_item
    Elseif L_gbn < L_gbn_b Then
			  I_cnt = L_gbn
			  L_parent		  = L_level[i_cnt]
  	 Else
			  L_parent		  = L_level[i_cnt]
	 End if

    L_gbn_b   = L_gbn
	 tvi.label = ds_user.object.pdtname[l_row]
	 tvi.data  = ds_user.object.pdtcod[l_row]
	  
	 tvi.children = False
	 If b_child  Then
		 tvi.pictureindex = 2
		 tvi.Selectedpictureindex = 3
	 Else
		 tvi.pictureindex = 0
		 tvi.Selectedpictureindex = 0
	 End if
	 tvi.level  = L_gbn
/*	 H_item = tab_1.tabpage_5.tv_1.insertitemsort(L_parent, tvi)			// Root의 내용을 Sort를 하면서 하고자 하는 경우 */
	 H_item = tab_1.tabpage_5.tv_1.insertitemlast(L_parent, tvi)			// Root의 내용을 Sort를 하지않는 경우 

	 
Next

Destroy ds_user

return 
end subroutine

public function integer wf_requiredchk_bomrtn (string sitnbr, ref string srtnbr);String	sDitnbr, sReff, sReff1, stimegu
Long Lrow

Lrow = d_pdt_02030_strerr.insertrow(0)

/* BOM이 있는 지 확인
	1. 지시품번에 하위부품이 있는지
	2. 표준품번에 하위부품이 있는지	*/
Long lcnt, Lcnt1, lcnt2
Lcnt = 0
Select count(*) Into :lcnt from pstruc
 Where pinbr = :sitnbr;
 
if Isnull(Lcnt) or Lcnt < 1 then
	Select stdnbr Into :sDitnbr From itemas
	 Where itnbr = :sItnbr;

	/* 대표품번에 대한 BOM 검색 */
	Lcnt = 0
	Select count(*) Into :lcnt from pstruc
	 Where pinbr = :sDitnbr;
	 
	if Isnull(Lcnt) or Lcnt < 1 then		 
		d_pdt_02030_strerr.setitem(Lrow, "err5", 2)
	   dw_insert.setitem(Lrow, "momast_copy_holdct", 'N')		
		bomcheck = true
	End if
	sRtnbr = sDitnbr
Else
	sRtnbr = sitnbr
end if

if isnull(sRtnbr) or trim(sRtnbr) = '' then sRtnbr = sitnbr

d_pdt_02030_strerr.setitem(Lrow, "itnbr", sitnbr)
d_pdt_02030_strerr.setitem(Lrow, "stdnbr", srtnbr)		 

/* 표준공정순서에 동시공정이 1개 이상인 경우 check */
lcnt = 0
Select count(*)
  into :lcnt
  from 
		(select itnbr, opseq, twocod
			from routng 
		  where itnbr = :sRtnbr
			 and twocod is not null) a,
		routng b
 where a.itnbr  = b.itnbr
	and a.twocod = b.opseq
	and b.twocod is not null;

if lcnt > 0 then
	d_pdt_02030_strerr.setitem(Lrow, "err1", 2)
	dw_insert.setitem(Lrow, "momast_copy_routct", 'N')
	dw_insert.setitem(Lrow, "momast_copy_timect", 'N')
	bomcheck = true	
end if

/* 시간은 환경설정의 표준시간, 평균시간으로 한다 
   1: 표준시간, 2:평균시간 */
select dataname
  into :stimegu
  from syscnfg
 where sysgu = 'Y' and serial = '15' and lineno = '3';
 
if stimegu <>  '1' and stimegu <> '2' then
	sTimegu = '1'
end if

/* 표준공정에 시간이 없는지 check, 최초/최종공정이 1개이상인지 check 
   표준시간 check시 작업장마스터를 기준으로 
	시간구분 1 : Man H/R필수
	         2 : M/C H/R필수 
				3 또는 4 : Man + M/C 필수 */
Dec {2} dTotime

Lcnt 	= 0
Lcnt1 = 0	
Lcnt2 = 0	
Select Sum(Decode(:stimegu, '1', Decode(b.basic, '1', manhr,  '2', mchr,  '3', manhr  + mchr, 9), 0) +
		     Decode(:stimegu, '2', Decode(b.basic, '1', manhr1, '2', mchr1, '3', manhr1 + mchr1, 9), 0)),
		 Sum(decode(lastc, '1', 1, '9', 1, 0)),
		 Sum(decode(Lastc, '3', 1, '9', 1, 0)), count(*)
  into :dTotime, :lcnt, :Lcnt1, :Lcnt2
  from routng a, wrkctr b
 where a.itnbr = :sRtnbr
 	and a.wkctr = b.wkctr;

if dTotime = 0 or sqlca.sqlcode <> 0 then
	d_pdt_02030_strerr.setitem(Lrow, "err2", 2)
	dw_insert.setitem(Lrow, "momast_copy_routct", 'N')
	dw_insert.setitem(Lrow, "momast_copy_timect", 'N')
	bomcheck = true	
end if

if Lcnt > 1 then
	d_pdt_02030_strerr.setitem(Lrow, "err2", 3)
	dw_insert.setitem(Lrow, "momast_copy_routct", 'N')
	dw_insert.setitem(Lrow, "momast_copy_timect", 'N')
	bomcheck = true		
end if	

if Lcnt1 > 1 then
	d_pdt_02030_strerr.setitem(Lrow, "err2", 4)
	dw_insert.setitem(Lrow, "momast_copy_routct", 'N')
	dw_insert.setitem(Lrow, "momast_copy_timect", 'N')
	bomcheck = true		
end if

if Lcnt2 = 0 then
	d_pdt_02030_strerr.setitem(Lrow, "err2", 5)
	dw_insert.setitem(Lrow, "momast_copy_routct", 'N')
	dw_insert.setitem(Lrow, "momast_copy_timect", 'N')	
	bomcheck = true		
end if

/* 최초공정이 동시공정인지 check하고 공정순서가 맞는지 check */
Setnull(sReff)
Setnull(sReff1)
select lastc, twocod into :sreff, :sreff1 From routng
 Where itnbr = :sRtnbr 
	And opseq = (select Min(opseq) from routng where itnbr = :sRtnbr);
 
If sReff = '1' or sReff = '9' then
else
	d_pdt_02030_strerr.setitem(Lrow, "err3", 2)
	dw_insert.setitem(Lrow, "momast_copy_routct", 'N')
	dw_insert.setitem(Lrow, "momast_copy_timect", 'N')
	bomcheck = true		
end if

If isnull(sReff1) or trim(sReff1)  = '' then
Else
	d_pdt_02030_strerr.setitem(Lrow, "err3", 3)
	dw_insert.setitem(Lrow, "momast_copy_routct", 'N')
	dw_insert.setitem(Lrow, "momast_copy_timect", 'N')
	bomcheck = true		
end if

select lastc, twocod into :sreff, :sreff1 From routng
 Where itnbr = :sRtnbr 
	And opseq = (select Max(opseq) from routng where itnbr = :sRtnbr);

If sReff = '3' or sReff = '9' then
else
	d_pdt_02030_strerr.setitem(Lrow, "err4", 2)
	dw_insert.setitem(Lrow, "momast_copy_routct", 'N')
	dw_insert.setitem(Lrow, "momast_copy_timect", 'N')
	bomcheck = true		
end if

If isnull(sReff1) or trim(sReff1)  = '' then
Else
	d_pdt_02030_strerr.setitem(Lrow, "err4", 3)
	dw_insert.setitem(Lrow, "momast_copy_routct", 'N')
	dw_insert.setitem(Lrow, "momast_copy_timect", 'N')
	bomcheck = true		
end if

return 0
end function

public function integer wf_requiredchk_tabpage4 (ref long lrow, ref string scolumn);/* 자재 할당 내역 검색 */

string   snull, sitnbr, sreff, sreff1, sitdsc, sispec, scvcod, sopseq, spordno, stoday
integer  ireturn
Decimal  {5} dunprc
long lcnt, lfind

w_mdi_frame.sle_msg.text = "자재할당내역을 검색중입니다......!!"

sToday = f_today()

tab_1.tabpage_4.dw_jego.accepttext()

setnull(snull)

For 	lcnt = 1 to tab_1.tabpage_4.dw_jego.rowcount()
		lrow = lcnt
		
		/* 공정순서 check */
		If 	isnull(tab_1.tabpage_4.dw_jego.getitemstring(Lcnt, "opseq")) or &
				Trim(tab_1.tabpage_4.dw_jego.getitemstring(Lcnt, "opseq")) = '' then
				f_message_chk(30, '[공정순서]')
				sColumn = "opseq"
				return -1
		end if
		
		/* 품번 check */
		If 	isnull(tab_1.tabpage_4.dw_jego.getitemstring(Lcnt, "itnbr")) or &
				Trim(tab_1.tabpage_4.dw_jego.getitemstring(Lcnt, "itnbr")) = '' then
				f_message_chk(30, '[품목번호]')
				sColumn = "itnbr"
				return -1
		end if
		
		/* 사양 check */
		If 	isnull(tab_1.tabpage_4.dw_jego.getitemstring(Lcnt, "pspec")) or &
				Trim(tab_1.tabpage_4.dw_jego.getitemstring(Lcnt, "pspec")) = '' then
				tab_1.tabpage_4.dw_jego.setitem(Lcnt, 'pspec', '.')
		end if		
		
		/* 할당수량 check */
		If 	tab_1.tabpage_4.dw_jego.getitemdecimal(Lcnt, "hold_qty") = 0 then
				f_message_chk(30, '[할당수량]')
				sColumn = "hold_qty"
				return -1
		end if		
		
		/* 출고창고 check */
		If 	isnull(tab_1.tabpage_4.dw_jego.getitemstring(Lcnt, "out_store")) or &
				Trim(tab_1.tabpage_4.dw_jego.getitemstring(Lcnt, "out_store")) = '' then
				f_message_chk(30, '[출고창고]')
				sColumn = "out_store"
				return -1
		end if
		
		/* 출고요총창고 check */
		If 	isnull(tab_1.tabpage_4.dw_jego.getitemstring(Lcnt, "hold_store")) or &
				Trim(tab_1.tabpage_4.dw_jego.getitemstring(Lcnt, "hold_store")) = '' then
				f_message_chk(30, '[출고요청창고]')
				sColumn = "out_store"
				return -1
		end if
				
	
Next

if tab_1.tabpage_4.dw_jego.update() = 1 then
	commit;
Else
	Lrow = 1
	sColumn = 'opseq'
	Rollback;
	return -1
end if

return 1
end function

public function integer wf_update ();string  sdptno, sitnbr, stoday, spaordno, spaopseq
Decimal {3} djiqty
Long    Lrow

integer ii

w_mdi_frame.sle_msg.text = ''
stoday = f_today()

/* 분할인 경우에는 분할되는 작업지시에 수량을 저장 */
For Lrow = 1 to tab_1.tabpage_2.dw_tabpage2.rowcount()
	if not isnull(tab_1.tabpage_2.dw_tabpage2.getitemstring(1, "momast_copy_pa_pordno")) then
		 spaordno = tab_1.tabpage_2.dw_tabpage2.getitemstring(1, "momast_copy_pa_pordno")
		 spaopseq = tab_1.tabpage_2.dw_tabpage2.getitemstring(1, "momast_copy_pa_ospeq")
		 djiqty   = tab_1.tabpage_2.dw_tabpage2.getitemdecimal(1, "momast_copy_pdqty")
	
		 Update momast
			 set paqty = paqty + :djiqty
		  where sabu  = :gs_sabu and pordno = :spaordno;
		  
		 if sqlca.sqlcode <> 0 then
			 f_message_chk(32, "분할 작업지시-Head")
			 return -1
		end if
	  
		 Update morout
			 set paqty = paqty + :djiqty
		  where sabu  = :gs_sabu and pordno = :spaordno and opseq = :spaopseq;
		  
		 if sqlca.sqlcode <> 0 then
			 f_message_chk(32, "분할 작업지시-Detail")
			 return -1
		end if		  
	
	End if
Next

return 1
end function

public function integer wf_requiredchk_tabpage2_final (ref string scolumn, ref long lrow);string   snull, sitnbr, sreff, sreff1, sitdsc, sispec, scvcod, sopseq, sDitnbr, sRtnbr, sopdsc, spordno
integer  ireturn
Decimal  {5} dunprc
Decimal  {3} dgaqty

w_mdi_frame.sle_msg.text = '자료를 검사중입니다.....!!'

setnull(snull)

For lrow = 1 to tab_1.tabpage_2.dw_tabpage2.rowcount()
	
	/* 작업지시구분 check */
	if isnull(f_get_reffer('60', tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_porgu"))) then
		f_message_chk(79,'[작업지시구분]') 
		tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_porgu", '')
		scolumn = "momast_copy_porgu"
		RETURN  -1
	END IF
	
	spordno = trim(tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_pordno"))	
	sItnbr  = trim(tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_itnbr"))
	if isnull(sitnbr) or trim(sitnbr) = '' then	
		sitnbr ='X1'
	end if	
	ireturn = f_get_name2('품번', 'Y', sitnbr, sitdsc, sispec)    //1이면 실패, 0이 성공	
	if ireturn = 1 then
		scolumn = "momast_copy_itnbr"
		RETURN -1
	end if
	
	if dec(tab_1.tabpage_2.dw_tabpage2.getitemdecimal(Lrow, "momast_copy_pdqty")) < 1 then
		scolumn = "momast_copy_pdqty"
		f_message_chk(78,'[지시수량]') 
		RETURN -1	
	end if
	
	sreff = tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_pspec")
	if isnull(sreff) or trim(sreff) = '' then	
		tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_pspec", '.')
	end if
	
	sreff = tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_esdat")
	if (isnull(sreff) or trim(sreff) = '') and &
		tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_purgc") = 'N' then
	elseif f_datechk(sreff) = -1 then
			 f_message_chk(35,'[생산시작일(외주인 경우 필수)]') 
			 tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_esdat", '')
			 scolumn = "momast_copy_esdat"
			 RETURN -1
	end if
	
	sreff1 = tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_eedat")	
	if (isnull(sreff1) or trim(sreff1) = '') and &
		tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_purgc") = 'N' then
	elseif f_datechk(sreff1) = -1 then
			 f_message_chk(35,'[생산종료일(외주인 경우 필수)]') 
			 tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_eedat", '')
			 scolumn = "momast_copy_eedat"			 
			 RETURN -1
	end if
	
	if isnull(sreff1) or trim(sreff1) = '' then
	elseif sreff > sreff1 then
			f_message_chk(35,'[생산종료일]') 
			tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_esdat", '')
			scolumn = "momast_copy_esdat"
			RETURN -1
	end if
	
	if isnull(tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_ipchango")) or &
		trim(tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_ipchango")) = '' then
			f_message_chk(36,'[입고예정창고]') 
			tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_ipchango", '')
			scolumn = "momast_copy_ipchango"
			RETURN -1
	end if	
	
	// 외주인 경우 check
	if tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_purgc") = 'Y' then
		if tab_1.tabpage_2.dw_tabpage2.getitemdecimal(Lrow, "momast_copy_unprc") < 1 then
			f_message_chk(80,'[외주단가]') 
			scolumn = "momast_copy_unprc"
			RETURN -2
		end if	
	end if
	
	if tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "pagbn") = 'Y' then
		sreff = tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_pa_pordno")
		Select itnbr, pspec, pdsts into :sitnbr, :sispec, :sreff1 from momast
		 where sabu = :gs_sabu and pordno = :sreff;
		  
		if sqlca.sqlcode <> 0 then
			f_message_chk(77,'[작업지시번호]')
			tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_pa_pordno", '')
			tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_pa_ospeq", '')
			scolumn = "momast_copy_pa_pordno"
			return -2
		end if
		if sreff1 <> '1' and sreff1 <> '2' then
			f_message_chk(84,'[작업지시상태]')
			tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_pa_pordno", '')
			tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_pa_ospeq", '')
			scolumn = "momast_copy_pa_pordno"
			return -2
		end if
		if tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_itnbr") <> sitnbr or &
			tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_pspec") <> sispec then
			f_message_chk(85,'[품목,사양]')
			tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_pa_pordno", '')
			tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_pa_ospeq", '')
			scolumn = "momast_copy_pa_pordno"
			return -2
		end if
		
		sitnbr = tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_itnbr")
		sopseq = tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_pa_ospeq")
		// 분할할 공정이 실제로 존재하는지 CHECK
		setnull(sopdsc)
		Select opdsc into :sopdsc from morout
		 Where sabu = :gs_sabu And pordno = :sreff And opseq = :sopseq;		
		if isnull(sopdsc) then 
			scolumn = "momast_copy_pa_ospeq"		
			return -2
		end if		
		
		// 가용수량 check = (당공정합격 + 불량) - (후공정 정상실적 + 당공정 수리실적수량) 
		 select nvl(a.mqty, 0) - (nvl(b.preqty, 0) + nvl(c.suqty, 0))
 		   into :dgaqty
			from (select (b.coqty + b.faqty) as mqty
					  from momast a, morout b
					 where a.sabu = :gs_sabu and a.pordno = :sreff
						and a.pdsts in ('1','2')
						and a.sabu  = b.sabu     and a.pordno = b.pordno
						and b.opseq = :sopseq)a,
				  (select sum(roqty) as preqty
					  from shpact 
					 where sabu   = :gs_sabu
						and pordno = :sreff
						and opsno  = (select de_opseq 	 from morout
											where sabu   = :gs_sabu 
											  and pordno = :sreff
											  and opseq  = :sopseq )
						and sigbn  = '1' )b, 
				  (select sum(roqty) as suqty
					  from shpact 
					 where sabu   = :gs_sabu
						and pordno = :sreff
						and opsno  = :sopseq
						and sigbn  = '2' )c;  
						
		if dgaqty < tab_1.tabpage_2.dw_tabpage2.getitemdecimal(Lrow, "momast_copy_pdqty") then
			f_message_chk(88,'[분할가용수량]')
			scolumn = "momast_copy_pa_ospeq"
			return -1
		end if
		
	end if

Next

return 1


end function

public function integer wf_requiredchk_bomrtn2 (long currlow, string sitnbr, ref string srtnbr, string spordno);// 일정 계산전 사용자 선택에 의한 Option Check

String	sDitnbr, sReff, sReff1, stimegu
Long Lrow, Lchk

tab_1.tabpage_2.dw_tabpage2.ACCEPTTEXT()
Lrow = d_pdt_02030_strerr.insertrow(0)

/* BOM이 있는 지 확인
	1. 지시품번에 하위부품이 있는지
	2. 표준품번에 하위부품이 있는지	*/
Long lcnt, Lcnt1, lcnt2
Lcnt = 0
Select count(*) Into :lcnt from pstruc
 Where pinbr = :sitnbr;
 
if Isnull(Lcnt) or Lcnt < 1 then
	Select stdnbr Into :sDitnbr From itemas
	 Where itnbr = :sItnbr;

	/* 대표품번에 대한 BOM 검색 */
	Lcnt = 0
	Select count(*) Into :lcnt from pstruc
	 Where pinbr = :sDitnbr;

	if tab_1.tabpage_2.dw_tabpage2.getitemstring(currlow, 'momast_copy_holdct') = 'Y' then
		if Isnull(Lcnt) or Lcnt < 1 then		 
			d_pdt_02030_strerr.setitem(Lrow, "err5", 2)
			dw_insert.setitem(Lrow, "momast_copy_holdct", 'N')		
			bomcheck = true
		End if
	End if
	sRtnbr = sDitnbr
Else
	sRtnbr = sitnbr
end if

if isnull(sRtnbr) or trim(sRtnbr) = '' then sRtnbr = sitnbr

d_pdt_02030_strerr.setitem(Lrow, "itnbr", sitnbr)
d_pdt_02030_strerr.setitem(Lrow, "stdnbr", srtnbr)		 

// 표준공정을 선택하지 않은 경우에는 아래의 내역을 선택하지 않는다.
// 단 외주인 경우에는 check하지 않는다.
/*if tab_1.tabpage_2.dw_tabpage2.getitemstring(currlow, 'momast_copy_routct') = 'Y' then
	if tab_1.tabpage_2.dw_tabpage2.getitemstring(currlow, 'momast_copy_purgc') = 'N' then
		Lchk = 0
		Select count(*) into :Lchk
		  From morout_copy_none_copy 
		 where sabu = :gs_sabu and pordno = :spordno;
		if lchk = 0 then
			messagebox("표준공정", "표준공정을 먼저 작성하십시요[None]", stopsign!)		
			return -1
		end if;
	end if
end if */


// 시간계산을 하지 않는 경우에는 시간을 직접입력한다.
if tab_1.tabpage_2.dw_tabpage2.getitemstring(currlow, 'momast_copy_timect') = 'N' then
	if tab_1.tabpage_2.dw_tabpage2.getitemstring(currlow, 'momast_copy_purgc') = 'N' then	
		Lchk = 0
		Select sum(decode(esdat, null, 0, 1)) + sum(decode(eedat, null, 0, 1)) into :Lchk
		  From morout_copy_none_copy 
		 where sabu = :gs_sabu and pordno = :spordno;
		if lchk = 0 then
			messagebox("표준공정", "일정을 먼저 작성하십시요", stopsign!)		
			return -1
		end if;
	end if
end if

// 표준공정을 선택하지 않은 경우에는 아래의 내역을 선택하지 않는다.
if tab_1.tabpage_2.dw_tabpage2.getitemstring(currlow, 'momast_copy_routct') = 'N' then
	return 1
end if

/* 표준공정순서에 동시공정이 1개 이상인 경우 check */
lcnt = 0
Select count(*)
  into :lcnt
  from 
		(select itnbr, opseq, twocod
			from routng 
		  where itnbr = :sRtnbr
			 and twocod is not null) a,
		routng b
 where a.itnbr  = b.itnbr
	and a.twocod = b.opseq
	and b.twocod is not null;

if lcnt > 0 then
	d_pdt_02030_strerr.setitem(Lrow, "err1", 2)
	dw_insert.setitem(Lrow, "momast_copy_routct", 'N')
	dw_insert.setitem(Lrow, "momast_copy_timect", 'N')
	bomcheck = true	
end if

/* 시간은 환경설정의 표준시간, 평균시간으로 한다 
   1: 표준시간, 2:평균시간 */
select dataname
  into :stimegu
  from syscnfg
 where sysgu = 'Y' and serial = '15' and lineno = '3';
 
if stimegu <>  '1' and stimegu <> '2' then
	sTimegu = '1'
end if

/* 표준공정에 시간이 없는지 check, 최초/최종공정이 1개이상인지 check 
   표준시간 check시 작업장마스터를 기준으로 
	시간구분 1 : Man H/R필수
	         2 : M/C H/R필수 
				3 또는 4 : Man + M/C 필수 */
Dec {2} dTotime

Lcnt 	= 0
Lcnt1 = 0	
Lcnt2 = 0	
Select Sum(Decode(:stimegu, '1', Decode(b.basic, '1', manhr,  '2', mchr,  '3', manhr  + mchr, 9), 0) +
		     Decode(:stimegu, '2', Decode(b.basic, '1', manhr1, '2', mchr1, '3', manhr1 + mchr1, 9), 0)),
		 Sum(decode(lastc, '1', 1, '9', 1, 0)),
		 Sum(decode(Lastc, '3', 1, '9', 1, 0)), count(*)
  into :dTotime, :lcnt, :Lcnt1, :Lcnt2
  from routng a, wrkctr b
 where a.itnbr = :sRtnbr
 	and a.wkctr = b.wkctr;

if dTotime = 0 or sqlca.sqlcode <> 0 then
	d_pdt_02030_strerr.setitem(Lrow, "err2", 2)
	dw_insert.setitem(Lrow, "momast_copy_routct", 'N')
	dw_insert.setitem(Lrow, "momast_copy_timect", 'N')
	bomcheck = true	
end if

if Lcnt > 1 then
	d_pdt_02030_strerr.setitem(Lrow, "err2", 3)
	dw_insert.setitem(Lrow, "momast_copy_routct", 'N')
	dw_insert.setitem(Lrow, "momast_copy_timect", 'N')
	bomcheck = true		
end if	

if Lcnt1 > 1 then
	d_pdt_02030_strerr.setitem(Lrow, "err2", 4)
	dw_insert.setitem(Lrow, "momast_copy_routct", 'N')
	dw_insert.setitem(Lrow, "momast_copy_timect", 'N')
	bomcheck = true		
end if

if Lcnt2 = 0 then
	d_pdt_02030_strerr.setitem(Lrow, "err2", 5)
	dw_insert.setitem(Lrow, "momast_copy_routct", 'N')
	dw_insert.setitem(Lrow, "momast_copy_timect", 'N')	
	bomcheck = true		
end if

/* 최초공정이 동시공정인지 check하고 공정순서가 맞는지 check */
Setnull(sReff)
Setnull(sReff1)
select lastc, twocod into :sreff, :sreff1 From routng
 Where itnbr = :sRtnbr 
	And opseq = (select Min(opseq) from routng where itnbr = :sRtnbr);
 
If sReff = '1' or sReff = '9' then
else
	d_pdt_02030_strerr.setitem(Lrow, "err3", 2)
	dw_insert.setitem(Lrow, "momast_copy_routct", 'N')
	dw_insert.setitem(Lrow, "momast_copy_timect", 'N')
	bomcheck = true		
end if

If isnull(sReff1) or trim(sReff1)  = '' then
Else
	d_pdt_02030_strerr.setitem(Lrow, "err3", 3)
	dw_insert.setitem(Lrow, "momast_copy_routct", 'N')
	dw_insert.setitem(Lrow, "momast_copy_timect", 'N')
	bomcheck = true		
end if

select lastc, twocod into :sreff, :sreff1 From routng
 Where itnbr = :sRtnbr 
	And opseq = (select Max(opseq) from routng where itnbr = :sRtnbr);

If sReff = '3' or sReff = '9' then
else
	d_pdt_02030_strerr.setitem(Lrow, "err4", 2)
	dw_insert.setitem(Lrow, "momast_copy_routct", 'N')
	dw_insert.setitem(Lrow, "momast_copy_timect", 'N')
	bomcheck = true		
end if

If isnull(sReff1) or trim(sReff1)  = '' then
Else
	d_pdt_02030_strerr.setitem(Lrow, "err4", 3)
	dw_insert.setitem(Lrow, "momast_copy_routct", 'N')
	dw_insert.setitem(Lrow, "momast_copy_timect", 'N')
	bomcheck = true		
end if

return 0
end function

public subroutine wf_tabpage1_layout (long lrow);string sitnbr

if Lrow > 0 then
	sitnbr 	= tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "itnbr")
	isgyymm 	= tab_1.tabpage_1.dw_date.getitemstring(1, "gidate")
	iimoseq  = 0
	Select Max(moseq)
	  Into :iimoseq
	  From Monpln_sum
	 Where Sabu = :gs_sabu And monyymm = :isgyymm;
	tab_1.tabpage_1.dw_layout1.retrieve(gs_sabu, sitnbr, isgyymm, iimoseq, is_seemonth)
end if
end subroutine

public function integer wf_requiredchk_tabpage2 (ref string scolumn, ref long lrow);string   snull, sitnbr, sreff, sreff1, sitdsc, sispec, scvcod, sopseq, sDitnbr, sRtnbr, &
			sPorgu, scvnas, spordno, sopdsc, sjijil, sispec_code, sittyp
integer  ireturn
Decimal  {3} dunprc, dgaqty

w_mdi_frame.sle_msg.text = '자료를 검사중입니다.....!!'

setnull(snull)

For lrow = 1 to tab_1.tabpage_2.dw_tabpage2.rowcount()
	
	/* 작업지시구분 check */
	if isnull(f_get_reffer('60', tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_porgu"))) then
		f_message_chk(79,'[작업지시구분]') 
		tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_porgu", '') 
		scolumn = "momast_copy_porgu"
		RETURN  -1
	END IF
	sPorgu  = tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_porgu")	
	sPordno = tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_pordno")		
	
	sItnbr = trim(tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_itnbr"))
	if isnull(sitnbr) or trim(sitnbr) = '' then	
		sitnbr ='X1'
	end if	
	ireturn = f_get_name4('품번', 'Y', sitnbr, sitdsc, sispec, sjijil, sispec_code) 
	tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_itnbr", sitnbr)	
	tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "itemas_itdsc", sitdsc)	
	tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "itemas_ispec", sispec)
	tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "itemas_jijil", sjijil)	
	tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "itemas_ispec_code", sispec_code)
	if ireturn = 1 then
		scolumn = "momast_copy_itnbr"
		RETURN -1
	end if
	
	if dec(tab_1.tabpage_2.dw_tabpage2.getitemdecimal(Lrow, "momast_copy_pdqty")) < 1 then
		scolumn = "momast_copy_pdqty"
		f_message_chk(78,'[지시수량]') 
		RETURN -1	
	end if

	select ittyp into :sittyp 
	  from itemas where itnbr = :sitnbr ;

	if isnull(sreff) or trim(sreff) = '' then	
		tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_pspec", '.')
	end if

	sreff = tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_esdat")
	if (isnull(sreff) or trim(sreff) = '') and &
		tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_purgc") = 'N' then
	elseif f_datechk(sreff) = -1 then
			 f_message_chk(35,'[생산시작일(외주인 경우 필수)]') 
			 tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_esdat", '')
			 scolumn = "momast_copy_esdat"
			 RETURN -1
	end if
	
	sreff1 = tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_eedat")	
	if (isnull(sreff1) or trim(sreff1) = '') and &
		tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_purgc") = 'N' then
	elseif f_datechk(sreff1) = -1 then
			 f_message_chk(35,'[생산종료일(외주인 경우 필수)]') 
			 tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_eedat", '')
			 scolumn = "momast_copy_eedat"			 
			 RETURN -1
	end if
	
	if isnull(sreff1) or trim(sreff1) = '' then
	elseif sreff > sreff1 then
			f_message_chk(35,'[생산종료일]') 
			tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_esdat", '')
			scolumn = "momast_copy_esdat"
			RETURN -1
	end if
	
	if isnull(tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_ipchango")) or &
		trim(tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_ipchango")) = '' then
			f_message_chk(36,'[입고예정창고]') 
			tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_ipchango", '')
			scolumn = "momast_copy_ipchango"
			RETURN -1
	end if	
	
	if tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_purgc") = 'Y' then
	
		scvcod = tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_cvcod")
		select cvnas into :scvnas from vndmst
		 where cvcod = :scvcod;
		 if sqlca.sqlcode <> 0 then
			 messagebox('외주거래처','외주거래처가 지정되지 않았읍니다.', stopsign!)
			 scolumn = "momast_copy_cvcod"			 
			 return -2
		end if
	end if
	
	if tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "pagbn") = 'Y' then
		sreff = tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_pa_pordno")
		Select itnbr, pspec, pdsts into :sitnbr, :sispec, :sreff1 from momast
		 where sabu = :gs_sabu and pordno = :sreff;
		  
		if sqlca.sqlcode <> 0 then
			f_message_chk(77,'[작업지시번호]')
			tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_pa_pordno", '')
			tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_pa_ospeq", '')
			scolumn = "momast_copy_pa_pordno"
			return -2
		end if
		if sreff1 <> '1' and sreff1 <> '2' then
			f_message_chk(84,'[작업지시상태]')
			tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_pa_pordno", '')
			tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_pa_ospeq", '')
			scolumn = "momast_copy_pa_pordno"
			return -2
		end if
		
		sitnbr = tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_itnbr")
		sopseq = tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_pa_ospeq")
		
		// 분할할 공정이 실제로 존재하는지 CHECK
		setnull(sopdsc)
		Select opdsc into :sopdsc from morout
		 Where sabu = :gs_sabu And pordno = :sreff And opseq = :sopseq;		
		if isnull(sopdsc) then 
			scolumn = "momast_copy_pa_ospeq"		
			return -2
		end if
		
		// 가용수량 check = (당공정합격 + 불량) - (후공정 정상실적 + 당공정 수리실적수량) 
		 select nvl(a.mqty, 0) - (nvl(b.preqty, 0) + nvl(c.suqty, 0))
 		   into :dgaqty
			from (select (b.coqty + b.faqty) as mqty
					  from momast a, morout b
					 where a.sabu = :gs_sabu and a.pordno = :sreff
						and a.pdsts in ('1','2')
						and a.sabu  = b.sabu     and a.pordno = b.pordno
						and b.opseq = :sopseq)a,
				  (select sum(roqty) as preqty
					  from shpact 
					 where sabu   = :gs_sabu
						and pordno = :sreff
						and opsno  = (select de_opseq 	 from morout
											where sabu   = :gs_sabu 
											  and pordno = :sreff
											  and opseq  = :sopseq )
						and sigbn  = '1' )b, 
				  (select sum(roqty) as suqty
					  from shpact 
					 where sabu   = :gs_sabu
						and pordno = :sreff
						and opsno  = :sopseq
						and sigbn  = '2' )c;  
			  
		if dgaqty < tab_1.tabpage_2.dw_tabpage2.getitemdecimal(Lrow, "momast_copy_pdqty") then
			f_message_chk(88,'[분할가용수량]')
			scolumn = "momast_copy_pa_ospeq"
			return -1
		end if
		
		sitnbr  = tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_itnbr")	
	end if
	
    iReturn =  wf_requiredchk_bomrtn2(lrow, sitnbr, sRtnbr, spordno) 
	 IF ireturn = -1 then
		 scolumn = "momast_copy_itnbr"
		 return -1
	 Else
		 tab_1.tabpage_2.dw_tabpage2.Setitem(Lrow, "momast_copy_stditnbr", sRtnbr)
	 End if	 	

Next

return 1


end function

public function integer wf_requiredchk_tabpage31 (ref long lrow, ref string scolumn);string   snull, sitnbr, sreff, sreff1, sitdsc, sispec, scvcod, sopseq, spordno, stoday, spropseq, sdeopseq
integer  ireturn
Decimal  {5} dunprc
long lcnt, lfind, lnext

w_mdi_frame.sle_msg.text = "공정일정 내역을 검색중입니다......!!"

sToday = f_today()

tab_1.tabpage_3.dw_tabpage3_2.accepttext()

setnull(snull)
setnull(spropseq)
setnull(sdeopseq)

For 	lcnt = 1 to tab_1.tabpage_3.dw_tabpage3_2.rowcount()
		lrow = lcnt
	 	/* 생산시작일*/
		sreff = tab_1.tabpage_3.dw_tabpage3_2.getitemstring(lcnt, "morout_copy_esdat")
		tab_1.tabpage_3.dw_tabpage3_2.setitem(lcnt, "morout_copy_fsdat", sreff)		
		if isnull(sreff) or trim(sreff) = '' or f_datechk(sreff) = -1 then
			f_message_chk(35,'[생산시작일(1)]') 
			tab_1.tabpage_3.dw_tabpage3_2.setitem(lcnt, "morout_copy_esdat", '')
			tab_1.tabpage_3.dw_tabpage3_2.setitem(lcnt, "morout_copy_fsdat", '')
			scolumn = "morout_copy_esdat"
			RETURN  -1
		end if
		
		/* 첫번째 공정의 생산시작일을 작업지시-head에 move */
		if lcnt = 1 then
			spordno = tab_1.tabpage_3.dw_tabpage3_2.getitemstring(lcnt, "morout_copy_pordno")
			lfind   = tab_1.tabpage_3.dw_tabpage3_1.find("momast_copy_pordno = '"+ spordno +"'", 0, tab_1.tabpage_3.dw_tabpage3_1.rowcount())
			if lfind > 0 then
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lfind, "momast_copy_esdat", sreff)
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lfind, "momast_copy_fsdat", sreff)
				tab_1.tabpage_2.dw_tabpage2.setitem(lfind, "momast_copy_esdat", sreff)
				tab_1.tabpage_2.dw_tabpage2.setitem(lfind, "momast_copy_fsdat", sreff)				
			end if				
		end if

		/* 생산종료일 */
		sreff1 = tab_1.tabpage_3.dw_tabpage3_2.getitemstring(lcnt, "morout_copy_eedat")	
		tab_1.tabpage_3.dw_tabpage3_2.setitem(lcnt, "morout_copy_fedat", sreff1)
		if isnull(sreff1) or trim(sreff1) = '' or f_datechk(sreff1) = -1 then
			f_message_chk(35,'[생산종료일(2)]') 
			tab_1.tabpage_3.dw_tabpage3_2.setitem(lcnt, "morout_copy_eedat", '')
			tab_1.tabpage_3.dw_tabpage3_2.setitem(lcnt, "morout_copy_fedat", '')		
			scolumn = "morout_copy_eedat"			
			RETURN  -1			
		end if
		
		if sreff > sreff1 then
			f_message_chk(35,'[생산종료일(3)]') 
			tab_1.tabpage_3.dw_tabpage3_2.setitem(lcnt, "morout_copy_eedat", '')
			tab_1.tabpage_3.dw_tabpage3_2.setitem(lcnt, "morout_copy_fedat", '')
			scolumn = "morout_copy_eedat"
			RETURN  -1			
		end if
		
		/* 마지막 공정의 생산종료일을 작업지시-head에 move */
		if lcnt = tab_1.tabpage_3.dw_tabpage3_2.rowcount() then
			if lfind > 0 then
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lfind, "momast_copy_eedat", sreff1)
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lfind, "momast_copy_fedat", sreff1)
				tab_1.tabpage_2.dw_tabpage2.setitem(lfind, "momast_copy_eedat", sreff1)
				tab_1.tabpage_2.dw_tabpage2.setitem(lfind, "momast_copy_fedat", sreff1)
			end if				
		end if				

		/* 작업장 */
		ireturn = 0
		sreff = tab_1.tabpage_3.dw_tabpage3_2.getitemstring(lcnt, "morout_copy_wkctr")
		select a.wkctr, a.wcdsc, b.jocod, b.jonam
		  into :sitnbr, :sreff, :sitdsc, :sispec
		  from wrkctr a, jomast b
		 where a.wkctr = :sreff and a.jocod = b.jocod (+);
		if sqlca.sqlcode <> 0 then
			f_message_chk(90,'[작업장]')
			setnull(sreff)		
			setnull(sitnbr)
			setnull(sitdsc)
			setnull(sispec)
			ireturn = -1
		end if
	if not isnull(sreff)  and isnull(sitdsc) then
			f_message_chk(91,'[조]')
			setnull(sreff)
			setnull(sitnbr)
			setnull(sitdsc)
			setnull(sispec)
			ireturn = -1
		end if
		tab_1.tabpage_3.dw_tabpage3_2.setitem(lcnt, "morout_copy_wkctr", sitnbr)
		tab_1.tabpage_3.dw_tabpage3_2.setitem(lcnt, "wrkctr_wcdsc", sreff)
		tab_1.tabpage_3.dw_tabpage3_2.setitem(lcnt, "morout_copy_jocod", sitdsc)
		tab_1.tabpage_3.dw_tabpage3_2.setitem(lcnt, "jomast_jonam", sispec)
		if ireturn = -1 then
			scolumn = "morout_copy_wkctr"
			return -1
		end if
		
		/* 설비 */
		ireturn = 0
		sreff = tab_1.tabpage_3.dw_tabpage3_2.getitemstring(lcnt, "morout_copy_mchcod")
		if not isnull(sreff) then
			select mchnam
			  into :sreff1
			  from mchmst
			 where sabu = :gs_sabu and mchno = :sreff;
			if sqlca.sqlcode <> 0 then
				f_message_chk(92,'[설비]')
				setnull(sreff)
				setnull(sreff1)		
				ireturn = -1
			end if
			tab_1.tabpage_3.dw_tabpage3_2.setitem(lcnt, "mchmst_mchnam", sreff1)
			if ireturn = -1 then
				scolumn = "morout_copy_mchcod"
				return -1
			end if
		end if
		/* 외주유무 */
		sreff = tab_1.tabpage_3.dw_tabpage3_2.getitemstring(lcnt, "morout_copy_purgc")
		sopseq = tab_1.tabpage_3.dw_tabpage3_2.getitemstring(lcnt, "morout_copy_opseq")		
		if sreff = 'Y' then
			Setnull(sCvcod)
			scvcod = tab_1.tabpage_3.dw_tabpage3_2.getitemstring(lcnt, "morout_copy_wicvcod")
			ireturn = f_get_name2('V1', 'N', scvcod, sitdsc, sispec)    //1이면 실패, 0이 성공	
			tab_1.tabpage_3.dw_tabpage3_2.setitem(lcnt, "morout_copy_wicvcod", scvcod)	
			tab_1.tabpage_3.dw_tabpage3_2.setitem(lcnt, "vndmst_cvnas2",  sitdsc)
			if ireturn  = 1 then
				f_message_chk(30,'[외주거래처]')
				scolumn = "morout_copy_wicvcod"
				RETURN -1
			end if
		
		end if
		
		/* 작업예상시간 */
      dunprc = tab_1.tabpage_3.dw_tabpage3_2.getitemdecimal(lcnt, "morout_copy_estim")
		if dunprc < 0 then
			f_message_chk(93,'[작업예상시간]') 
			scolumn = "morout_copy_estim"
			RETURN  -1
		end if
		
		/* 전공정 및 후공정에 대한 정리 작업 
			단 후공정은 동시공정인 경우에는 작성하지 않는다.	*/
		if IsNull( spropseq )  then
			tab_1.tabpage_3.dw_tabpage3_2.setitem(lcnt, "morout_copy_pr_opseq", '0000')
		Else
			tab_1.tabpage_3.dw_tabpage3_2.setitem(lcnt, "morout_copy_pr_opseq", spropseq)
		End if
		spropseq = sopseq
		
		if IsNull (tab_1.tabpage_3.dw_tabpage3_2.getitemstring(lcnt, "morout_copy_do_opseq")) then
			if lcnt < tab_1.tabpage_3.dw_tabpage3_2.rowcount()  then
				tab_1.tabpage_3.dw_tabpage3_2.setitem(lcnt, "morout_copy_de_opseq", tab_1.tabpage_3.dw_tabpage3_2.getitemstring(lcnt + 1, "morout_copy_opseq"))
			Else
				tab_1.tabpage_3.dw_tabpage3_2.setitem(lcnt, "morout_copy_de_opseq", snull)
			end if
		end if
		
Next

if tab_1.tabpage_3.dw_tabpage3_2.update() = 1 then
	commit;
Else
	Rollback;
	return -1
end if

return 1
end function

public function integer wf_reset ();rollback;

String sToday , sCode

stoday = f_today()
w_mdi_frame.sle_msg.text = ''

/* tabpage를 disable */
tab_1.tabpage_2.enabled = false
tab_1.tabpage_3.enabled = false
tab_1.tabpage_4.enabled = false
tab_1.tabpage_5.enabled = false

/* datawindow clear */
tab_1.tabpage_1.dw_plnlist.settransobject(sqlca)	// 연동계획 검토화면
tab_1.tabpage_1.dw_date.settransobject(sqlca)		// 연동계획 선택화면
tab_1.tabpage_2.dw_tabpage2.settransobject(sqlca)	// 품목우선순위 선택화면

tab_1.tabpage_2.p_last.enabled = false				// 작업지시button
tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"				// 작업지시button
/* 연동계획 선택화면을 기본으로 설정 */
tab_1.tabpage_1.enabled = True
tab_1.selecttab(1);
tab_1.tabpage_1.dw_date.setfocus()

ib_any_typing = false

/* User별 사업장 Setting */
f_mod_saupj(dw_saupj, 'saupj')

/* 반제품 창고 검색 */
sCode 	= wf_DepotNo('2', '2')
dw_ban.setitem(1, "ban_code", sCode)
/* 자제 창고 검색 */
sCode 	= wf_DepotNo('3', '')
dw_jaje.setitem(1, "jaje_code", sCode)



return 1
end function

public function integer wf_treeview_retrieve ();integer gu1, gu2
long lrow
string sc1, sc2, gubun

tab_1.tabpage_5.dw_buha1.accepttext()
gu1 = tab_1.tabpage_5.dw_buha1.getitemdecimal(1, "gu1")
gu2 = tab_1.tabpage_5.dw_buha1.getitemdecimal(1, "gu2")
gubun = tab_1.tabpage_5.dw_buha1.getitemstring(1, "gubun")

if gubun = '1' then
	tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02605_01'
	tab_1.tabpage_5.dw_buha2.settransobject(sqlca)
	if i_level = 1 then
		Lrow = tab_1.tabpage_5.dw_buha2.retrieve(gs_sabu, gu1, gu2, '%', '%', '%')
	elseif i_level = 2 then
		Lrow = tab_1.tabpage_5.dw_buha2.retrieve(gs_sabu, gu1, gu2, '%', '%', trscode)		
	elseif i_level = 3 then	
		select pdtgu into :sc1 from jomast where jocod = :trscode;
		Lrow = tab_1.tabpage_5.dw_buha2.retrieve(gs_sabu, gu1, gu2, '%', trscode, sc1)
	else
		select jocod into :sc2 from wrkctr where wkctr = :trscode;
		select pdtgu into :sc1 from jomast where jocod = :sc2;	
		Lrow = tab_1.tabpage_5.dw_buha2.retrieve(gs_sabu, gu1, gu2, trscode, sc2, sc1)
	end if
	tab_1.tabpage_5.dw_buha2.object.gr_1.title = trsname + '부하현황'	
Else
	tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02605_02'
	tab_1.tabpage_5.dw_buha2.settransobject(sqlca)	
	if i_level = 1 then
		Lrow = tab_1.tabpage_5.dw_buha2.retrieve(gs_sabu, gu1, gu2, '%', '%', '%','1')
	elseif i_level = 2 then
		Lrow = tab_1.tabpage_5.dw_buha2.retrieve(gs_sabu, gu1, gu2, '%', '%', trscode,'2')		
	elseif i_level = 3 then	
		select pdtgu into :sc1 from jomast where jocod = :trscode;
		Lrow = tab_1.tabpage_5.dw_buha2.retrieve(gs_sabu, gu1, gu2, '%', trscode, sc1,'3')
	else
		Messagebox("부하율", "작업장은 공수로 확인하십시요", information!)
		return 1
	end if	
	tab_1.tabpage_5.dw_buha2.object.gr_1.title = trsname + '부하율'		
End if



if tab_1.tabpage_5.dw_buha2.rowcount() < 1 then
	f_message_chk(50,'[부하현황-그래프]')
	tab_1.tabpage_5.dw_buha1.Setfocus()
	tab_1.tabpage_5.pb_graph.enabled = false
	tab_1.tabpage_5.pb_space.enabled = false	
	tab_1.tabpage_5.p_print1.enabled = false
	tab_1.tabpage_5.p_print1.PictureName = "C:\erpman\image\인쇄_d.gif"
	return -1
Else
	tab_1.tabpage_5.pb_graph.enabled = True
	tab_1.tabpage_5.pb_space.enabled = True
	tab_1.tabpage_5.p_print1.enabled = true
	tab_1.tabpage_5.p_print1.PictureName = "C:\erpman\image\인쇄_up.gif"
end if

return 1
end function

public function integer wf_treeview_retrieve2 ();tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02030_c'
tab_1.tabpage_5.dw_buha2.settransobject(sqlca)
tab_1.tabpage_5.dw_buha2.retrieve(gs_sabu, is_sysno)

if tab_1.tabpage_5.dw_buha2.rowcount() < 1 then
	f_message_chk(50,'[생산일정]')
	tab_1.tabpage_5.p_print1.enabled = false
	tab_1.tabpage_5.p_print1.PictureName = "C:\erpman\image\인쇄_d.gif"	
	return -1
Else
	tab_1.tabpage_5.p_print1.enabled = true
	tab_1.tabpage_5.p_print1.PictureName = "C:\erpman\image\인쇄_up.gif"
end if	
	
	
return 1
end function

public function integer wf_treeview_retrieve1 ();  String Go1,Go2,GuGan1,GuGan2, gubun, prtgbn, pordno
	
		
	tab_1.tabpage_5.dw_buha3.AcceptText()
   tab_1.tabpage_5.dw_buha2.Reset()
	
	gubun   =  tab_1.tabpage_5.dw_buha3.GetItemString(1,"gubun")	
	prtgbn   =  tab_1.tabpage_5.dw_buha3.GetItemString(1,"prtgbn")		
	Go1   =  tab_1.tabpage_5.dw_buha3.GetItemString(1,"jo1")
   Go2   =  tab_1.tabpage_5.dw_buha3.GetItemString(1,"jo2")
   GuGan1 =  tab_1.tabpage_5.dw_buha3.GetItemString(1,"gu1")
   GuGan2 =  tab_1.tabpage_5.dw_buha3.GetItemString(1,"gu2")
   pordno =  is_sysno
	
	IF Go1 = '' OR ISNULL(Go1) THEN
		go1 = '.'
	END IF	
	IF Go2 = '' OR ISNULL(Go2) THEN
		go2 = 'zzzzzzzzzzzzzz'
	END IF	
	IF GuGan1 = '' OR ISNULL(GuGan1) THEN
       SELECT Min(RESCAL.GUGAN) 
	     INTO: GuGan1
	     FROM RESCAL ;  	
	END IF	
	
	IF GuGan2 = '' OR ISNULL(GuGan2) THEN
		SELECT Max(RESCAL.GUGAN) 
	     INTO: GuGan2
	     FROM RESCAL ;  	
	END IF	
	
	IF Go1 > Go2 THEN
		MessageBox("확인","코드범위를 확인하세요")
		tab_1.tabpage_5.dw_buha3.SetColumn("jo1")
		tab_1.tabpage_5.dw_buha3.SetFocus()
		return -1
	END IF	
	
	IF GuGan1 > GuGan2 THEN
		MessageBox("확인","구간범위를 확인하세요")
		tab_1.tabpage_5.dw_buha3.SetColumn("gu1")
		tab_1.tabpage_5.dw_buha3.SetFocus()
		return -1
		
	END IF	
	
//	if 		gubun = '1' and prtgbn = '1' then
//				tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02600_03'
//	elseif 	gubun = '2' and prtgbn = '1' then
//				tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02600_02'
//	elseif 	gubun = '3' and prtgbn = '1' then
//				tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02600_01'
//	elseif 	gubun = '4' and prtgbn = '1' then
//				tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02600_04'
//	Elseif 	gubun = '1' and prtgbn = '2' then
//				tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02600_031'
//	elseif 	gubun = '2' and prtgbn = '2' then
//				tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02600_021'
//	elseif 	gubun = '3' and prtgbn = '2' then
//				tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02600_011'
//	elseif 	gubun = '4' and prtgbn = '2' then
//				tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02600_041'
//	elseif   gubun = '5' then
//				tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02605_08'
//	end if
	
	if 		gubun = '1' and prtgbn = '1' then
		tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02600_03'
	elseif 	gubun = '2' and prtgbn = '1' then
		tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02600_02'
	elseif 	gubun = '3' and prtgbn = '1' then
		tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02600_01'
	elseif 	gubun = '4' and prtgbn = '1' then
		tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02600_04'
	Elseif 	gubun = '1' and prtgbn = '2' then
		tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02600_031'
	elseif 	gubun = '2' and prtgbn = '2' then
		tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02600_021'
	elseif 	gubun = '3' and prtgbn = '2' then
		tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02600_011'
	elseif 	gubun = '4' and prtgbn = '2' then
		tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02600_041'
	Elseif 	gubun = '1' and prtgbn = '3' then
		tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02600_053'
	elseif 	gubun = '2' and prtgbn = '3' then
		tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02600_052'
	elseif 	gubun = '3' and prtgbn = '3' then
		tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02600_051'
	elseif 	gubun = '4' and prtgbn = '3' then
		tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02600_054'				
	elseif   gubun = '5' then
		tab_1.tabpage_5.dw_buha2.dataobject = 'd_pdt_02605_05'
	end if
	
	
	tab_1.tabpage_5.dw_buha2.settransobject(sqlca)

	if  gubun = '5' then
		 IF  tab_1.tabpage_5.dw_buha2.Retrieve(gs_sabu,0,99,pordno) < 1 THEN
			  f_message_chk(50,'')
			  return -1
		 END IF		
	Else
		 IF  tab_1.tabpage_5.dw_buha2.Retrieve(gs_sabu,Go1,Go2,GuGan1,GuGan2 ) < 1 THEN
			  f_message_chk(50,'')
			  return -1
		 END IF
		
		 if gubun = '4' then
			 tab_1.tabpage_5.dw_buha2.object.roslt_name.text = f_get_reffer('21', go1)
		 End if
	end if
	
if tab_1.tabpage_5.dw_buha2.rowcount() < 1 then
	f_message_chk(50,'[부하현황-자료]')
	tab_1.tabpage_5.dw_buha3.Setfocus()
	tab_1.tabpage_5.p_print1.enabled = false
	tab_1.tabpage_5.p_print1.PictureName = "C:\erpman\image\인쇄_d.gif"
	return -1
Else
	tab_1.tabpage_5.p_print1.enabled = true
	tab_1.tabpage_5.p_print1.PictureName = "C:\erpman\image\인쇄_up.gif"
end if	
	
	
return 1
end function

public function integer wf_requiredchk_tabpage1 ();Long 		lrow, Linsrow, lcount, lopt, k 
Integer	Icnt, Ii, Ij, iReturn, Nn
String	schk, sToday, sPdtgu, sItgu, sItnbr, sCvcod, sCvnas, stuncu, sRtnbr, sWanch, sBanch, &
		   sIttyp, sGubun, sAuto, sJasacode, sPorgu, sitcls, nToday, sOrdgbn, sMchno, snull
Decimal {5} dUnprc, dPdprc, dcnt
String 	sTditnbr[], sTpdtgu[], sCitnbr, sGbn, sNapgi , ls_saupj
Decimal {3} dTqty[], dArrcnt, dArrMax, dOrqty, dOptqty, dpdqty, dmod, dyoqty 
String	ls_pspec

Setnull( snull )

/* 자료선택구분(1:연동계획, 2:작업예정, 3:수주자료, 4:개발의뢰자료, 5:금형치공구, 7:A/S, 8:크레임) */
sgubun 		= tab_1.tabpage_1.dw_date.getitemstring(1, "gubun")

// 수주기준으로 작업지시를 할 경우에 수주건별로 작업지시를 작성할 지 여부를 선택
// 수주건별로 작성할 경우에는 수주번호를 오더에 작성한다.
sOrdgbn = 'N'
if sGubun = '3' then
	If MessageBox("작업지시", "수주 건별로 작업지시를 하시겠읍니까?", Question!, yesno!) = 1 then
		sOrdgbn = 'Y'
	End if
End if

ls_saupj	= dw_saupj.GetItemString(1,"saupj")
/* 창고는 완제품, 반제품인 경우 첫번째 창고를 선택한다 */
Select Min(cvcod) Into :sWanch from Vndmst where cvgu = '5' and juprod = '1' and ipjogun = :ls_saupj ;
Select Min(cvcod) Into :sBanch from Vndmst where cvgu = '5' and juprod = '2' and ipjogun = :ls_saupj;

/* 작업지시번호 채번(Visual) */
IF ls_auto = 'N' THEN 
	stoday = trim(sle_bal.text)
	IF stoday = '' or isnull(stoday) THEN 
		MessageBox("확 인", "생성할 작업지시번호를 입력하세요!") 
		sle_bal.setfocus()
		return 0
	END IF
ELSE
	stoday = f_today()
END IF

// 화면상에 보이는 작업지시번호 채번
ii = sqlca.fun_junpyo(gs_sabu, stoday, 'N0')
if ii < 1 then
	f_message_chk(51,'[작업지시번호]') 
	rollback;
	return -1
end if

// 작업지시 기준번호 채번(모든 계산단위는 작업지시 기준번호를 기준으로 한다)
ntoday = f_today()
Nn = sqlca.fun_junpyo(gs_sabu, nToday, 'N3')
if Nn < 1 then
	f_message_chk(51,'[작업지시 기준번호]') 
	rollback;
	return -1
end if

Commit;

/* 자료 저장용 datawindow clear */
dw_insert.reset()

ispordno = stoday + String(ii, '0000')
is_sysno = nToday + String(Nn, '0000')

tab_1.tabpage_1.dw_plnlist.accepttext()

/* 지시품번을 대표품번 기준으로 할 것인지 개별품번 기준으로 할 것인지 선택 
	1 : 대표품번으로 작업지시
	2 : 개별품번으로 작업지시	*/
select dataname
  into :sauto
  from syscnfg
 where sysgu = 'Y' and serial = 15 and lineno = '10';
 
if sauto = '1' then
	sauto = '1'       // 1 : 대표품번으로 작업지시 - 분할 수 사용안함(왜냐하면 수량집계이므로) 
Else
	sauto = '2'       //	2 : 개별품번으로 작업지시
End if

// 화면 자료 건수
lcount      = tab_1.tabpage_1.dw_plnlist.rowcount()		

// 환경설정이 대표품번으로 작업지시를 하더라도 개발의뢰 내역, 금형/치공구는 개별품번으로 한다.
// 단 수주건별 작성인경우에는 무조건 개별로 한다
if sauto = '1' and sOrdgbn = 'N' and (sGubun = '1' or sGubun = '2' or sGubun = '3') then   
	
	dArrcnt 	= 0
	dArrMax 	= 0
	
	For Lrow = 1 to lCount	
		
		 sChk = tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "gubun")

		 if schk = 'N' then continue			
		 
		 sItnbr   	= tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "itnbr")			 
		 dOrqty   	= tab_1.tabpage_1.dw_plnlist.getitemdecimal(Lrow, "monqty")
		 
		 /* 품번으로 대표품번을 검색 */
		 Setnull(sCitnbr)
		 Select stdnbr into :sCitnbr
			From itemas
		  Where itnbr = :sItnbr;
		  
		 if isnull(sCitnbr) Or Trim(sCitnbr) = '' then
			 sCitnbr	=	sItnbr;
		 End if

		 sGbn = 'N'
		 For dArrcnt = 1 to dArrMax
			  if sTditnbr[dArrcnt] = sCitnbr Then
				  dTqty[dArrcnt]	  = dTqty[dArrcnt] + dOrqty
				  sGbn = 'Y'
				  Exit
			  End if
		 Next
		 
		 /* 신규 대표품번인 경우 */
		 if sGbn = 'N' then
			 sTditnbr[dArrcnt] 	 = sCitnbr
			  sTpdtgu[dArrcnt]	 = tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "pdtgu")
				 dTqty[dArrcnt]	 = dOrqty
						 dArrMax		 = dArrcnt
		 End if
	
	Next
	
end if
	
// 단 환경설정이 대표품번으로 작업지시를 하더라도 개발의뢰 내역은 개별품번으로 한다.
// 단 수주건별 작성인경우에는 무조건 개별로 한다
if  	sauto = '1'  and sOrdgbn = 'N' and (sGubun = '1' or sGubun = '2' or sGubun = '3') then   /* 대표품번인 경우 */ 
	For 	Lrow = 1 to dArrMax
		 
		 /* 작업지시를 임시로 생성 */
		 Linsrow = dw_insert.insertrow(0)
		 dw_insert.setitem(Linsrow, "momast_copy_sabu",   gs_sabu)
		 dw_insert.setitem(Linsrow, "momast_copy_pordno", iSpordno + String(Linsrow, '000') + '0')
		 dw_insert.setitem(Linsrow, "momast_copy_jidat",  sToday)
		 
		 sItnbr = Stditnbr[Lrow]
		 dw_insert.setitem(Linsrow, "momast_copy_itnbr", sItnbr)
		 dw_insert.setitem(Linsrow, "momast_copy_pspec",  '.')	// 기본사양을 저장
		 
		 sPdtgu = sTpdtgu[Lrow]
		 If isnull(sPdtgu) or Trim(sPdtgu) = '' then
			 f_message_chk(309, '[생산팀구분]' + sPdtgu)
			 return -1
		 end if
	
		 dw_insert.setitem(Linsrow, "momast_copy_pdtgu", sPdtgu )
		 dw_insert.setitem(Linsrow, "momast_copy_pdqty", round(dTQty[Lrow],0))
		 dw_insert.setitem(Linsrow, "momast_copy_pdsts", '1')
		 /* 그룹웨어연동여부 */
		 If is_gwgbn = 'Y' Then
	 		 dw_insert.setitem(Linsrow, "momast_copy_matchk", '3')
		 Else
 		 	dw_insert.setitem(Linsrow, "momast_copy_matchk", '2')
		 End If
	
		 /* 품목마스터의 구입/생산형태를 기준으로 작성 */
		 Setnull(sItgu)
		 Setnull(sIttyp)
		 Select itgu, ittyp Into :sItgu, :sIttyp From itemas
		  Where itnbr = :sItnbr;
		  
		 // 작업지시에 필요한 기초자료 check
		 iReturn =  wf_requiredchk_bomrtn(sitnbr, sRtnbr) 	
		 dw_insert.setitem(Linsrow, "momast_copy_stditnbr", sRtnbr)		
			
		 If sItgu = '6' then		// 외주인 경우 
			 dw_insert.setitem(Linsrow, "momast_copy_purgc",  'Y')	
			 Setnull(sCvcod)
			 f_buy_unprc(sItnbr, '.' , '9999', sCvcod, sCvnas, dUnprc, sTuncu)
			 If isnull(sCvcod) or trim(sCvcod) = '' then	// 외주거래처가 없는 경우에는 자사거래처로 설정한다.
				select dataname
				  into :sJasacode
				  from syscnfg
				 where sysgu = 'C' and serial = '4' and lineno = '1';			 
				 d_pdt_02030_strerr.setitem(LInsrow, "err6", 2)
				 sCvcod = sJasaCode
				 dUnprc = 0
			 End if
			 dw_insert.setitem(Linsrow, "momast_copy_cvcod",  sCvcod)
			 dw_insert.setitem(Linsrow, "momast_copy_unprc",  dUnprc)
		 Else
			 dw_insert.setitem(Linsrow, "momast_copy_purgc",  'N')
		 End if
		 			 
		 If sIttyp = '1' then 
			 dw_insert.Setitem(Linsrow, "momast_copy_ipchango", sWanch)
		 Else
			 dw_insert.Setitem(Linsrow, "momast_copy_ipchango", sBanch)
		 End if
		 
		 /* 생산실적 작성용 단가 산출 */
		 dw_insert.setitem(Linsrow, "momast_copy_pdprc", sqlca.fun_erp100000012(f_today(), sitnbr, '.'))
		 
		 /* 작업지시 기준번호 작성 */
		 dw_insert.setitem(Linsrow, "momast_copy_master_no", is_sysno)

		 /* 수량을 기준으로 설비별 투입량을 계산하여 적정 횟수 및 수량을 계산 */
		 Select mchno, Nvl(yoqty, 0) into :smchno, :dyoqty
			From pstmch
		  Where itnbr = :sitnbr And mchno = (select min(mchno) from pstmch
														  Where itnbr = :sitnbr) ;
		 If dyoqty > 0 then
			 if k > 1 and k = lopt then  
				 dw_insert.setitem(Linsrow, "momast_copy_mchno", smchno)
				 dw_insert.setitem(Linsrow, "momast_copy_mocnt", ceiling(mod(dMod, dyoqty)))
				 dw_insert.setitem(Linsrow, "momast_copy_pdqty", ceiling(mod(dMod, dyoqty)) * dyoqty)
			 else
				 dw_insert.setitem(Linsrow, "momast_copy_mchno", smchno)
				 dw_insert.setitem(Linsrow, "momast_copy_mocnt", ceiling(mod(doptqty, dyoqty)))
				 dw_insert.setitem(Linsrow, "momast_copy_pdqty", ceiling(mod(doptqty, dyoqty)) * dyoqty)
			 end if
		 Else
				 dw_insert.setitem(Linsrow, "momast_copy_mchno", snull)
				 dw_insert.setitem(Linsrow, "momast_copy_mocnt", 0)
		 End if	

	Next	
Else	/* 개별 품목으로 작업지시 하는 경우 */
	For Lrow = 1 to lCount
		 sChk     = tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "gubun")
		
		 if schk = 'N' then continue
		 
		 dPdqty	 = tab_1.tabpage_1.dw_plnlist.getitemdecimal(Lrow, "monqty") 	//지시수
		 if sGubun = '2' or sGubun = '3' then
	       dOptqty	 = tab_1.tabpage_1.dw_plnlist.getitemdecimal(Lrow, "opt") 	//분할수
			 if isnull(dOptqty) or dOptqty <= 0 or dOptqty > dPdqty  then  dOptqty = dPdqty
			 
			 lOpt = dPdqty / dOptqty
          dMod = Mod(dPdqty, dOptqty)
			 
			 if dMod > 0 then   //나머지가 있으면 한번 더 count
				 lOpt = lOpt + 1
			 else               //나머지가 없으면 마지막에 dmod 값 move
				 dMod = dOptqty
			 end if
		 else
			 lOpt     = 1
			 doptqty  = dPdqty
			 dMod     = dPdqty
 		 end if

		 sItnbr = tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "itnbr")
		 sPdtgu = tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "pdtgu")
		 If 	isnull(sPdtgu) or Trim(sPdtgu) = '' then
			 f_message_chk(309, '[생산팀구분]' + tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "itdsc"))
			 return -1
		 end if

		 /* 품목마스터의 구입/생산형태를 기준으로 작성 */
		 Setnull(sItgu)
		 Setnull(sIttyp)
		 Setnull(sItcls)
		 Setnull(sporgu)
		 
		 Select a.itgu, a.ittyp, a.itcls
		   Into :sItgu, :sIttyp, :sitcls
			From itemas a
		  Where a.itnbr = :sItnbr ;
		  
		 select porgu  
		   into :sPorgu
			from itnct
		  where ittyp = :sittyp and itcls = substr(:sitcls, 1, 2) ;
		  sporgu = '12'
		  
		 // 작업지시에 필요한 기초자료 check
		 iReturn =  wf_requiredchk_bomrtn(sitnbr, sRtnbr) 	
		 
		 dPdprc  =	sqlca.fun_erp100000012(f_today(), sitnbr, '.')		
		 	 
		 FOR k = 1 TO lopt
			 /* 작업지시를 임시로 생성 */
			 Linsrow = dw_insert.insertrow(0)
			 dw_insert.setitem(Linsrow, "momast_copy_sabu",   gs_sabu)
			 dw_insert.setitem(Linsrow, "momast_copy_pordno", iSpordno + String(Linsrow, '000') + '0')
			 dw_insert.setitem(Linsrow, "momast_copy_jidat",  sToday)
			 
			 dw_insert.setitem(Linsrow, "momast_copy_itnbr", sItnbr)
			 dw_insert.setitem(Linsrow, "momast_copy_pspec",  '.')	// 기본사양을 저장
			 
			 dw_insert.setitem(Linsrow, "momast_copy_pdtgu", sPdtgu )
			 if k > 1 and k = lopt then  
				 dw_insert.setitem(Linsrow, "momast_copy_pdqty", dMod)
			 else
				 dw_insert.setitem(Linsrow, "momast_copy_pdqty", doptqty)
			 end if
			 dw_insert.setitem(Linsrow, "momast_copy_pdsts", '1')
			 /* 그룹웨어연동여부 */
			 If is_gwgbn = 'Y' Then
				dw_insert.setitem(Linsrow, "momast_copy_matchk", '3')
			 Else
			 	dw_insert.setitem(Linsrow, "momast_copy_matchk", '2')
			End If
		
			 dw_insert.setitem(Linsrow, "momast_copy_stditnbr", sRtnbr)

          //품목분류 대분류에 의해 작업지시구분을 선택
			 dw_insert.setitem(Linsrow, "momast_copy_porgu", sPorgu)
	
			 If sItgu = '6' then		// 외주인 경우 
				 dw_insert.setitem(Linsrow, "momast_copy_purgc",  'Y')	
				 Setnull(sCvcod)
				 f_buy_unprc(sItnbr, '.' , '9999', sCvcod, sCvnas, dUnprc, sTuncu)
				 If isnull(sCvcod) or trim(sCvcod) = '' then
					select dataname
					  into :sJasacode
					  from syscnfg
					 where sysgu = 'C' and serial = '4' and lineno = '1';			 
					 
					 d_pdt_02030_strerr.setitem(LInsrow, "err6", 2)
					 
					 sCvcod = sJasaCode
					 dUnprc = 0
				 End if
				 dw_insert.setitem(Linsrow, "momast_copy_cvcod",  sCvcod)
				 dw_insert.setitem(Linsrow, "momast_copy_unprc",  dUnprc)
			 Else
				 dw_insert.setitem(Linsrow, "momast_copy_purgc",  'N')
			 End if
		 
			 If sIttyp = '1' then
				 dw_insert.Setitem(Linsrow, "momast_copy_ipchango", sWanch)
			 Else
				 dw_insert.Setitem(Linsrow, "momast_copy_ipchango", sBanch)
			 End if
			 
			 /* 생산실적 작성용 단가 산출 */
			 dw_insert.setitem(Linsrow, "momast_copy_pdprc", dPdprc)
			 
			 // 수주건별로 작업지시인 경우 수주번호를 넣어준다.
			 if sOrdgbn = 'Y' then
				 dw_insert.setitem(Linsrow, "momast_copy_order_no",  tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "order_no"))
				 sNapgi =   tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "cust_napgi")
				 if not (isnull(sNapgi) or sNapgi < stoday) then
					 dw_insert.setitem(Linsrow, "momast_copy_eedat",  sNapgi  )
				 end if
			 // 4:개발의뢰자료, 5:금형/치공구, 7:A/S, 8:크레임
			 // 개발의뢰인 경우에는 개발의뢰 내역을 저장한다.
  		    elseif sGubun = '4' then
				 dw_insert.setitem(Linsrow, "momast_copy_reqno",  tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "reqno"))
				 dw_insert.setitem(Linsrow, "momast_copy_reqate", tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "cfdate"))
				 dw_insert.setitem(Linsrow, "momast_copy_eedat", tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "wadat"))
				 dw_insert.setitem(Linsrow, "momast_copy_fedat", tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "wadat"))
				 dw_insert.setitem(Linsrow, "momast_copy_pdprc",  tab_1.tabpage_1.dw_plnlist.getitemdecimal(Lrow, "unprc"))
				 if Not IsNull(tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "ipchango")) then
					 dw_insert.setitem(Linsrow, "momast_copy_ipchango", tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "ipchango"))
				 end if
				 dw_insert.setitem(Linsrow, "momast_copy_mogubn",  '4') // 작업지시 구분 : 개발의뢰
			 // 금형/치공구인 경우에는 제작의뢰 내역을 저장한다.
			 Elseif sGubun = '5' then
				 dw_insert.setitem(Linsrow, "momast_copy_kumno",  tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "kumno"))
				 dw_insert.setitem(Linsrow, "momast_copy_untno",   tab_1.tabpage_1.dw_plnlist.getitemdecimal(Lrow, "untno"))
				 dw_insert.setitem(Linsrow, "momast_copy_kestno", tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "reqno"))
				 dw_insert.setitem(Linsrow, "momast_copy_eedat",  tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "wadat"))
				 dw_insert.setitem(Linsrow, "momast_copy_fedat",  tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "wadat"))
				 dw_insert.setitem(Linsrow, "momast_copy_pdprc",  tab_1.tabpage_1.dw_plnlist.getitemdecimal(Lrow, "unprc"))
				 dw_insert.setitem(Linsrow, "momast_copy_mogubn",  '5') // 작업지시 구분
  		    elseif sGubun = '7' then
				 dw_insert.setitem(Linsrow, "momast_copy_reqno",  tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "asmetr_as_jpno"))
				 dw_insert.setitem(Linsrow, "momast_copy_asseq",  tab_1.tabpage_1.dw_plnlist.getitemNumber(Lrow, "asmetr_asseq"))
				 dw_insert.setitem(Linsrow, "momast_copy_reqate", tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "cfdate"))
				 dw_insert.setitem(Linsrow, "momast_copy_mogubn",  '7') // 작업지시 구분 : A/S
  		    elseif sGubun = '8' then
				 dw_insert.setitem(Linsrow, "momast_copy_reqno",  tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "clamst_cl_jpno"))
				 dw_insert.setitem(Linsrow, "momast_copy_reqate", tab_1.tabpage_1.dw_plnlist.getitemstring(Lrow, "cfdate"))
				 dw_insert.setitem(Linsrow, "momast_copy_mogubn",  '8') // 작업지시 구분 : 크레임
			 End if	
			 
	 		 /* 작업지시 기준번호 작성 */
			 dw_insert.setitem(Linsrow, "momast_copy_master_no", is_sysno)
			 
			 /* 수량을 기준으로 설비별 투입량을 계산하여 적정 횟수 및 수량을 계산 */
			 Select mchno, Nvl(yoqty, 0) into :smchno, :dyoqty
			   From pstmch
			  Where itnbr = :sitnbr And mchno = (select min(mchno) from pstmch
			  												  Where itnbr = :sitnbr) ;
			 If dyoqty > 0 then
				 if k > 1 and k = lopt then  
					
					 dcnt = ceiling(dmod / dyoqty)
					
					 dw_insert.setitem(Linsrow, "momast_copy_mchno", smchno)
					 dw_insert.setitem(Linsrow, "momast_copy_mocnt", dcnt)
					 dw_insert.setitem(Linsrow, "momast_copy_pdqty", dcnt * dyoqty)
				 else
					 dcnt = ceiling(dmod / dyoqty)					
					
					 dw_insert.setitem(Linsrow, "momast_copy_mchno", smchno)
					 dw_insert.setitem(Linsrow, "momast_copy_mocnt", dcnt)
					 dw_insert.setitem(Linsrow, "momast_copy_pdqty", dcnt * dyoqty)
				 end if
			 Else
					 dw_insert.setitem(Linsrow, "momast_copy_mchno", snull)
					 dw_insert.setitem(Linsrow, "momast_copy_mocnt", 0)
			 End if	
			 
		 NEXT
		
	Next
End if

if dw_insert.update() =  1 then
	commit;
Else
	Rollback;
	f_rollback()
	return -1
end if

return 1

end function

public function integer wf_cnt (long lrow, string sitnbr);string      sreff, sreff1
Decimal {3} dcnt, dyoqty
	 
/* 수량을 기준으로 설비별 투입량을 계산하여 적정 횟수 및 수량을 계산 */
dcnt   = tab_1.tabpage_2.dw_tabpage2.getitemdecimal(Lrow, "momast_copy_mocnt")
Select Nvl(yoqty, 0) into :dyoqty
From pstmch
Where itnbr = :sitnbr And mchno = :sreff;
 If sqlca.sqlcode = 0 and dyoqty > 0 then
	 tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_pdqty", dcnt * dyoqty)
	 tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "yoqty", dyoqty)
 Else
	 Setnull( sreff  )
	 Setnull( sreff1 )		 
	 tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_mocnt", 0)
	 tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_pdqty", 0)
	 tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "yoqty", 0)
 End if
	 
return 1
end function

public function string wf_depotno (string oversea_gu, string sjumaechul);string  sSaupj, sdepotNo

If 	IsNull(oversea_gu) Or oversea_gu = '' Then Return ''

sSaupj 	= dw_saupj.GetItemString(1, "saupj")

If	isnull(sJumaechul) or sJumaechul = "" then
	select min(cvcod )
	  into :sDepotNo
	  from vndmst
	 where cvgu = '5' and
			 juprod = :oversea_gu and                               // 1:  완제품 , 2: 반제품, 3:원자재
			 ipjogun = :sSaupj ;
else	
	select min(cvcod )
	  into :sDepotNo
	  from vndmst
	 where cvgu = '5' and
			 juprod       = :oversea_gu and                               // 1:  완제품 , 2: 반제품, 3:원자재
			 jumaechul = :sJumaechul and                               // 1: 생산, 2:일반
			 ipjogun      = :sSaupj ;
	
End if	

If 	IsNull(sDepotNo) Then 
	f_message_chk(1400,'[창고]')
	sDepotNo = ''
End If

Return sDepotNo

end function

public subroutine wf_item_check (long arg_row, string arg_itnbr, string arg_pspec, string arg_opseq);/* 품목마스터를 check하여 외주(구입형태 = '6')인 경우에는 작업지시를 기본으로 setting */
String sitgu, spurgc, sittyp, sipchango, snull, sDitnbr, srtnbr , ls_saupj

//사업장
ls_saupj = TRIM(dw_saupj.getitemstring(1, "saupj"))
if  ls_saupj = '' or isnull(ls_saupj) then
    ls_saupj = '%'
end if	  

Select itgu, ittyp into :sitgu, :sittyp
  from itemas 
 where itnbr = :arg_itnbr;
 
/* 외주인 경우 외주로 setting */
if sitgu 	= '6' then
	spurgc	= 'Y'
else
	spurgc	= 'N'
end if

Setnull(snull)

/* 거래처및 계약단가를 생성 */
String scvcod, sTuncu, scvnas
decimal {3} dUnprc

if spurgc = 'Y' then
	f_buy_unprc(arg_itnbr, arg_pspec, arg_opseq, scvcod, scvnas, dUnprc, sTuncu)
	tab_1.tabpage_2.dw_tabpage2.setitem(arg_row, "momast_copy_cvcod",  scvcod)
	tab_1.tabpage_2.dw_tabpage2.setitem(arg_row, "vndmst_cvnas2", scvnas)
	tab_1.tabpage_2.dw_tabpage2.setitem(arg_row, "momast_copy_unprc",  dUnprc)	
	tab_1.tabpage_2.dw_tabpage2.setitem(arg_row, "momast_copy_routct",  'N')		
	
	tab_1.tabpage_3.dw_tabpage3_1.setitem(arg_row, "momast_copy_cvcod",  scvcod)
	tab_1.tabpage_3.dw_tabpage3_1.setitem(arg_row, "vndmst_cvnas2", scvnas)
	tab_1.tabpage_3.dw_tabpage3_1.setitem(arg_row, "momast_copy_unprc",  dUnprc)	
	tab_1.tabpage_3.dw_tabpage3_1.setitem(arg_row, "momast_copy_routct",  'N')	
Else
	tab_1.tabpage_2.dw_tabpage2.setitem(arg_row, "momast_copy_cvcod",  snull)
	tab_1.tabpage_2.dw_tabpage2.setitem(arg_row, "vndmst_cvnas2", snull)
	tab_1.tabpage_2.dw_tabpage2.setitem(arg_row, "momast_copy_unprc",  0)	
	tab_1.tabpage_2.dw_tabpage2.setitem(arg_row, "momast_copy_routct",  'Y')		
	
	tab_1.tabpage_3.dw_tabpage3_1.setitem(arg_row, "momast_copy_cvcod",  snull)
	tab_1.tabpage_3.dw_tabpage3_1.setitem(arg_row, "vndmst_cvnas2", snull)
	tab_1.tabpage_3.dw_tabpage3_1.setitem(arg_row, "momast_copy_unprc",  0)		
	tab_1.tabpage_3.dw_tabpage3_1.setitem(arg_row, "momast_copy_routct",  'Y')	
end if

tab_1.tabpage_2.dw_tabpage2.setitem(arg_row, "momast_copy_purgc", spurgc)
tab_1.tabpage_3.dw_tabpage3_1.setitem(arg_row, "momast_copy_purgc", spurgc)

tab_1.tabpage_2.dw_tabpage2.setitem(arg_row, "momast_copy_pdprc", sqlca.fun_erp100000012(f_today(), arg_itnbr, '.'))	/* 생산기본단가 산출 */
tab_1.tabpage_3.dw_tabpage3_1.setitem(arg_row, "momast_copy_pdprc", sqlca.fun_erp100000012(f_today(), arg_itnbr, '.'))

/* 창고를 기본으로 SETTING하고 사용자가 수정 */
/* 창고는 완제품, 반제품인 경우 첫번째 창고를 선택한다 */
if sIttyp = '1' then
	Select Min(cvcod) Into :sIpchango from Vndmst where cvgu = '5' and juprod = '1' and ipjogun = :ls_saupj ;
elseif sittyp = '2' then
	Select Min(cvcod) Into :sIpchango from Vndmst where cvgu = '5' and juprod = '2' and ipjogun = :ls_saupj;
end if
tab_1.tabpage_2.dw_tabpage2.setitem(arg_row, "momast_copy_ipchango", sIpchango)
tab_1.tabpage_3.dw_tabpage3_1.setitem(arg_row, "momast_copy_ipchango", sIpchango)


Long lcnt
Lcnt = 0
Select count(*) Into :lcnt from pstruc
 Where pinbr = :arg_itnbr;
 
if Isnull(Lcnt) or Lcnt < 1 then
	Select stdnbr Into :sDitnbr From itemas
	 Where itnbr = :arg_Itnbr;

	/* 대표품번에 대한 BOM 검색 */
	Lcnt = 0
	Select count(*) Into :lcnt from pstruc
	 Where pinbr = :sDitnbr;
	sRtnbr = sDitnbr
Else
	sRtnbr = arg_itnbr
end if

if isnull(sRtnbr) or trim(sRtnbr) = '' then sRtnbr = arg_itnbr

tab_1.tabpage_2.dw_tabpage2.setitem(arg_row, "momast_copy_stditnbr", arg_itnbr)
tab_1.tabpage_3.dw_tabpage3_1.setitem(arg_row, "momast_copy_stditnbr", arg_itnbr)


end subroutine

on w_pdt_02030_two.create
int iCurrent
call super::create
this.gb_2=create gb_2
this.gb_1=create gb_1
this.cb_suju=create cb_suju
this.gb_3=create gb_3
this.tab_1=create tab_1
this.dw_ban=create dw_ban
this.dw_jaje=create dw_jaje
this.st_2=create st_2
this.sle_bal=create sle_bal
this.st_3=create st_3
this.dw_saupj=create dw_saupj
this.rr_1=create rr_1
iCurrent=UpperBound(this.Control)
this.Control[iCurrent+1]=this.gb_2
this.Control[iCurrent+2]=this.gb_1
this.Control[iCurrent+3]=this.cb_suju
this.Control[iCurrent+4]=this.gb_3
this.Control[iCurrent+5]=this.tab_1
this.Control[iCurrent+6]=this.dw_ban
this.Control[iCurrent+7]=this.dw_jaje
this.Control[iCurrent+8]=this.st_2
this.Control[iCurrent+9]=this.sle_bal
this.Control[iCurrent+10]=this.st_3
this.Control[iCurrent+11]=this.dw_saupj
this.Control[iCurrent+12]=this.rr_1
end on

on w_pdt_02030_two.destroy
call super::destroy
if IsValid(MenuID) then destroy(MenuID)
destroy(this.gb_2)
destroy(this.gb_1)
destroy(this.cb_suju)
destroy(this.gb_3)
destroy(this.tab_1)
destroy(this.dw_ban)
destroy(this.dw_jaje)
destroy(this.st_2)
destroy(this.sle_bal)
destroy(this.st_3)
destroy(this.dw_saupj)
destroy(this.rr_1)
end on

event open;call super::open;String stoday, sCode


//그룹웨어 연동구분
Select dataname into :is_gwgbn
  from syscnfg
 where sysgu = 'W' and
       serial = 1 and
		 lineno = '5';
		 
dw_BAN.settransobject(sqlca)
dw_BAN.insertrow(0)
dw_jaje.settransobject(sqlca)
dw_jaje.insertrow(0)
dw_saupj.settransobject(sqlca)
dw_saupj.insertrow(0)


dw_datetime.insertrow(0)

Select Min(cvcod) into :sCode
  From vndmst
 Where cvgu = '5' and jumaechul = '2' and juprod = '3';
dw_jaje.setitem(1, "jaje_code", sCode)

dw_insert.settransobject(sqlca)	/* 신규작업지시 저장용 - HEAD */

tab_1.tabpage_1.dw_plnlist.settransobject(sqlca)		// 연동계획 		검토화면
tab_1.tabpage_1.dw_date.settransobject(sqlca)			// 연동계획 		선택화면
tab_1.tabpage_1.dw_layout1.settransobject(sqlca)		// 연동계획 		선택화면
tab_1.tabpage_2.dw_tabpage2.settransobject(sqlca)		// 품목우선순위 	선택화면
tab_1.tabpage_3.dw_tabpage3_1.settransobject(sqlca)	// 작업지시품목별 상세화면 
tab_1.tabpage_3.dw_tabpage3_2.settransobject(sqlca)	// 작업지시공정별 상세화면
tab_1.tabpage_4.dw_head.settransobject(sqlca)			// 작업지시품목	할당화면
tab_1.tabpage_4.dw_jego.settransobject(sqlca)			// 품목별			할당화면
tab_1.tabpage_5.dw_buha1.settransobject(sqlca)			// 작업장별,조별	부하 구간 선택 화면
tab_1.tabpage_5.dw_buha1.insertrow(0)						// 작업장별,조별	부하 구간 선택 화면
tab_1.tabpage_5.dw_buha2.settransobject(sqlca)			// 작업장별,조별	부하 조회 화면
tab_1.tabpage_5.dw_buha3.settransobject(sqlca)			// 작업장별,조별	부하 조회 화면


/* 작업지시번호 자동채번여부를 환경설정에서 검색함 */
select dataname
  into :ls_auto
  from syscnfg
 where sysgu = 'S' and serial = 6 and lineno = '70';
 
If isNull(ls_auto) or Trim(ls_auto) = '' then
	ls_auto = 'Y'
End if

if ls_auto = 'Y' then 
	sle_bal.Visible = false
	st_2.Visible = false
end if

/* 하위단계 품목에 대한 자동작업지시 여부를 검색하여 Button control */
select dataname
  into :ls_auto
  from syscnfg
 where sysgu = 'Y' and serial = 21 and lineno = '1';
 
If isNull(ls_auto) or Trim(ls_auto) = '' then
	ls_auto = '1'
End if

if ls_auto = '3' then 
	tab_1.tabpage_2.p_auto.visible = false
End if

wf_treeview_item()

stoday = f_today()

tab_1.tabpage_1.dw_date.insertrow(0)
tab_1.tabpage_1.dw_date.setitem(1, "gidate", left(stoday, 6))
tab_1.tabpage_1.dw_date.setitem(1, "sdate",  stoday)
tab_1.tabpage_1.dw_date.setitem(1, "edate",  stoday)
tab_1.tabpage_1.dw_plnlist.reset()



///* 입고예정창고 Filtering */
DataWindowChild state_child1
integer rtncode1

rtncode1    = tab_1.tabpage_2.dw_tabpage2.GetChild('momast_copy_ipchango', state_child1)	
IF rtncode1 = -1 THEN MessageBox("Error1", "Not a DataWindowChild")	
state_child1.setFilter("Mid(cvcod,1,2) = 'Z9'")
state_child1.Filter()
	
wf_reset()
end event

event close;rollback;
end event

event closequery;call super::closequery;String sError

IF tab_1.tabpage_2.enabled then
	if Messagebox("작업지시", "작업지시중입니다" + '~n' + &
									  "작업지시를 취소하시겠읍니까?", question!, yesno!) = 1 then

		w_mdi_frame.sle_msg.text = '부하내역을 취소중입니다....!!'
		sError = 'X'
		sqlca.erp000000820(gs_sabu, is_sysno, sError);
		w_mdi_frame.sle_msg.text = ''
		Choose Case sError
				 Case 'X'
						F_message_chk(41,'[부하내역 계산]')
						Rollback;
						return -1
				 Case 'Y'
						F_message_chk(89,'[부하내역 계산]')
						Rollback;
						return -1
		End Choose
		
		/* 할당내역을 삭제 */
		Delete From holdstock_copy 			Where sabu = :gs_sabu and master_no Like :iS_sysno||'%';
		/* 지시내역을 삭제 */
		Delete From momast_copy 				Where sabu = :gs_sabu and master_no Like :iS_sysno||'%';
		Delete From morout_copy_none_copy 	Where sabu = :gs_sabu and master_no Like :iS_sysno||'%';
		/* 공정내역을 삭제 */
		Delete From morout_copy 				Where sabu = :gs_sabu and master_no Like :iS_sysno||'%';
		/* 반제품 소요수량 삭제 */
		Delete From momast_copy_lotsim 		Where sabu = :gs_sabu and master_no Like :iS_sysno||'%';
		
	   COMMIT;

	Else	
		return 1
	End if
end if

end event

type dw_insert from w_inherite`dw_insert within w_pdt_02030_two
boolean visible = false
integer x = 155
integer y = 2424
integer width = 517
integer height = 200
integer taborder = 0
boolean enabled = false
string dataobject = "d_pdt_02030_1"
boolean hscrollbar = true
boolean vscrollbar = true
end type

type p_delrow from w_inherite`p_delrow within w_pdt_02030_two
integer x = 3333
integer y = 2476
integer taborder = 70
end type

type p_addrow from w_inherite`p_addrow within w_pdt_02030_two
integer x = 3159
integer y = 2476
integer taborder = 50
end type

type p_search from w_inherite`p_search within w_pdt_02030_two
integer x = 2464
integer y = 2476
integer taborder = 130
end type

type p_ins from w_inherite`p_ins within w_pdt_02030_two
integer x = 2985
integer y = 2476
integer taborder = 30
end type

type p_exit from w_inherite`p_exit within w_pdt_02030_two
integer x = 4027
integer y = 2476
integer taborder = 120
end type

type p_can from w_inherite`p_can within w_pdt_02030_two
integer x = 3854
integer y = 2476
integer taborder = 110
end type

type p_print from w_inherite`p_print within w_pdt_02030_two
integer x = 2638
integer y = 2476
integer taborder = 140
end type

type p_inq from w_inherite`p_inq within w_pdt_02030_two
integer x = 2811
integer y = 2476
end type

type p_del from w_inherite`p_del within w_pdt_02030_two
integer x = 3680
integer y = 2476
integer taborder = 100
end type

type p_mod from w_inherite`p_mod within w_pdt_02030_two
integer x = 3506
integer y = 2476
integer taborder = 90
end type

type cb_exit from w_inherite`cb_exit within w_pdt_02030_two
integer x = 1650
integer y = 2708
boolean enabled = false
string text = "종료"
end type

type cb_mod from w_inherite`cb_mod within w_pdt_02030_two
integer x = 955
integer y = 2708
boolean enabled = false
string text = "계산"
end type

type cb_ins from w_inherite`cb_ins within w_pdt_02030_two
integer x = 261
integer y = 2956
boolean enabled = false
string text = "추가"
end type

event cb_ins::clicked;call super::clicked;//if tab_1.tabpage_2.dw_item.rowcount() = 0 then
//	if wf_reset() = -1 then
//		return
//	end if
//end if
//
//Long Lrow
//
//Lrow = 	tab_1.tabpage_2.dw_item.insertrow(0)
//		 	tab_1.tabpage_2.dw_item.setitem(Lrow, "momast_sabu", gs_sabu)
//			tab_1.tabpage_2.dw_item.setitem(Lrow, "momast_jidat", f_today())
//			tab_1.tabpage_2.dw_item.setitem(Lrow, "momast_pdsts", '1')
//			tab_1.tabpage_2.dw_item.setitem(Lrow, "momast_purgc", 'N')
//			tab_1.tabpage_2.dw_item.setitem(Lrow, "pagbn", 'N')
//
//post function wf_focus(Lrow, "momast_porgu")
end event

type cb_del from w_inherite`cb_del within w_pdt_02030_two
integer x = 613
integer y = 2956
boolean enabled = false
string text = "삭제"
end type

event cb_del::clicked;call super::clicked;//if tab_1.tabpage_2.dw_item.getrow() > 0 then
//	tab_1.tabpage_2.dw_item.deleterow(0)
//	tab_1.tabpage_2.dw_item.setfocus()
//else
//	f_message_chk(81,'[작업지시]') 	
//	cb_ins.setfocus()
//end if
end event

type cb_inq from w_inherite`cb_inq within w_pdt_02030_two
integer x = 965
integer y = 2956
boolean enabled = false
string text = "조회"
end type

type cb_print from w_inherite`cb_print within w_pdt_02030_two
integer x = 1303
integer y = 2952
boolean enabled = false
string text = "출력"
end type

type st_1 from w_inherite`st_1 within w_pdt_02030_two
integer x = 37
end type

type cb_can from w_inherite`cb_can within w_pdt_02030_two
integer x = 1298
integer y = 2708
boolean enabled = false
string text = "취소"
end type

type cb_search from w_inherite`cb_search within w_pdt_02030_two
integer x = 1669
integer y = 2956
boolean enabled = false
string text = "자료조회"
end type





type gb_10 from w_inherite`gb_10 within w_pdt_02030_two
integer x = 27
end type

type gb_button1 from w_inherite`gb_button1 within w_pdt_02030_two
end type

type gb_button2 from w_inherite`gb_button2 within w_pdt_02030_two
end type

type gb_2 from groupbox within w_pdt_02030_two
boolean visible = false
integer x = 937
integer y = 2668
integer width = 1070
integer height = 168
integer textsize = -10
integer weight = 700
fontcharset fontcharset = hangeul!
fontpitch fontpitch = fixed!
fontfamily fontfamily = modern!
string facename = "굴림체"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
end type

type gb_1 from groupbox within w_pdt_02030_two
boolean visible = false
integer x = 238
integer y = 2916
integer width = 722
integer height = 164
integer textsize = -10
integer weight = 700
fontcharset fontcharset = hangeul!
fontpitch fontpitch = fixed!
fontfamily fontfamily = modern!
string facename = "굴림체"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
end type

type cb_suju from commandbutton within w_pdt_02030_two
boolean visible = false
integer x = 1207
integer y = 2404
integer width = 325
integer height = 108
integer textsize = -10
integer weight = 700
fontcharset fontcharset = hangeul!
fontpitch fontpitch = fixed!
fontfamily fontfamily = modern!
string facename = "굴림체"
boolean enabled = false
string text = "수주연결"
end type

event clicked;//tab_1.selecttab(2)
//openwithparm(w_pdt_02030_3, tab_1.tabpage_2.dw_item)
end event

type gb_3 from groupbox within w_pdt_02030_two
boolean visible = false
integer x = 914
integer y = 2464
integer width = 1376
integer height = 164
integer textsize = -10
integer weight = 700
fontcharset fontcharset = hangeul!
fontpitch fontpitch = fixed!
fontfamily fontfamily = modern!
string facename = "굴림체"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
end type

type tab_1 from tab within w_pdt_02030_two
event create ( )
event destroy ( )
integer x = 37
integer y = 164
integer width = 4558
integer height = 2164
integer taborder = 20
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 32106727
boolean fixedwidth = true
boolean raggedright = true
boolean boldselectedtext = true
alignment alignment = center!
integer selectedtab = 1
tabpage_1 tabpage_1
tabpage_2 tabpage_2
tabpage_3 tabpage_3
tabpage_4 tabpage_4
tabpage_5 tabpage_5
end type

on tab_1.create
this.tabpage_1=create tabpage_1
this.tabpage_2=create tabpage_2
this.tabpage_3=create tabpage_3
this.tabpage_4=create tabpage_4
this.tabpage_5=create tabpage_5
this.Control[]={this.tabpage_1,&
this.tabpage_2,&
this.tabpage_3,&
this.tabpage_4,&
this.tabpage_5}
end on

on tab_1.destroy
destroy(this.tabpage_1)
destroy(this.tabpage_2)
destroy(this.tabpage_3)
destroy(this.tabpage_4)
destroy(this.tabpage_5)
end on

event selectionchanging;String scolumn, sItnbr, stditnbr
long   lrow
Integer Ichk
int rtn
string spordno

w_mdi_frame.sle_msg.text = ''

/* 품목별 기본내역 error check */
if oldindex = 2 then
	if tab_1.tabpage_2.dw_tabpage2.accepttext() = -1 then
		return 1
	end if
End if

/* 품목별 상세/공정내역 error check */	
if oldindex = 3 then
	If tab_1.tabpage_3.dw_tabpage3_1.accepttext() = -1 then
		return 1
	end if

	iChk =  wf_requiredchk_tabpage31(lrow, scolumn) 
	w_mdi_frame.sle_msg.text = ''	
	if iChk = -1 then
		tab_1.tabpage_3.dw_tabpage3_2.setcolumn(scolumn)
		tab_1.tabpage_3.dw_tabpage3_2.scrolltorow(lrow)
		tab_1.tabpage_3.dw_tabpage3_2.setfocus()
		return 1
	end if
	
	if ib_rcal then
		sPordno = tab_1.tabpage_3.dw_tabpage3_2.getitemstring(1, "morout_copy_pordno")
		
		SetPointer(HourGlass!)
		/* 공정별 일정에 대한 부하내역을 적상 */
		w_mdi_frame.sle_msg.text = '공정별 부하내역을 계산중입니다....!!'
		
		rtn = sqlca.erp000000810_2(gs_sabu, is_sysno, spordno);
		w_mdi_frame.sle_msg.text = ''
		If rtn = -1 then
			F_message_chk(41,'[공정별 부하계산]')
			Rollback;
		Else
			Commit;
		End if
	End if
	ib_rcal = false
end if

/* 부하내역 */
if oldindex = 5 then
	tab_1.tabpage_5.dw_buha2.reset()
End if

/* 자재할당인 경우 */
if oldindex = 4 then
	iChk =  wf_requiredchk_tabpage4(lrow, scolumn) 
	w_mdi_frame.sle_msg.text = ''	
	if iChk = -1 then
		tab_1.tabpage_4.dw_jego.setcolumn(scolumn)
		tab_1.tabpage_4.dw_jego.scrolltorow(lrow)
		tab_1.tabpage_4.dw_jego.setfocus()
		return 1
	end if
end if

/* 지시 기준자료인 경우에는 화면을 Reset 하고 기준번호를 Clear*/
if newindex = 1 then
	tab_1.tabpage_1.dw_plnlist.reset()
	tab_1.tabpage_1.dw_layout1.reset()	
	
	SetNull(IsPordno)
	SetNull(Is_SysNo)
end if

if newindex = 2 then
	w_mdi_frame.sle_msg.text = 'Double Click시 재고상세 내역을 조회할 수 있읍니다.'	
end if

Lrow = 0
/* 품목별 상세/공정내역의 순서를 품목별 기본내역의 화면과 동일하게 설정 */
if newindex = 3 Then
	Lrow = tab_1.tabpage_2.dw_tabpage2.getrow()
	if Lrow > 0 then
		tab_1.tabpage_3.dw_tabpage3_1.scrolltorow(Lrow)
		tab_1.tabpage_3.dw_tabpage3_1.setrow(Lrow)
		
		scolumn = tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_pordno")
		sitnbr  = tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_itnbr")
		tab_1.tabpage_3.dw_tabpage3_2.retrieve(gs_sabu, scolumn)
	End if
	ib_rcal = False  // 공정일정 수정을 감시하기위한 Tag
End if

Lrow = 0
/* 할당내역을 조회 */
if newindex = 4 then
	
	w_mdi_frame.sle_msg.text = 'Double Click시 대체품 또는 재고상세 내역을 조회할 수 있읍니다.'
	
	datawindowchild dwc
	tab_1.tabpage_4.dw_jego.getchild("opseq", dwc)
	dwc.settransobject(sqlca)
	
	tab_1.tabpage_4.dw_head.reset()
	tab_1.tabpage_4.dw_jego.reset()
	if oldindex = 3 Then		/* 품목별 상세화면 이면 */
		Lrow = tab_1.tabpage_3.dw_tabpage3_1.getrow()
		if Lrow > 0 then
			scolumn = tab_1.tabpage_3.dw_tabpage3_1.getitemstring(Lrow, "momast_copy_pordno")
			sItnbr  = tab_1.tabpage_3.dw_tabpage3_1.getitemstring(Lrow, "momast_copy_itnbr")
			stdItnbr = tab_1.tabpage_3.dw_tabpage3_1.getitemstring(Lrow, "momast_copy_stditnbr")
			IF dwc.retrieve(gs_sabu, scolumn) < 1 THEN 
				dwc.insertrow(0)
			END IF	
			tab_1.tabpage_4.dw_head.retrieve(gs_sabu, scolumn)
			tab_1.tabpage_4.dw_jego.retrieve(gs_sabu, scolumn)
		End if
	Else
		Lrow = tab_1.tabpage_2.dw_tabpage2.getrow()
		if Lrow > 0 then
			scolumn = tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_pordno")
			sItnbr  = tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_itnbr")
			stdItnbr  = tab_1.tabpage_2.dw_tabpage2.getitemstring(Lrow, "momast_copy_stditnbr")
			IF dwc.retrieve(gs_sabu, scolumn) < 1 THEN 
				dwc.insertrow(0)
			END IF	
			tab_1.tabpage_4.dw_head.retrieve(gs_sabu, scolumn)
			tab_1.tabpage_4.dw_jego.retrieve(gs_sabu, scolumn)
		End if		
	End if
	

End if
end event

type tabpage_1 from userobject within tab_1
event create ( )
event destroy ( )
integer x = 18
integer y = 108
integer width = 4521
integer height = 2040
long backcolor = 32106727
string text = "연동계획"
long tabtextcolor = 33554432
long tabbackcolor = 32106727
long picturemaskcolor = 553648127
rr_3 rr_3
cbx_2 cbx_2
rr_2 rr_2
p_tabpage1_cancel p_tabpage1_cancel
p_tabpage1_commit p_tabpage1_commit
p_tabpage1_print p_tabpage1_print
p_1 p_1
dw_date dw_date
dw_plnlist dw_plnlist
dw_layout1 dw_layout1
cbx_1 cbx_1
end type

on tabpage_1.create
this.rr_3=create rr_3
this.cbx_2=create cbx_2
this.rr_2=create rr_2
this.p_tabpage1_cancel=create p_tabpage1_cancel
this.p_tabpage1_commit=create p_tabpage1_commit
this.p_tabpage1_print=create p_tabpage1_print
this.p_1=create p_1
this.dw_date=create dw_date
this.dw_plnlist=create dw_plnlist
this.dw_layout1=create dw_layout1
this.cbx_1=create cbx_1
this.Control[]={this.rr_3,&
this.cbx_2,&
this.rr_2,&
this.p_tabpage1_cancel,&
this.p_tabpage1_commit,&
this.p_tabpage1_print,&
this.p_1,&
this.dw_date,&
this.dw_plnlist,&
this.dw_layout1,&
this.cbx_1}
end on

on tabpage_1.destroy
destroy(this.rr_3)
destroy(this.cbx_2)
destroy(this.rr_2)
destroy(this.p_tabpage1_cancel)
destroy(this.p_tabpage1_commit)
destroy(this.p_tabpage1_print)
destroy(this.p_1)
destroy(this.dw_date)
destroy(this.dw_plnlist)
destroy(this.dw_layout1)
destroy(this.cbx_1)
end on

type rr_3 from roundrectangle within tabpage_1
long linecolor = 28144969
integer linethickness = 1
long fillcolor = 32106727
integer x = 37
integer y = 1844
integer width = 4457
integer height = 180
integer cornerheight = 40
integer cornerwidth = 55
end type

type cbx_2 from checkbox within tabpage_1
integer x = 3794
integer y = 240
integer width = 695
integer height = 76
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = hangeul!
fontpitch fontpitch = fixed!
fontfamily fontfamily = modern!
string facename = "굴림체"
long textcolor = 33554432
long backcolor = 32106727
string text = "월계획 수량/잔량보기"
end type

type rr_2 from roundrectangle within tabpage_1
long linecolor = 28144969
integer linethickness = 1
long fillcolor = 32106727
integer x = 37
integer y = 316
integer width = 4457
integer height = 1512
integer cornerheight = 40
integer cornerwidth = 55
end type

type p_tabpage1_cancel from uo_picture within tabpage_1
integer x = 4315
integer y = 20
integer width = 178
string picturename = "C:\erpman\image\닫기_up.gif"
end type

event clicked;call super::clicked;if tab_1.tabpage_2.enabled then
	if Messagebox("작업지시", "작업지시중입니다" + '~n' + &
								     "작업지시를 취소하시겠읍니까?", question!, yesno!) = 2 then
		return
	end if
end if

p_exit.triggerevent(clicked!)

end event

event ue_lbuttonup;call super::ue_lbuttonup;PictureName = 'C:\erpman\image\닫기_up.gif'
end event

event ue_lbuttondown;call super::ue_lbuttondown;PictureName = 'C:\erpman\image\닫기_dn.gif'
end event

type p_tabpage1_commit from uo_picture within tabpage_1
integer x = 4142
integer y = 20
integer width = 178
string picturename = "C:\erpman\image\완료_up.gif"
end type

event clicked;call super::clicked;if tab_1.tabpage_2.enabled then
	if Messagebox("작업지시", "작업지시중입니다" + '~n' + &
								     "작업지시를 취소하시겠읍니까?", question!, yesno!, 2) = 2 then
		return
	end if
end if

w_mdi_frame.sle_msg.text = '품목자료를 생성중입니다....!!'
setpointer(hourglass!)
dw_insert.reset()

Integer Ireturn, Igubun

d_pdt_02030_strerr = create datastore
d_pdt_02030_strerr.dataobject = 'd_pdt_02030_strerr'

bomcheck = false // 작업지시 기초자료 오류여부 check
Ireturn =  wf_requiredchk_tabpage1() 

if 	bomcheck  then
	Messagebox("Error", "작업지시 하려고 하는 품목중 오류가 있읍니다", information!)
	Openwithparm(w_pdt_02030_6, d_pdt_02030_strerr)
End if
bomcheck = False

destroy d_pdt_02030_strerr

dw_insert.reset()
w_mdi_frame.sle_msg.text = ''

If Ireturn = -1 then
	Messagebox("작업지시", "품목자료 작성중 오류발생", stopsign!)
	return
elseIf Ireturn = 0 then
	return
end if

w_mdi_frame.sle_msg.text = '작업지시 예정 자료를 조회중입니다....!!'

String 	sYymm, sSdate, sEdate
integer	iMaxseq

sYymm 	= dw_date.getitemstring(1, "gidate")
sSdate	= dw_date.getitemstring(1, "sdate")
sEdate	= dw_date.getitemstring(1, "edate")

tab_1.tabpage_2.st_pordno.text = '[ 작업지시번호 ] ' + ispordno

/* 해당년월의 연동계획에 대한 최대차수 검색 */
select max(moseq) into :iMaxseq from monpln_sum 
 where sabu = :gs_sabu and monyymm = :sYymm;
 
/* 품목별 상세내역 조회 */
tab_1.tabpage_3.dw_tabpage3_1.retrieve(gs_sabu, is_sysno)

/* 품목별 내역 조회 		*/
tab_1.tabpage_2.dw_tabpage2.retrieve(gs_sabu, is_sysno, sYymm, iMaxseq, sSdate, sEdate)

setpointer(arrow!)

/* 순위결정 활성화 */
tab_1.tabpage_1.enabled = false
tab_1.tabpage_2.enabled = true
tab_1.tabpage_3.enabled = true
tab_1.tabpage_2.dw_tabpage2.setfocus()
tab_1.selecttab(2);

w_mdi_frame.sle_msg.text = 'Double Click시 재고상세 내역을 조회할 수 있읍니다.'	

end event

event ue_lbuttonup;call super::ue_lbuttonup;PictureName = 'C:\erpman\image\완료_up.gif'
end event

event ue_lbuttondown;call super::ue_lbuttondown;PictureName = 'C:\erpman\image\완료_dn.gif'
end event

type p_tabpage1_print from uo_picture within tabpage_1
integer x = 3968
integer y = 20
integer width = 178
boolean enabled = false
string picturename = "C:\erpman\image\인쇄_d.gif"
end type

event clicked;call super::clicked;openwithparm(w_print_options, tab_1.tabpage_1.dw_plnlist)
end event

event ue_lbuttonup;call super::ue_lbuttonup;PictureName = 'C:\erpman\image\인쇄_up.gif'
end event

event ue_lbuttondown;call super::ue_lbuttondown;PictureName = 'C:\erpman\image\인쇄_dn.gif'
end event

type p_1 from uo_picture within tabpage_1
integer x = 3794
integer y = 20
integer width = 178
string picturename = "C:\erpman\image\자료조회_up.gif"
end type

event clicked;call super::clicked;string sdate1, sdate2, sdate3, snull, slimon, s_team, sGbn, s_wkctr, sittyp, fitcls, titcls, sitnbr, sempno, ls_saupj
decimal dhseq

setnull(snull)

if dw_date.accepttext() = -1 then return 

sGbn = dw_date.getitemstring(1, "gubun")

/* 유효일자 check */
sdate1 = TRIM(dw_date.getitemstring(1, "gidate"))
if isnull(sdate1) or trim(sdate1) = '' or f_datechk(sdate1 + '01' ) = -1 then
	f_message_chk(35,'[일자 FROM]') 	
	dw_date.setcolumn('gidate')
	dw_date.setfocus()
	return 
end if

/* 기간에 대한 유효성 check */
sdate2 = TRIM(dw_date.getitemstring(1, "sdate"))
if isnull(sdate2) or trim(sdate2) = '' then sdate2 = '10000101'
//if isnull(sdate2) or trim(sdate2) = '' or f_datechk(sdate2) = -1 then
//	f_message_chk(35,'[일자 TO]') 	
//	dw_date.setcolumn('sdate')
//	dw_date.setfocus()
//	return 1
//end if	

// 계획년월 기간에 대한 일자check는 수주자료 기준인 경우에는 무시한다.
if sGbn = '1' then
	if dw_date.getitemstring(1, "gidate") > left(dw_date.getitemstring(1, "sdate"), 6) then
		f_message_chk(34,'[일자-2]') 	
		dw_date.setcolumn('sdate')
		dw_date.setfocus()
		return 1		
	end if
end if	
	
// 계획년월 기간에 대한 일자check는 수주자료 기준인 경우에는 무시한다.
if sGbn = '1' then
	select to_char(add_months(to_date(:sdate2, 'yyyymmdd'), 5), 'yyyymm')
	  into :slimon
	  from dual;	
	  
	if slimon < left(dw_date.getitemstring(1, "sdate"), 6) then
		f_message_chk(34,'[일자-4]'+slimon) 	
		dw_date.setcolumn('sdate')
		dw_date.setfocus()
		return 1		
	end if	  
end if

sdate3 = dw_date.getitemstring(1, "edate")
if isnull(sdate3) or trim(sdate3) = '' then sdate3 = '99991231'

// 계획년월 기간에 대한 일자check는 수주자료 기준인 경우에는 무시한다.
if sGbn = '1' then
	if dw_date.getitemstring(1, "gidate") > left(dw_date.getitemstring(1, "edate"), 6) then
		f_message_chk(34,'[일자]') 	
		dw_date.setcolumn('edate')
		dw_date.setfocus()
		return 1		
	end if
end if

// 계획년월 기간에 대한 일자check는 수주자료 기준인 경우에는 무시한다.
if sGbn = '1' then
	select to_char(add_months(to_date(:sdate3, 'yyyymmdd'), 5), 'yyyymm')
	  into :slimon
	  from dual;	
	  
	if slimon < left(dw_date.getitemstring(1, "edate"), 6) then
		f_message_chk(34,'[일자]') 	
		dw_date.setcolumn('edate')
		dw_date.setfocus()
		return 1		
	end if	  
end if

/* 해당년월의 연동계획에 대한 최대차수 검색 */
sdate1 = left(sdate1, 6)
select max(moseq) into :dhseq from monpln_sum 
 where sabu = :gs_sabu and monyymm = :sdate1;

isgyymm = sdate1
iimoseq = dhseq

sempno = TRIM(dw_date.getitemstring(1, "empno"))
if  sempno = '' or isnull(sempno) then
    sempno = '%'
end if	  

s_team = TRIM(dw_date.getitemstring(1, "steam"))
if  s_team = '' or isnull(s_team) then
    s_team = '%'
end if	  

/* 작업장 입력여부에 따라 */
s_wkctr = TRIM(dw_date.getitemstring(1, "wkctr"))

//사업장
ls_saupj = TRIM(dw_saupj.getitemstring(1, "saupj"))
if  ls_saupj = '' or isnull(ls_saupj) then
    ls_saupj = '%'
end if	  

/* 작업장이 없을 경우 전체 조회 */
if s_wkctr = '' or isnull(s_wkctr) then
	s_wkctr = '%'
	
	Choose Case sGbn
		Case '1'
			dw_plnlist.dataobject = 'd_pdt_02030_10a'
		Case '6'
			dw_plnlist.dataobject = 'd_pdt_02030_109a'
		Case '2'
			dw_plnlist.dataobject = 'd_pdt_02030_101a'			
		Case '3'
			dw_plnlist.dataobject = 'd_pdt_02030_102a_two'  // 할당기준으로 수주조회
		Case '4'
			dw_plnlist.dataobject = 'd_pdt_02030_104'
		Case '5'
			dw_plnlist.dataobject = 'd_pdt_02030_105'
		Case '7'
			dw_plnlist.dataobject = 'd_pdt_02030_107'
		Case '8'
			dw_plnlist.dataobject = 'd_pdt_02030_108'
	End Choose
Else
	Choose Case sGbn
		Case '1'
			dw_plnlist.dataobject = 'd_pdt_02030_10'
		Case '6'
			dw_plnlist.dataobject = 'd_pdt_02030_109'
		Case '2'
			dw_plnlist.dataobject = 'd_pdt_02030_101'
		Case '3'
			dw_plnlist.dataobject = 'd_pdt_02030_102'  // 할당기준으로 수주조회
		Case '4'
			dw_plnlist.dataobject = 'd_pdt_02030_104'
		Case '5'
			dw_plnlist.dataobject = 'd_pdt_02030_105'
		Case '7'
			dw_plnlist.dataobject = 'd_pdt_02030_107'
		Case '8'
			dw_plnlist.dataobject = 'd_pdt_02030_108'
	End Choose
end if

dw_layout1.reset()
dw_plnlist.settransobject(sqlca)

sittyp = TRIM(dw_date.getitemstring(1, "ittyp"))
fitcls = TRIM(dw_date.getitemstring(1, "itcls"))
titcls = TRIM(dw_date.getitemstring(1, "titcls"))
sitnbr = TRIM(dw_date.getitemstring(1, "itnbr"))

if sittyp = '' or isnull(sittyp) then sittyp = '%'
if sitnbr = '' or isnull(sitnbr) then sitnbr = '%'
if fitcls = '' or isnull(fitcls) then fitcls = '.'
if titcls = '' or isnull(titcls) then
	titcls = 'zzzzzzz'
else
	titcls = titcls + 'zzzzzzz'
end if

if  dw_plnlist.retrieve(gs_sabu, sdate1, dhseq, sdate2, sdate3, s_team, s_wkctr, sittyp, fitcls, titcls, sitnbr, sempno, ls_saupj) < 1 then
	Choose Case sGbn
		Case '1'
			 f_message_chk(50, '[연동계획자료]')
		Case '6'
			 f_message_chk(50, '[주간계획자료]')
		Case '2'
			 f_message_chk(50, '[작업예정자료]')
		Case '3'
			 f_message_chk(50, '[수주미처리자료]')
		Case '4'
			 f_message_chk(50, '[개발의뢰자료]')
		Case '5'
			 f_message_chk(50, '[금형제작자료]')
		Case '7'
			 f_message_chk(50, '[A/S수리자료]')
		Case '8'
			 f_message_chk(50, '[크레임수리자료]')
	End Choose	
	 dw_date.setcolumn("gidate")
	 dw_date.setfocus()
	 return
end if

p_tabpage1_print.enabled = True
p_tabpage1_print.PictureName = "C:\erpman\image\인쇄_up.gif"
dw_plnlist.setrow(1)
dw_plnlist.setfocus()

end event

event ue_lbuttonup;call super::ue_lbuttonup;PictureName = 'C:\erpman\image\자료조회_up.gif'
end event

event ue_lbuttondown;call super::ue_lbuttondown;PictureName = 'C:\erpman\image\자료조회_dn.gif'
end event

type dw_date from datawindow within tabpage_1
event ue_enterkey pbm_dwnprocessenter
integer x = 14
integer y = 24
integer width = 3685
integer height = 212
integer taborder = 10
boolean bringtotop = true
string dataobject = "d_pdt_02030_11"
boolean border = false
boolean livescroll = true
end type

event ue_enterkey;Send(Handle(this),256,9,0)
Return 1
end event

event itemchanged;string sdate, snull, slimon, steam, sGbn, swkctr, swknm
int    ireturn 

setnull(snull)

if this.accepttext() = -1 then return 

/* 계획자료 선택에 따른 text변경 */
if dwo.name = 'gubun' then
	sdate = this.gettext()
	Choose case sDate
			 Case '1'
//					p_1.text 	= '연동계획조회'
					tab_1.tabpage_1.text	= '연동계획'
					dw_plnlist.dataobject = 'd_pdt_02030_10'
					this.object.sdate_t.text = '계획일자'
			 Case '1'
//					p_1.text 	= '주간계획조회'
					tab_1.tabpage_1.text	= '주간계획'
					dw_plnlist.dataobject = 'd_pdt_02030_109'
					this.object.sdate_t.text = '계획일자'
			 Case '2'
//					p_1.text = '작업예정조회'
					tab_1.tabpage_1.text	= '작업예정'
					dw_plnlist.dataobject = 'd_pdt_02030_101'
					this.object.sdate_t.text = '계획일자'
			 Case '3'
//					p_1.text = '수주자료조회'
					tab_1.tabpage_1.text	= '수주자료'
					this.object.sdate_t.text = '수주승인일'
					dw_plnlist.dataobject = 'd_pdt_02030_102_two'  // 할당기준으로 수주조회
			 Case '4'
//					p_1.text = '개발의뢰조회'
					tab_1.tabpage_1.text	= '개발의뢰'
					dw_plnlist.dataobject = 'd_pdt_02030_104'
					this.object.sdate_t.text = '의뢰승인일'
			 Case '5'
//					p_1.text = '금형/치공구 조회'
					tab_1.tabpage_1.text	= '금형치구'
					dw_plnlist.dataobject = 'd_pdt_02030_105'
					this.object.sdate_t.text = '의뢰일자'

			 Case '7'
//					p_1.text = 'A/S 조회'
					tab_1.tabpage_1.text	= 'A/S'
					dw_plnlist.dataobject = 'd_pdt_02030_107'
					this.object.sdate_t.text = '의뢰승인일'					
			 Case '8'
//					p_1.text = '크레임 조회'
					tab_1.tabpage_1.text	= '크레임'
					dw_plnlist.dataobject = 'd_pdt_02030_108'
					this.object.sdate_t.text = '의뢰승인일'					
	End choose
	dw_plnlist.settransobject(sqlca)
	dw_layout1.reset()
end if

/* 유효일자 check */
if dwo.name = 'gidate' then
	sdate = this.gettext()
	this.setitem(1, "sdate", snull)
	this.setitem(1, "edate", snull)
	if isnull(sdate) or trim(sdate) = '' or f_datechk(sdate + '01') = -1 then
		f_message_chk(35,'[기준년월]') 	
		return 1
	end if
end if

sGbn = this.getitemstring(1, "gubun")

/* 기간에 대한 유효성 check */
if dwo.name = 'sdate' then
	sdate = this.gettext()
	if isnull(sdate) or trim(sdate) = '' then return 
	
	if f_datechk(sdate) = -1 then
		f_message_chk(35,'[일자 FROM]') 	
		return 1
	end if	
	
	// 계획년월 기간에 대한 일자check는 수주자료 기준인 경우에는 무시한다.
	if sGbn = '1' then
		if this.getitemstring(1, "gidate") > left(this.getitemstring(1, "sdate"), 6) then
			f_message_chk(34,'[일자-2]') 	
			return 1		
		end if
	end if
	
	select to_char(add_months(to_date(:sdate, 'yyyymmdd'), 5), 'yyyymm')
	  into :slimon
	  from dual;	
	  
	// 계획년월 기간에 대한 일자check는 수주자료 기준인 경우에는 무시한다.
	if sGbn = '1' then	  
		if slimon < left(this.getitemstring(1, "sdate"), 6) then
			f_message_chk(34,'[일자-4]'+slimon) 	
			return 1		
		end if	  
	end if
	
end if

if dwo.name = 'edate' then
	sdate = this.gettext()	
	if isnull(sdate) or trim(sdate) = '' then return 
	
	if f_datechk(sdate) = -1 then
		f_message_chk(35,'[일자 TO]') 	
		return 1
	end if
	
	// 계획년월 기간에 대한 일자check는 수주자료 기준인 경우에는 무시한다.
	if sGbn = '1' then	
		if this.getitemstring(1, "gidate") > left(this.getitemstring(1, "edate"), 6) then
			f_message_chk(34,'[일자]') 	
			return 1		
		end if
	end if	
		
	// 계획년월 기간에 대한 일자check는 수주자료 기준인 경우에는 무시한다.
	if sGbn = '1' then
		select to_char(add_months(to_date(:sdate, 'yyyymmdd'), 5), 'yyyymm')
		  into :slimon
		  from dual;	
		  
		if slimon < left(this.getitemstring(1, "edate"), 6) then
			f_message_chk(34,'[일자]') 	
			return 1		
		end if	  
	end if

end if
/* 생산 check */
if dwo.name = 'steam' then
	steam = this.gettext()
	if isnull(sTeam) or trim(steam) = '' then return 
end if

if dwo.name = 'wkctr' then
	swkctr = trim(this.gettext())
	
	if isnull(swkctr) or trim(swkctr) = '' then 
		this.setitem(1, "wknm", sNull)
		return 
	end if
	ireturn = f_get_name2('작업장', 'Y', swkctr, swknm, sdate) 
	this.setitem(1, "wkctr", swkctr)
	this.setitem(1, "wknm", swknm)
	return ireturn
end if
end event

event itemerror;this.setitem(1, dwo.name, '')
return 1
end event

event rbuttondown;string sittyp
str_itnct lstr_sitnct

gs_code     = ''
gs_codename = ''
gs_gubun    = ''

if this.getcolumnname() = "wkctr" then
   gs_code = this.gettext()
	open(w_workplace_popup)
	if gs_code = '' or isnull(gs_code) then return 
	this.setitem(1, "wkctr", gs_code)
	this.setitem(1, "wknm", gs_codename)
elseif this.GetColumnName() = 'itcls' then

	sIttyp   = this.GetItemString(1, 'ittyp')
	gs_gubun = this.GetItemString(1, 'steam')
	OpenWithParm(w_ittyp_popup4, sIttyp)
	
   lstr_sitnct = Message.PowerObjectParm	
	
	if isnull(lstr_sitnct.s_ittyp) or lstr_sitnct.s_ittyp = "" then return 
	
	this.SetItem(1, "ittyp", lstr_sitnct.s_ittyp)
	this.SetItem(1, "itcls", lstr_sitnct.s_sumgub)
elseif this.GetColumnName() = 'titcls' then

	sIttyp   = this.GetItemString(1, 'ittyp')
	gs_gubun = this.GetItemString(1, 'steam')
	OpenWithParm(w_ittyp_popup4, sIttyp)
	
   lstr_sitnct = Message.PowerObjectParm	
	
	if isnull(lstr_sitnct.s_ittyp) or lstr_sitnct.s_ittyp = "" then return 
	
	this.SetItem(1, "ittyp", lstr_sitnct.s_ittyp)
	this.SetItem(1, "titcls", lstr_sitnct.s_sumgub)
elseif this.GetColumnName() = 'itnbr' then
	gs_gubun = '1' 
	open(w_itemas_popup)
	
	if isnull(gs_code) or gs_code = "" then return
	
	this.SetItem(1, "itnbr", gs_code)

elseIF this.GetColumnName() = "cvcod" THEN 
   gs_gubun = '1' 
	OPEN(W_VNDMST_POPUP)

	if gs_code = '' or isnull(gs_code) then return 

	this.SetItem(1, "cvcod", gs_code)
	this.SetItem(1, "cvnas", gs_codename)
END IF


end event

type dw_plnlist from u_d_select_sort within tabpage_1
integer x = 46
integer y = 324
integer width = 4439
integer height = 1492
integer taborder = 11
boolean bringtotop = true
string dataobject = "d_pdt_02030_10"
boolean border = false
end type

event clicked;if is_chk ='Y' then 
   is_old_dwobject_name = ''
	is_chk = 'N' 
end if	

Long Lrow
Lrow = row

wf_tabpage1_layout(Lrow)

CALL SUPER ::CLICKED



end event

event rowfocuschanged;//Long Lrow
//Lrow = currentrow
//
//if Lrow > 0 then
//	selectrow(0, False)
//	selectrow(Lrow, True)	
//	wf_tabpage1_layout(Lrow)
//end if


end event

event rbuttondown;call super::rbuttondown;string sitnbr

If row > 0 AND ( dwo.name = 'bomchk' or dwo.name = 'rouchk')     then
	sitnbr = this.getitemstring(row, 'itnbr')
	
	if dwo.name = 'rouchk' then
		gs_gubun = 'ATTENTION'
		gs_code  = sitnbr 
      open(w_pdm_01440)
   else
		gs_gubun = 'ATTENTION'
		gs_code  = sitnbr 
      open(w_pdm_01530)
	End if
End if


end event

type dw_layout1 from datawindow within tabpage_1
integer x = 46
integer y = 1860
integer width = 4439
integer height = 152
integer taborder = 40
boolean bringtotop = true
string dataobject = "d_pdt_02030_jego"
boolean border = false
boolean livescroll = true
end type

type cbx_1 from checkbox within tabpage_1
integer x = 3794
integer y = 176
integer width = 375
integer height = 76
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = hangeul!
fontpitch fontpitch = fixed!
fontfamily fontfamily = modern!
string facename = "굴림체"
long textcolor = 33554432
long backcolor = 32106727
string text = "전체선택"
end type

event clicked;long ll_count, lCount
string ls_status

if this.checked = true then
	ls_status='Y'
	this.text = '전체해제'
else
	ls_status='N'
	this.text = '전체선택'
end if

SetPointer(HourGlass!)

lCount = dw_plnlist.rowcount() 

for ll_count=1 to lCount
	dw_plnlist.setitem(ll_count, 'gubun', ls_status)
next


end event

type tabpage_2 from userobject within tab_1
integer x = 18
integer y = 108
integer width = 4521
integer height = 2040
boolean enabled = false
long backcolor = 32106727
string text = "순위결정"
long tabtextcolor = 33554432
long tabbackcolor = 32106727
long picturemaskcolor = 536870912
rr_4 rr_4
p_4 p_4
p_3 p_3
p_2 p_2
p_tabpage2_insert p_tabpage2_insert
p_12 p_12
p_auto p_auto
p_last p_last
dw_tabpage2 dw_tabpage2
st_pordno st_pordno
rr_9 rr_9
end type

on tabpage_2.create
this.rr_4=create rr_4
this.p_4=create p_4
this.p_3=create p_3
this.p_2=create p_2
this.p_tabpage2_insert=create p_tabpage2_insert
this.p_12=create p_12
this.p_auto=create p_auto
this.p_last=create p_last
this.dw_tabpage2=create dw_tabpage2
this.st_pordno=create st_pordno
this.rr_9=create rr_9
this.Control[]={this.rr_4,&
this.p_4,&
this.p_3,&
this.p_2,&
this.p_tabpage2_insert,&
this.p_12,&
this.p_auto,&
this.p_last,&
this.dw_tabpage2,&
this.st_pordno,&
this.rr_9}
end on

on tabpage_2.destroy
destroy(this.rr_4)
destroy(this.p_4)
destroy(this.p_3)
destroy(this.p_2)
destroy(this.p_tabpage2_insert)
destroy(this.p_12)
destroy(this.p_auto)
destroy(this.p_last)
destroy(this.dw_tabpage2)
destroy(this.st_pordno)
destroy(this.rr_9)
end on

type rr_4 from roundrectangle within tabpage_2
long linecolor = 28144969
integer linethickness = 1
long fillcolor = 32106727
integer x = 37
integer y = 188
integer width = 4462
integer height = 1832
integer cornerheight = 40
integer cornerwidth = 55
end type

type p_4 from uo_picture within tabpage_2
integer x = 4315
integer y = 20
integer width = 178
boolean originalsize = true
string picturename = "C:\erpman\image\취소_up.gif"
end type

event clicked;call super::clicked;if Messagebox("작업지시", "작업지시중입니다" + '~n' + &
							     "작업지시를 취소하시겠읍니까?", question!, yesno!) = 2 then
	return
end if

String sError
/* 작업지시 임시자료에 의하여 계산된 부하내역을 복구시킨다(부하내역 삭제만 함). */
if isnull(is_sysno) or trim(is_sysno) = '' then
Else
	w_mdi_frame.sle_msg.text = '부하내역을 취소중입니다....!!'
	sError = 'X'
	sqlca.erp000000820(gs_sabu, is_sysno, sError);
	w_mdi_frame.sle_msg.text = ''
	Choose Case sError
			 Case 'X'
					F_message_chk(41,'[부하내역 계산]')
					Rollback;
					return -1
			 Case 'Y'
					F_message_chk(89,'[부하내역 계산]')
					Rollback;
					return -1
	End Choose
end if

/* 지시내역을 삭제 */
Delete From momast_copy 				Where sabu = :gs_sabu and master_no Like :iS_sysno||'%';
/* 공정내역을 삭제 */
Delete From morout_copy 				Where sabu = :gs_sabu and master_no Like :iS_sysno||'%';
Delete From morout_copy_none_copy 	Where sabu = :gs_sabu and master_no Like :iS_sysno||'%';
/* 할당내역을 삭제 */
Delete From holdstock_copy 			Where sabu = :gs_sabu and master_no Like :iS_sysno||'%';
/* 반제품 소요수량 삭제 */
Delete From momast_copy_lotsim 		Where sabu = :gs_sabu and master_no Like :iS_sysno||'%';

Commit;

wf_reset()

end event

event ue_lbuttonup;call super::ue_lbuttonup;PictureName = 'C:\erpman\image\취소_up.gif'
end event

event ue_lbuttondown;call super::ue_lbuttondown;PictureName = 'C:\erpman\image\취소_dn.gif'
end event

type p_3 from uo_picture within tabpage_2
integer x = 4142
integer y = 20
integer width = 178
string picturename = "C:\erpman\image\계산_up.gif"
end type

event clicked;call super::clicked;String 	sColumn, sReturn, sToday, sPordno, sBan, sJaje, srtnbr, spriorno
Long	 	Lrow, Lsqlcode
Integer 	iGubun, iReturn, iBan, iJ

if dw_tabpage2.accepttext() = -1 then
	dw_tabpage2.setfocus()
	return
end if

dw_ban.accepttext() 		// 반제품 출고 기준창고
dw_jaje.accepttext()		     // 부품   출고 기준창고
sBan		=	dw_ban.getitemstring(1, "ban_code")
sJaje		=	dw_jaje.getitemstring(1, "jaje_code")

/* 재작업지시 여부인지 CHECK */
IF tab_1.tabpage_4.enabled then
	if Messagebox("재작업지시", "현재일정이 계산되어 있읍니다" + '~n' + &
										 "작업일정을 재계산하시겠읍니까?", question!, yesno!, 2) = 2 then
		return
	end if
end if

String sError

sToday = f_today()

//-------------------------------------------------------------------------------------------------------//

// 임시 공정내역 삭제
Delete From morout_copy_none_copy Where sabu = :gs_sabu and master_no Like :iS_sysno||'%';
Commit;

//-------------------------------------------------------------------------------------------------------//

SetPointer(HourGlass!)

dw_tabpage2.setredraw(false)
if MessageBox("자동작업지시", "자동으로 작업지시된 내역을 삭제하시겠읍니까?",Question!, yesno!) = 1 Then
	/* 기존 자동 작업지시 삭제 */
	For Lrow = 1 to dw_tabpage2.rowcount()
		 If dw_tabpage2.getitemstring(Lrow, "autocrt_yn") = 'Y' then
			 dw_tabpage2.deleterow(Lrow)
			 Lrow = Lrow - 1
		 End if
	Next
End if
dw_tabpage2.setredraw(True)	

//-------------------------------------------------------------------------------------------------------//

// 작업지시번호 재작성 및  작업지시 품목에 대한 대표품번및 품목오류 검색
w_mdi_frame.sle_msg.text = '작업지시번호를 생성하고 있읍니다...!'
For Lrow = 1 to dw_tabpage2.rowcount()
	
	 setnull(spriorno)
	 sPriorNo = dw_tabpage2.getitemstring(Lrow, "momast_copy_pordno")
	  
	 dw_tabpage2.setitem(Lrow, "momast_copy_pordno", ispordno + string(Lrow, '000') + '0')
	 spordno = ispordno + string(Lrow, '000') + '0'
	 
	 // 저장된 작업지시로 공정생성이 no이면 임시로 morout_copy를 복사한다.
	 if 	dw_tabpage2.getitemstring(Lrow, "momast_copy_routct") = 'N' And not isnull(sPriorno) then
		insert into morout_copy_none_copy
		Select sabu, :spordno, itnbr, pspec, opseq, de_opseq, mchcod, wkctr, jocod, purgc, uptgu, esdat,
				 eedat, estim, esinw, rstim, tsinw, ntime, lastc, fsdat, fedat, roqty, faqty, suqty, peqty, coqty, paqty,
				 nedat, ladat, wicvcod, wiunprc, pr_opseq, do_opseq, system_end_date, bajpno, rmks, watims, sttim, esset, esman, esmch,
				 esgbn, rsset, rsman, rsmch, qcgub, opdsc, roslt, system_end_date, qcgin, stdmn, master_no  
				 From morout_copy 
		 Where sabu = :gs_sabu And pordno = :sPriorno;	
		 if sqlca.sqlcode <> 0 then
			 LSqlcode = dec(sqlca.sqlcode)
			 f_message_chk(lsqlcode, "[공정복사]")
			 w_mdi_frame.sle_msg.text = ''				 
			 rollback;
			 return
		 end if
	 End if;	 
Next

/* 공정내역을 삭제 */
Delete From morout_copy    Where sabu = :gs_sabu and master_no Like :iS_sysno||'%';	

/* 할당내역을 삭제 */
Delete From holdstock_copy Where sabu = :gs_sabu and master_no Like :iS_sysno||'%';	

Commit;
//-------------------------------------------------------------------------------------------------------//

// 자료 무결성 check
d_pdt_02030_strerr = create datastore
d_pdt_02030_strerr.dataobject = 'd_pdt_02030_strerr'

bomcheck = false // 작업지시 기초자료 오류여부 check

iReturn = 0
iReturn = wf_requiredchk_tabpage2(sColumn, Lrow)

If 	 iReturn = -1 then		/* 현재 화면에서 복구할 수 있는 ERROR인 경우 */
		 Rollback;
		 w_mdi_frame.sle_msg.text = ''		 
		 dw_tabpage2.setcolumn(sColumn)
		 dw_tabpage2.sCrolltorow(Lrow)
		 dw_tabpage2.setrow(Lrow)
		 dw_tabpage2.setfocus()
		 return
elseif iReturn = -2 then		/* 품목 상세화면에서 복구할 수 있는 ERROR인 경우 */
		 Rollback;
		 w_mdi_frame.sle_msg.text = ''		 	
		 tab_1.tabpage_3.dw_tabpage3_1.setcolumn(sColumn)
		 tab_1.tabpage_3.dw_tabpage3_1.sCrolltoRow(Lrow)
		 tab_1.tabpage_3.dw_tabpage3_1.setRow(Lrow)
		 tab_1.selecttab(3)
		 tab_1.tabpage_3.dw_tabpage3_1.setFocus()
		 return
end if

if 	dw_tabpage2.update() = 1 then
	
	// 임시로 복사한 내역을 복사
	insert into morout_copy
		Select * from morout_copy_none_copy
		 Where sabu = :gs_sabu And master_no Like :is_sysno||'%';
	 if 	sqlca.sqlcode <> 0 then
		 LSqlcode = dec(sqlca.sqlcode)
		 f_message_chk(lsqlcode, "[공정복사복구]")
		 w_mdi_frame.sle_msg.text = ''			 
		 rollback;
		 return
	 end if		 
		 
	Commit;		 
	
Else
	Rollback;
	w_mdi_frame.sle_msg.text = ''
	f_rollback()
	return
end if

//-------------------------------------------------------------------------------------------------------//
if 	bomcheck  then
	rollback;
	Messagebox("Error", "작업지시 하려고 하는 품목중 오류가 있읍니다", information!)
	Openwithparm(w_pdt_02030_6, d_pdt_02030_strerr)
	destroy d_pdt_02030_strerr
	Return
End if
bomcheck = False

destroy d_pdt_02030_strerr

//-------------------------------------------------------------------------------------------------------//

/* 작업지시 임시자료에 의하여 계산된 부하내역을 복구시킨다(부하내역 삭제만 함). */
if isnull(is_sysno) or trim(is_sysno) = '' then
Else
	w_mdi_frame.sle_msg.text = '부하내역을 취소중입니다....!!'
	sError = 'X'
	sqlca.erp000000820(gs_sabu, is_sysno, sError);
	w_mdi_frame.sle_msg.text = ''
	Choose Case sError
			 Case 'X'
					Rollback;
					F_message_chk(41,'[부하내역 계산]')
					return -1
			 Case 'Y'
					Rollback;
					F_message_chk(89,'[부하내역 계산]')
					return -1
	End Choose	
end if

//-------------------------------------------------------------------------------------------------------//
/* 작업지시 공정상세 생성 및 일정계산 */
w_mdi_frame.sle_msg.text = '작업일정을 생성중입니다....!!'

// 전체외주인 경우에는 공정상세 내역을 삭제한다
Delete 
  From morout_copy a
 Where a.sabu 		= :gs_sabu
 	And a.pordno IN (select pordno from momast_copy b where b.sabu 		= 		:gs_sabu 
	 																	 and b.master_no	Like 	:is_sysno||'%'
	 																	 and b.purgc		= 		'Y');
																		  
//-------------------------------------------------------------------------------------------------------//
Integer ii, JJ
/* 자동작업지시에 대한 검색기준을 환경설정에서 검색
	-. 자료가 없는 경우에는 기본적으로 검색을 한다.
	1:다단계, 2:단단계, 3:안함 */
	
w_mdi_frame.sle_msg.text = '자동 작업지시를 준비하고 있읍니다....!'

Ireturn = 0
Ireturn = sqlca.erp000000830_1(gs_sabu, iS_sysno);

IF Ireturn < 1 then 
	F_message_chk(41,'[작업지시 소요량 계산]' + string(ireturn) )
	w_mdi_frame.sle_msg.text = ''
End If

Ireturn = 0
Ireturn = sqlca.erp000000830(gs_sabu, iS_sysno, sBan, '');

w_mdi_frame.sle_msg.text = ''
Choose Case Ireturn
		 Case 0
				F_message_chk(41,'[자동 작업지시 계산]')
				Rollback;
				return;
		 Case -1
				F_message_chk(89,'[자동 작업지시 계산]')
				Rollback;
				return;			
End Choose

//-------------------------------------------------------------------------------------------------------//

// 공정상세 내역 생성
sError = 'X'

sqlca.erp000000880(gs_sabu, is_sysno, sError);

Choose Case sError
		 Case 'X'
				Rollback;
				F_message_chk(41,'[공정상세 생성]')
				JJ = dw_tabpage2.find("momast_copy_pordno = '"+ is_sysno +"'", 0, dw_tabpage2.rowcount())
				if jj > 0 then
					dw_tabpage2.scrolltorow(jj)
					dw_tabpage2.setrow(JJ)
					dw_tabpage2.setfocus()
				End if
				w_mdi_frame.sle_msg.text = ''
				return;
		 Case 'Y'
				Rollback;
				F_message_chk(89,'[공정상세 생성]')
				JJ = dw_tabpage2.find("momast_copy_pordno = '"+ is_sysno +"'", 0, dw_tabpage2.rowcount())
				if jj > 0 then
					dw_tabpage2.scrolltorow(jj)
					dw_tabpage2.setrow(JJ)
					dw_tabpage2.setfocus()
				End if				
				w_mdi_frame.sle_msg.text = ''				
				return;			
End Choose

//-------------------------------------------------------------------------------------------------------//


/* 작업지시 공정 일정 계산 */
w_mdi_frame.sle_msg.text = '작업일정을 계산중입니다....!!'

II = 0
Ii = sqlca.erp000000810(gs_sabu, is_sysno);
Choose Case Ii
		 Case 0
				F_message_chk(41,'[공정일정 계산]')
				Rollback;
				w_mdi_frame.sle_msg.text = ''
				return;
		 Case -1
				F_message_chk(89,'[공정일정 계산]')
				Rollback;
				w_mdi_frame.sle_msg.text = ''
				return;			
		 Case -2
				F_message_chk(205,'[공정일정 계산]')
				Rollback;
				return;			
End Choose
Commit;
//-------------------------------------------------------------------------------------------------------//

/* 작업지시를 다시 조회한다. */
String 	sYymm, sSdate, sEdate
integer	iMaxseq

w_mdi_frame.sle_msg.text = '작업지시를 조회중입니다....!!'
sYymm 	= tab_1.tabpage_1.dw_date.getitemstring(1, "gidate")
sSdate	= tab_1.tabpage_1.dw_date.getitemstring(1, "sdate")
sEdate	= tab_1.tabpage_1.dw_date.getitemstring(1, "edate")

/* 해당년월의 연동계획에 대한 최대차수 검색 */
select max(moseq) into :iMaxseq from monpln_sum 
 where sabu = :gs_sabu and monyymm = :sYymm;
tab_1.tabpage_3.dw_tabpage3_1.retrieve(gs_sabu, is_sysno)
tab_1.tabpage_2.dw_tabpage2.retrieve(gs_sabu, is_sysno, syymm, imaxseq, ssdate, sedate)

if tab_1.tabpage_2.dw_tabpage2.rowcount() > 0 then
	commit;
else
	Messagebox("일정계산", "지시할 품목이 없읍니다..!!", information!)
	w_mdi_frame.sle_msg.text = ''
	return
End if

//-------------------------------------------------------------------------------------------------------//

/* 작업지시에 대한 할당을 작성 - 단 할당생성을 check한 경우 */
w_mdi_frame.sle_msg.text = '할당내역을 적상중입니다....!!'

For Lrow = 1 to dw_tabpage2.rowcount()
	
	 sPordno = dw_tabpage2.getitemstring(Lrow, "momast_copy_pordno")
	 
	 /* 할당내역 생성이 아니면 BOM을 검색안 함 */
	 if dw_tabpage2.getitemstring(Lrow, "momast_copy_holdct") = 'N' then continue;

	/* 할당번호 채번 */
	iJ = sqlca.fun_junpyo(gs_sabu, stoday, 'B0')
	if iJ < 1 then
		rollback;
		f_message_chk(51,'[할당번호]') 
		return -1
	end if
	
	/* 할당번호작성(12자리 기준) */
	isholdno = stoday + String(iJ, '0000')	
	Commit;

	sError = 'X'
	sqlca.erp000000840_TWO(gs_sabu, spordno, isholdno, sError);
	Choose Case sError
			 Case 'X'
					Rollback;
					F_message_chk(41,'[할당내역 계산]')
					return;
			 Case 'Y'
					Rollback;
					F_message_chk(89,'[할당내역 계산]')
					return;			
	End Choose
	
	// 출고예정창고를 Update
	Update HoldsTock_copy a
		Set hold_store = (select Decode(b.ittyp, '2', :sBan, :sJaje) as chango
								  From Itemas b
								 Where b.itnbr = a.itnbr)
	 Where a.sabu = :gs_sabu and a.hold_no like :isholdno||'%';
	
Next
	
Commit;

//-------------------------------------------------------------------------------------------------------//

/* 공정별 일정에 대한 부하내역을 적상 */
w_mdi_frame.sle_msg.text = '부하내역을 적상중입니다....!!'

sError = 'X'
sqlca.erp000000820_1(gs_sabu, is_sysno, sError);
Choose Case sError
		 Case 'X'
				Rollback;
				F_message_chk(41,'[부하내역 계산]')
		 Case 'Y'
				Rollback;
				F_message_chk(89,'[부하내역 계산]')
End Choose

/* 계산내역을 저장한다 */
Commit;

/* 품목상세, 자재검토, 부하검토 사용가능 */
tab_1.tabpage_4.enabled = true
tab_1.tabpage_5.enabled = true

p_last.enabled = true
p_last.PictureName = "C:\erpman\image\작업지시_up.gif"
SetPointer(Arrow!)

w_mdi_frame.sle_msg.text = ''
tab_1.tabpage_2.setfocus()
end event

event ue_lbuttonup;call super::ue_lbuttonup;PictureName = 'C:\erpman\image\계산_up.gif'
end event

event ue_lbuttondown;call super::ue_lbuttondown;PictureName = 'C:\erpman\image\계산_dn.gif'
end event

type p_2 from uo_picture within tabpage_2
integer x = 3968
integer y = 20
integer width = 178
string picturename = "C:\erpman\image\삭제_up.gif"
end type

event clicked;call super::clicked;Long lrow

String sPordno, sMaster_parent

Lrow = dw_tabpage2.getrow()
If Lrow > 0 then
 
 if isnull(dw_tabpage2.getitemstring(lrow, "momast_copy_itnbr")) or &
  Trim(dw_tabpage2.getitemstring(lrow, "momast_copy_itnbr")) = '' then
  dw_tabpage2.deleterow(Lrow)
 else
  if Messagebox("삭제확인", "품목 -> " + dw_tabpage2.getitemstring(Lrow, "itemas_itdsc") + '~n' + &
            " 를 삭제하시겠읍니까?" + '~n' + &
            " 1:1로 된 자동 작지 내역도 동시에 삭제됩니다", question!, yesno!) = 1 then
            
   sPordno = dw_tabpage2.getitemstring(Lrow, "momast_copy_pordno")
       
   dw_tabpage2.deleterow(Lrow) 
   /* 품목 상세화면 삭제 */
   tab_1.tabpage_3.dw_tabpage3_1.deleterow(Lrow)
   tab_1.tabpage_3.dw_tabpage3_2.reset()
   
   For Lrow = 1 to dw_tabpage2.rowcount()
     sMaster_Parent = dw_tabpage2.getitemstring(Lrow, "momast_copy_pordno") 
     if sPordno = dw_tabpage2.getitemstring(Lrow, "momast_copy_master_parent") then
      dw_tabpage2.deleterow(Lrow)
      tab_1.tabpage_3.dw_tabpage3_1.deleterow(Lrow)   
      
      /* 공정내역을 삭제 */
      Delete From morout_copy   Where sabu = :gs_sabu and pordno = :sMaster_parent;
      /* 할당내역을 삭제 */
      Delete From holdstock_copy Where sabu = :gs_sabu and pordno = :sMaster_parent;
      
      Lrow = Lrow - 1
       End if
   Next
   
   /* 작업지시번호가 채번된 경우에만 삭제한다 */
   if  isnull(spordno) or trim(spordno) = '' then
   Else
    if dw_tabpage2.update() = 1 then
     /* 공정내역을 삭제 */
     Delete From morout_copy  Where sabu = :gs_sabu and pordno = :sPordno;
     /* 할당내역을 삭제 */
     Delete From holdstock_copy Where sabu = :gs_sabu and pordno = :sPordno;
     commit;
    else
     rollback;
     f_rollback()
    end if
   end if
   
  end if
 end if
end if

dw_tabpage2.setfocus()


end event

event ue_lbuttondown;call super::ue_lbuttondown;PictureName = 'C:\erpman\image\삭제_dn.gif'
end event

event ue_lbuttonup;call super::ue_lbuttonup;PictureName = 'C:\erpman\image\삭제_up.gif'
end event

type p_tabpage2_insert from uo_picture within tabpage_2
integer x = 3794
integer y = 20
integer width = 178
string picturename = "C:\erpman\image\추가_up.gif"
end type

event clicked;call super::clicked;Long   Lrow, Lrow2
String	sDepotNo, ls_mchno, ls_mchname

/* 입고예정창고 선택 */
sDepotNo = wf_DepotNo('1', '')


Lrow2		=	tab_1.tabpage_2.dw_tabpage2.GetRow()
if	Lrow2  > 0 	then
 	ls_mchno	= 	tab_1.tabpage_2.dw_tabpage2.GetItemString(Lrow2,"momast_copy_mchno")
	ls_mchname	= 	tab_1.tabpage_2.dw_tabpage2.GetItemString(Lrow2,"mchmst_mchnam")
Else
	ls_mchno =	''
End if	

/* 품목화면에 삽입 */
Lrow = 	tab_1.tabpage_2.dw_tabpage2.insertrow(0)
tab_1.tabpage_2.dw_tabpage2.SetItem(Lrow,"momast_copy_ipchango",	sDepotNo)     // 출고창고			
tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_sabu", gs_sabu)
tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_jidat", f_today())
tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_pdsts", '1')
tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_purgc", 'N')
tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "pagbn", 'N')
tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_master_no", is_sysno)
tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_mchno", ls_mchno)
tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "mchmst_mchnam", ls_mchname)

/* 그룹웨어연동여부 */
If is_gwgbn = 'Y' Then
	tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_matchk", '3')
Else
	tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_matchk", '2')
End If
/* 상세화면에 삽입 */
tab_1.tabpage_3.dw_tabpage3_1.insertrow(0)	
tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_sabu", gs_sabu)
tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_jidat", f_today())
tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_pdsts", '1')
tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_purgc", 'N')
tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "pagbn", 'N')
tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_master_no", is_sysno)
		 tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow,"momast_copy_ipchango",	sDepotNo)     // 출고창고			
tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_mchno", ls_mchno)
/* 그룹웨어연동여부 */
If is_gwgbn = 'Y' Then
	tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_matchk", '3')
Else
	tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_matchk", '2')
End If

dw_tabpage2.scrolltorow(Lrow)
dw_tabpage2.setrow(Lrow)
dw_tabpage2.setcolumn("momast_copy_porgu")
dw_tabpage2.setfocus()
end event

event ue_lbuttonup;call super::ue_lbuttonup;PictureName = 'C:\erpman\image\추가_up.gif'
end event

event ue_lbuttondown;call super::ue_lbuttondown;PictureName = 'C:\erpman\image\추가_dn.gif'
end event

type p_12 from uo_picture within tabpage_2
integer x = 3621
integer y = 20
integer width = 178
string picturename = "C:\erpman\image\요약보고_up.gif"
end type

event clicked;call super::clicked;gs_code = is_sysno

open(w_pdt_02030_7)

setnull(gs_code)
end event

event ue_lbuttonup;call super::ue_lbuttonup;PictureName = 'C:\erpman\image\요약보고_up.gif'
end event

event ue_lbuttondown;call super::ue_lbuttondown;PictureName = 'C:\erpman\image\요약보고_dn.gif'
end event

type p_auto from uo_picture within tabpage_2
integer x = 3447
integer y = 20
integer width = 178
string picturename = "C:\erpman\image\자동결과_up.gif"
end type

event clicked;call super::clicked;gs_code = is_sysno

// 자동 작업지시에 대한 결과 조회

open(w_pdt_02030_5)

setnull(gs_code)
end event

event ue_lbuttonup;call super::ue_lbuttonup;PictureName = 'C:\erpman\image\자동결과_up.gif'
end event

event ue_lbuttondown;call super::ue_lbuttondown;PictureName = 'C:\erpman\image\자동결과_dn.gif'
end event

type p_last from uo_picture within tabpage_2
integer x = 3273
integer y = 20
integer width = 178
string picturename = "C:\erpman\image\작업지시_d.gif"
end type

event clicked;call super::clicked;Long Lsqlcode

// 현재화면을 품목일반화면으로 전환(수정자료들이 Update됨)
tab_1.selecttab(2)

w_mdi_frame.sle_msg.text = '작업지시 자료를 변환중입니다......!!'

// 자료 무결성 check
INTEGER iReturn
String sColumn   
Long Lrow

iReturn = 0
iReturn = wf_requiredchk_tabpage2_final(sColumn, Lrow)
w_mdi_frame.sle_msg.text = '자료를 Check중입니다.'

If 	 iReturn = -1 then		/* 현재 화면에서 복구할 수 있는 ERROR인 경우 */
		 dw_tabpage2.setcolumn(sColumn)
		 dw_tabpage2.sCrolltorow(Lrow)
		 dw_tabpage2.setrow(Lrow)
		 dw_tabpage2.setfocus()
		 Rollback;
		 return
elseif iReturn = -2 then		/* 품목 상세화면에서 복구할 수 있는 ERROR인 경우 */
		 tab_1.tabpage_3.dw_tabpage3_1.setcolumn(sColumn)
		 tab_1.tabpage_3.dw_tabpage3_1.sCrolltoRow(Lrow)
		 tab_1.tabpage_3.dw_tabpage3_1.setRow(Lrow)
		 tab_1.selecttab(3)
		 tab_1.tabpage_3.dw_tabpage3_1.setFocus()
		 Rollback;
		 return
end if

if wf_update() = -1 then
	rollback;
	w_mdi_frame.sle_msg.text = ''
   return
end if

w_mdi_frame.sle_msg.text = '작업지시를 진행중입니다.'

if tab_1.tabpage_2.dw_tabpage2.update() = 1 then
	Commit;
Else
	Rollback;
	w_mdi_frame.sle_msg.text = ''
	f_rollback()	
	return
End if

// 작업지시 head의 내역을 저장
Insert Into momast 
	(sabu, 	pordno, 	jidat,	itnbr,	pspec,		porgu, 		pdtgu,		esdat,	eedat,
	 fsdat,	fedat,	pdqty,	roqty,	peqty,		wtqty,		waqty,		paqty,	pdsts,
	 purgc,	cvcod,	unprc,	assiqt,	pa_pordno,	pa_ospeq,	st_opseq,	system_end_date,	bajpno,	
	 crt_user, 			ipchango,stditnbr,pjt_no,		matchk,		reqno,		reqate,	pdprc,
	 holdct, routct,  timect,  mogubn,  system_str_date,
	 cnfdat, parent_pordno,    			order_no,   asseq,
	 master_no,			master_parent,		kumno,      untno,      kestno, mocnt, mchno)
 Select 
	 sabu, 	pordno, 	jidat,	itnbr,	pspec,		porgu, 		pdtgu,		esdat,	eedat,
	 fsdat,	fedat,	pdqty,	roqty,	peqty,		wtqty,		waqty,		paqty,	pdsts,
	 purgc,	cvcod,	unprc,	assiqt,	pa_pordno,	pa_ospeq,	st_opseq,	system_end_date,	bajpno,	
	 :gs_userid, 	 	ipchango,stditnbr, project_no,matchk,		reqno,		reqate,	pdprc,
	 holdct, routct,  timect,  mogubn,  system_str_date,
	 Decode(matchk, '2', to_char(sysdate, 'yyyymmdd'), null), 
	 parent_pordno,   					   order_no,   asseq,
 	 master_no,			master_parent,		kumno,      untno,      kestno, mocnt, mchno 
   from momast_copy 
  Where sabu = :gs_sabu and master_no Like :iS_sysno||'%';
  
If sqlca.sqlcode <> 0 then
	rollback;
	LSqlcode = dec(sqlca.sqlcode)
	f_message_chk(lsqlcode, "[작업지시head]")
	w_mdi_frame.sle_msg.text = ''	
	return
End if
   
// 작업지시 공정상세의 내역을 저장
Insert into morout
	(sabu,		pordno,		itnbr,		pspec,		opseq,		de_opseq,			mchcod,
	 wkctr,		jocod,		purgc,		uptgu,		esdat,		eedat,				estim,
	 esinw,		rstim,		tsinw,		ntime,		lastc,		fsdat,				fedat,
	 roqty,		faqty,		suqty,		peqty,		coqty,		paqty,				nedat,
	 ladat,		wicvcod,		wiunprc,		pr_opseq,	do_opseq,	system_end_date,	bajpno,
	 rmks,		watims,		sttim,		esset,		esman,		esmch,				esgbn,
	 rsset,		rsman,		rsmch,		qcgub,		opdsc,		roslt,				system_str_date,	qcgin,  stdmn,
	 master_no) 
 Select 
	 sabu,		pordno,		itnbr,		pspec,		opseq,		de_opseq,			mchcod,
	 wkctr,		jocod,		purgc,		uptgu,		esdat,		eedat,				estim,
	 esinw,		rstim,		tsinw,		ntime,		lastc,		fsdat,				fedat,
	 roqty,		faqty,		suqty,		peqty,		coqty,		paqty,				nedat,
	 ladat,		wicvcod,		wiunprc,		pr_opseq,	do_opseq,	system_end_date,	bajpno,
	 rmks,		watims,		sttim,		esset,		esman,		esmch,				esgbn,
	 rsset,		rsman,		rsmch,		qcgub,		opdsc,		roslt,				system_str_date,	qcgin,  nvl(stdmn, 1),
	 master_no
 	From Morout_copy
  Where sabu = :gs_sabu and master_no Like :iS_sysno||'%';
  
If sqlca.sqlcode <> 0 then
	rollback;
	LSqlcode = dec(sqlca.sqlcode)
	f_message_chk(lsqlcode, "[작업지시공정]")
	w_mdi_frame.sle_msg.text = ''		
	return
End if

// 할당내역을 저장
Insert into holdstock
	(sabu,		hold_no,		hold_date,		hold_gu,		itnbr,		pspec,		hold_qty,
	 addqty,		isqty,		unqty,			hold_store,	out_store,	req_dept,	rqdat,
	 isdat,		order_no,	pordno,			out_chk,		naougu,		in_store,	pjtno,
	 hosts,		opseq,		cancelqty,     buwan,      crt_user,	hyebia4,		lotno,
	 hyebia3,	hyebin4)
 Select 
	 sabu,		hold_no,		hold_date,		hold_gu,		itnbr,		pspec,		hold_qty,
	 0,			0,				0,					hold_store,	out_store,	req_dept,	rqdat,
	 isdat,		order_no,	pordno,			out_chk,		naougu,		in_store,	pjtno,
	 hosts,		opseq,		0,  			   'N',        :gs_userid,	area_cd,		lotno,
	 field_cd,  heybin4 
 	From holdstock_copy
  Where sabu = :gs_sabu and master_no Like :iS_sysno||'%';
  
If sqlca.sqlcode <> 0 then
	rollback;
	LSqlcode = dec(sqlca.sqlcode)
	f_message_chk(lsqlcode, "[할당내역]")
	w_mdi_frame.sle_msg.text = ''		
	return
End if

// 외주 발주예정 내역을 저장
String sError
sError = 'X';

w_mdi_frame.sle_msg.text = '외주 발주예정내역을 생성중입니다....!!'
sError = 'X'
sqlca.erp000000850(gs_sabu, is_sysno, sError);
w_mdi_frame.sle_msg.text = ''
Choose Case sError
		 Case 'X'
				w_mdi_frame.sle_msg.text = ''
				F_message_chk(41,'[발주예정내역 계산]')
				Rollback;
				return 
		 Case 'Y'
				w_mdi_frame.sle_msg.text = ''
				F_message_chk(89,'[발주예정내역 계산]')
				Rollback;
				return 
End Choose

Commit;

String 	ls_saupj
ls_saupj	= dw_saupj.GetItemString(1,"saupj")

/* 수주연결을 자동으로 한다. */
w_mdi_frame.sle_msg.text = '수주연결을 자동으로 생성중입니다....!!'
sError = 'X'

sqlca.erp000000860(gs_sabu, ls_saupj,  is_sysno, sError);
w_mdi_frame.sle_msg.text = ''
Choose Case sError
		 Case 'X'
				w_mdi_frame.sle_msg.text = ''
			   MessageBox("확 인", "수주연결 자동생성을 실패 하였습니다", stopsign!)
		 Case 'Y'
				w_mdi_frame.sle_msg.text = ''
			   MessageBox("확 인", "수주연결 자동생성을 실패 하였습니다", stopsign!)
End Choose

/* 그룹웨어 연동시 */
If is_gwgbn = 'Y' Then
	Long 	ix, nCnt= 0
	
	For ix = 1 to tab_1.tabpage_2.dw_tabpage2.RowCount()
		If tab_1.tabpage_2.dw_tabpage2.GetItemString(ix, "momast_copy_matchk") = '3' Then
			ncnt += 1
			Exit
		End If
	Next

//http://61.97.119.235:81/WBCGI/WBAuthPass.asp?userid_erp=bds&FolderId=0000000070&SABU=1&PORDNO=200304010004001&RFCOD=03&MATCHK=1&ERPTITLE=작업지시입

	/* 전자결제 상신 */
	IF is_gwgbn = 'Y' then
		gs_code  = "&SABU=1&PORDNO="+iS_sysno+"&RFCOD=03&matchk=1"		//작지번호
		gs_gubun = '0000000070'														//그룹웨어 문서번호
		gs_codename = '작업지시서'													//제목입력받음
		
		WINDOW LW_WINDOW
		OpenSheetWithParm(lw_window, 'w_groupware_browser', 'w_groupware_browser', w_mdi_frame, 0, Layered!)
		//Open(w_groupware_browser)
		
		/* 결제상신하지 않을 경우 */
//		If gs_code = 'N' or gs_code = 'C' Then		
//			UPDATE MOMAST
//				SET MATCHK = '1'
//			 WHERE SABU = :gs_sabu
//				AND PORDNO LIKE :iS_sysno||'%'
//				AND MATCHK = '3';
//			If sqlca.sqlcode <> 0 Then
//				RollBack;
//				MessageBox('확 인','결제정보 변경에 실패하였습니다.!!')
//				wf_reset()
//				Return
//			End If
//		End If
	END IF

End If

commit;

w_mdi_frame.sle_msg.text = ''
//Messagebox("작업지시", "작업지시를 저장하였읍니다", information!)

wf_reset()
end event

event ue_lbuttonup;call super::ue_lbuttonup;PictureName = 'C:\erpman\image\작업지시_up.gif'
end event

event ue_lbuttondown;call super::ue_lbuttondown;PictureName = 'C:\erpman\image\작업지시_dn.gif'
end event

type dw_tabpage2 from datawindow within tabpage_2
event ue_processenter pbm_dwnprocessenter
event ue_key pbm_dwnkey
integer x = 46
integer y = 200
integer width = 4439
integer height = 1812
integer taborder = 40
boolean bringtotop = true
string dataobject = "d_pdt_02030_13_TWO"
boolean hscrollbar = true
boolean vscrollbar = true
boolean border = false
boolean hsplitscroll = true
boolean livescroll = true
end type

event ue_processenter;Send(Handle(this),256,9,0)
Return 1
end event

event ue_key;Long lrow
lrow = this.getrow()

if keydown(keyf1!) then
	this.triggerevent(rbuttondown!)
end if

IF keydown(keyF2!) THEN
	IF This.GetColumnName() = "momast_copy_itnbr" Then
		open(w_itemas_popup2)
		if isnull(gs_code) or gs_code = "" then return
		
		this.SetItem(this.getrow(),"momast_copy_itnbr",gs_code)
		this.TriggerEvent(ItemChanged!)
	end if
END IF

end event

event itemchanged;string   snull, sitnbr, sreff, sreff1, sitdsc, sispec, sjijil, sispec_code, scvcod, &
			sdptno, spurgc, sporgu, scvnas, stuncu, sIogbn, sDptstock, sPordno
long     lrow, Lrow1, Lchk 
integer  ireturn
Decimal  {5} dunprc, dcnt, dyoqty
String 	ls_pspec, usechk

setnull(snull)

lrow   = getrow()
accepttext()

/* 작업지시구분 check */
Choose Case  Getcolumnname()
	Case "momast_copy_porgu" 
		tab_1.tabpage_2.p_last.enabled = false
		tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_porgu", gettext())
		if isnull(f_get_reffer('60', gettext())) then
			f_message_chk(79,'[작업지시구분]') 
			setitem(lrow, "momast_copy_porgu", '')
			tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_porgu", '')
			RETURN  1
		END IF
	
		setitem(lrow, "pagbn", 'N')		
		setitem(lrow, "momast_copy_purgc", 'N')
		setitem(lrow, "momast_copy_pa_pordno", '')
		setitem(lrow, "momast_copy_pa_ospeq", '')
		setitem(lrow, "momast_copy_st_opseq", '')
		setitem(lrow, "momast_copy_cvcod", '')
		setitem(lrow, "vndmst_cvnas2", '')
		setitem(lrow, "momast_copy_unprc", 0)	
		
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "pagbn", 'N')		
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_purgc", 'N')
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_pa_pordno", '')
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_pa_ospeq", '')
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_st_opseq", '')
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_cvcod", '')
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "vndmst_cvnas2", '')
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_unprc", 0)
	Case  	"momast_copy_purgc"								// 외주구분
		tab_1.tabpage_2.p_last.enabled = false	
		tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
		sPordno = getitemstring(Lrow, "momast_copy_pordno")
		
		if gettext() = 'N' then
			
			tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_purgc", 'N')		
			
			// 외주가 아닌 경우에는 자재 출고 구분을 자동출고 구분을 Setting한다.		
			Select Iogbn Into :sIogbn from iomatrix where sabu = '1' and autpdt = 'Y';
			if sqlca.sqlcode <> 0 then
				setitem(lrow, "momast_copy_purgc", 'N')
				Messagebox("생산출고", "자동출고용 수불구분을 검색할 수 없읍니다", stopsign!)
				return 1
			end if
			
			sDptno = getitemstring(lrow, "momast_copy_pdtgu")
			
			select cvcod   into :sCvcod
			  from vndmst where cvgu = '5' and jumaeip = :sDptno;
				
			Update Holdstock_copy
				Set out_store = :sCvcod,
					 Hold_gu	  = :sIogbn
			 Where sabu = :gs_sabu and Pordno = :sPordno;
					
			Commit;	
			
			// 외주 내역을 clear
			setitem(lrow, "momast_copy_cvcod",  snull)
			setitem(lrow, "vndmst_cvnas2", snull)
			setitem(lrow, "momast_copy_unprc",  0)			
			
			tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_cvcod",  snull)
			tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "vndmst_cvnas2", snull)
			tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_unprc",  0)
			
			// 전체외주인 경우에는 공정생성및 시간계산을 제외한다.
			tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_routct", 'Y')
			tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_timect", 'Y')						
			
		Else				/* 외주		*/
			
			tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_purgc", 'Y')
			sitnbr 		= getitemstring(lrow, "momast_copy_itnbr")
			ls_pspec = getitemstring(lrow, "momast_copy_pspec")
			f_buy_unprc(sitnbr, ls_pspec, '9999', scvcod, scvnas, dUnprc, sTuncu)
			
			// 외주인 경우에는 자재 출고 구분을 외주출고 구분을 Setting한다.
			Select Iogbn Into :sIogbn from iomatrix where sabu = '1' and autvnd = 'Y';
			if sqlca.sqlcode <> 0 then
				setitem(lrow, "momast_copy_purgc", 'N')
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_purgc", 'N')
				Messagebox("사급출고", "사급출고용 수불구분을 검색할 수 없읍니다", stopsign!)
				return 1
			end if
			Update Holdstock_copy
				Set out_store = :sCvcod,
					 Hold_gu	  = :sIogbn
			 Where sabu = :gs_sabu and Pordno = :sPordno;
			Commit;
			
			if isnull(getitemstring(Lrow, "momast_copy_itnbr")) or trim(getitemstring(Lrow, "momast_copy_itnbr")) = '' then
				setitem(lrow, "momast_copy_cvcod",  snull)
				setitem(lrow, "vndmst_cvnas2", snull)
				setitem(lrow, "momast_copy_unprc",  0)			
				
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_cvcod",  snull)
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "vndmst_cvnas2", snull)
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_unprc",  0)
			Else
				setitem(lrow, "momast_copy_cvcod",  scvcod)
				setitem(lrow, "vndmst_cvnas2", scvnas)
				setitem(lrow, "momast_copy_unprc",  dUnprc)			
				
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_cvcod",  scvcod)
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "vndmst_cvnas2", scvnas)
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_unprc",  dUnprc)		
			End if;
			
			// 전체외주인 경우에는 공정생성및 시간계산을 제외한다.
			setitem(Lrow, "momast_copy_routct", 'N')
			setitem(Lrow, "momast_copy_timect", 'N')
		end if	
	Case	"pagbn"										// 작업지시 분할
		 /* 사양개조 */
		 tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "pagbn", getitemstring(lrow, "pagbn"))		
	Case 	"momast_copy_itnbr"	
		tab_1.tabpage_2.p_last.enabled = false
		tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
		sItnbr = trim(GetText())
		/* 2003.12.06  사용중 & 단종은 작업지시 불가(익태) */
		Select useyn
		  into :usechk
		  From itemas
		 where itnbr = :sItnbr
		 using sqlca;
			 if sqlca.sqlcode = 0 and (usechk = '1' or usechk = '2' ) then
				 f_message_chk(53,'[사용중지 및 단종]') 
				 setitem(tab_1.tabpage_2.dw_tabpage2.getrow(), "momast_copy_itnbr", '')	
				 SetColumn("momast_copy_itnbr")
				 SetFocus()
				 Return 1
			 else
					ireturn = f_get_name4('품번', 'Y', sitnbr, sitdsc, sispec, sjijil, sispec_code)
					setitem(lrow, "momast_copy_itnbr", sitnbr)	
					setitem(lrow, "itemas_itdsc", sitdsc)	
					setitem(lrow, "itemas_ispec", sispec)
					setitem(lrow, "itemas_jijil", sjijil)	
					setitem(lrow, "itemas_ispec_code", sispec_code)
					
					tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_itnbr", sitnbr)	
					tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "itemas_itdsc", sitdsc)	
					tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "itemas_ispec", sispec)	
					
					select fun_get_pdtgu(:sitnbr, '1') into :sdptno 
					from dual;	
					setitem(lrow, "momast_copy_pdtgu", sdptno)
					
					tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_pdtgu", sdptno)
					
					wf_item_check(lrow, sitnbr, ls_pspec ,'9999')
					RETURN ireturn
			 end if
	Case 	"itemas_itdsc"
		tab_1.tabpage_2.p_last.enabled = false
		tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
		sItdsc = trim(GetText())
		ireturn = f_get_name4('품명', 'Y', sitnbr, sitdsc, sispec, sjijil, sispec_code)
		setitem(lrow, "momast_copy_itnbr", sitnbr)	
		setitem(lrow, "itemas_itdsc", sitdsc)	
		setitem(lrow, "itemas_ispec", sispec)
		setitem(lrow, "itemas_jijil", sjijil)	
		setitem(lrow, "itemas_ispec_code", sispec_code)
		
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_itnbr", sitnbr)	
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "itemas_itdsc", sitdsc)	
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "itemas_ispec", sispec)	
		
		select fun_get_pdtgu(:sitnbr, '1') into :sdptno 
		from dual;	
		setitem(lrow, "momast_copy_pdtgu", sdptno)	
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_pdtgu", sdptno)
		
		wf_item_check(lrow, sitnbr,ls_pspec, '9999')
		RETURN ireturn
	Case 	"itemas_ispec"	
		tab_1.tabpage_2.p_last.enabled = false
		tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
		sIspec = trim(GetText())
		ireturn = f_get_name4('규격', 'Y', sitnbr, sitdsc, sispec, sjijil, sispec_code)
		setitem(lrow, "momast_copy_itnbr", sitnbr)	
		setitem(lrow, "itemas_itdsc", sitdsc)	
		setitem(lrow, "itemas_ispec", sispec)
		setitem(lrow, "itemas_jijil", sjijil)	
		setitem(lrow, "itemas_ispec_code", sispec_code)
		
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_itnbr", sitnbr)	
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "itemas_itdsc", sitdsc)	
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "itemas_ispec", sispec)	
		
		select fun_get_pdtgu(:sitnbr, '1') into :sdptno 
		from dual;	
		setitem(lrow, "momast_copy_pdtgu", sdptno)	
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_pdtgu", sdptno)		
		
		wf_item_check(lrow, sitnbr, ls_pspec, '9999')
		RETURN ireturn
	Case "itemas_jijil"
		tab_1.tabpage_2.p_last.enabled = false
		tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
		sjijil = trim(GetText())
		ireturn = f_get_name4('재질', 'Y', sitnbr, sitdsc, sispec, sjijil, sispec_code)
		setitem(lrow, "momast_copy_itnbr", sitnbr)	
		setitem(lrow, "itemas_itdsc", sitdsc)	
		setitem(lrow, "itemas_ispec", sispec)
		setitem(lrow, "itemas_jijil", sjijil)	
		setitem(lrow, "itemas_ispec_code", sispec_code)
		
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_itnbr", sitnbr)	
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "itemas_itdsc", sitdsc)	
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "itemas_ispec", sispec)	
		
		select fun_get_pdtgu(:sitnbr, '1') into :sdptno 
		from dual;	
		setitem(lrow, "momast_copy_pdtgu", sdptno)	
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_pdtgu", sdptno)		
		
		wf_item_check(lrow, sitnbr, ls_pspec, '9999')
		RETURN ireturn
	Case 	"itemas_ispec_code"	
		tab_1.tabpage_2.p_last.enabled = false
		tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
		sispec_code = trim(GetText())
		ireturn = f_get_name4('규격코드', 'Y', sitnbr, sitdsc, sispec, sjijil, sispec_code)
		setitem(lrow, "momast_copy_itnbr", sitnbr)	
		setitem(lrow, "itemas_itdsc", sitdsc)	
		setitem(lrow, "itemas_ispec", sispec)
		setitem(lrow, "itemas_jijil", sjijil)	
		setitem(lrow, "itemas_ispec_code", sispec_code)
		
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_itnbr", sitnbr)	
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "itemas_itdsc", sitdsc)	
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "itemas_ispec", sispec)	
		
		select fun_get_pdtgu(:sitnbr, '1') into :sdptno 
		from dual;	
		setitem(lrow, "momast_copy_pdtgu", sdptno)	
		tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_pdtgu", sdptno)		
		
		wf_item_check(lrow, sitnbr, ls_pspec, '9999')
		RETURN ireturn
	Case 	"momast_copy_pspec"  
		if 	isnull(gettext()) or trim(gettext()) = '' then
			setitem(Lrow, "momast_copy_pspec", '.')
			return 2
		end if	
	
		tab_1.tabpage_2.p_last.enabled = false
		tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
		tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_pspec", gettext())	
		sPordno 	= getitemstring(Lrow, "momast_copy_pordno")
		spurgc 	= getitemstring(Lrow, "momast_copy_purgc")
		
		if spurgc = 'N' then
			
			tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_purgc", 'N')		
			
			// 외주가 아닌 경우에는 자재 출고 구분을 자동출고 구분을 Setting한다.		
			Select Iogbn Into :sIogbn from iomatrix where sabu = '1' and autpdt = 'Y';
			if sqlca.sqlcode <> 0 then
				setitem(lrow, "momast_copy_purgc", 'N')
				Messagebox("생산출고", "자동출고용 수불구분을 검색할 수 없읍니다", stopsign!)
				return 1
			end if
			
			sDptno = getitemstring(lrow, "momast_copy_pspec")
			
			Update Holdstock_copy
				Set pspec = :sDptno
			 Where sabu = :gs_sabu and Pordno = :sPordno;
					
			Commit;	
			
			// 외주 내역을 clear
			setitem(lrow, "momast_copy_cvcod",  snull)
			setitem(lrow, "vndmst_cvnas2", snull)
			setitem(lrow, "momast_copy_unprc",  0)			
			
			tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_cvcod",  snull)
			tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "vndmst_cvnas2", snull)
			tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_unprc",  0)
			
			// 전체외주인 경우에는 공정생성및 시간계산을 제외한다.
			tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_routct", 'Y')
			tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_timect", 'Y')						
			
		Else				/* 외주		*/
			tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_purgc", 'Y')
			sitnbr 		= getitemstring(lrow, "momast_copy_itnbr")
			ls_pspec = getitemstring(lrow, "momast_copy_pspec")
			f_buy_unprc(sitnbr, ls_pspec, '9999', scvcod, scvnas, dUnprc, sTuncu)
			
			// 외주인 경우에는 자재 출고 구분을 외주출고 구분을 Setting한다.
			Select Iogbn Into :sIogbn from iomatrix where sabu = '1' and autvnd = 'Y';
			if sqlca.sqlcode <> 0 then
				setitem(lrow, "momast_copy_purgc", 'N')
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_purgc", 'N')
				Messagebox("사급출고", "사급출고용 수불구분을 검색할 수 없읍니다", stopsign!)
				return 1
			end if
			Update Holdstock_copy
				Set out_store 	= :sCvcod,
					 Hold_gu		= :sIogbn,
					 pspec		= :ls_pspec
			 Where sabu = :gs_sabu and Pordno = :sPordno;
			Commit;
			
			if isnull(getitemstring(Lrow, "momast_copy_itnbr")) or trim(getitemstring(Lrow, "momast_copy_itnbr")) = '' then
				setitem(lrow, "momast_copy_cvcod",  snull)
				setitem(lrow, "vndmst_cvnas2", snull)
				setitem(lrow, "momast_copy_unprc",  0)			
				
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_cvcod",  snull)
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "vndmst_cvnas2", snull)
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_unprc",  0)
			Else
				setitem(lrow, "momast_copy_cvcod",  scvcod)
				setitem(lrow, "vndmst_cvnas2", scvnas)
				setitem(lrow, "momast_copy_unprc",  dUnprc)			
				
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_cvcod",  scvcod)
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "vndmst_cvnas2", scvnas)
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_unprc",  dUnprc)		
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_pspec",  ls_pspec)		
			End if;
			
			// 전체외주인 경우에는 공정생성및 시간계산을 제외한다.
			setitem(Lrow, "momast_copy_routct", 'N')
			setitem(Lrow, "momast_copy_timect", 'N')
		end if	
	Case 	"momast_copy_pdqty"  
	//	tab_1.tabpage_2.p_last.enabled = false
	//	tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
		tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_pdqty", dec(gettext()))
		if dec(gettext()) < 1 then
			f_message_chk(78,'[지시수량]') 
			setitem(Lrow, "momast_copy_pdqty", 0)
			tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_pdqty", 0)		
			RETURN  1	
		end if
	Case 	"momast_copy_esdat" 
		tab_1.tabpage_2.p_last.enabled = false
		tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
		tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_esdat", gettext())	
		tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_fsdat", gettext())
		setitem(lrow, "momast_copy_fsdat", gettext())	
		if isnull(gettext()) or trim(gettext()) = '' then
			return
		end if
		if f_datechk(gettext()) = -1 then
			f_message_chk(35,'[생산시작일]') 
			tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_esdat", '')
			tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_fsdat", '')
			setitem(lrow, "momast_copy_esdat", '')
			setitem(lrow, "momast_copy_fsdat", '')
			RETURN  1			
		end if
	Case 	"momast_copy_eedat" 
		tab_1.tabpage_2.p_last.enabled = false
		tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
		tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_eedat", gettext())
		tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_fedat", gettext())
		setitem(lrow, "momast_copy_fedat", gettext())
		if isnull(gettext()) or trim(gettext()) = '' then
			return
		end if
		if 	f_datechk(gettext()) = -1 then
			f_message_chk(35,'[생산종료일]') 
			tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_eedat", '')
			tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_fedat", '')
			setitem(lrow, "momast_copy_eedat", '')
			setitem(lrow, "momast_copy_fedat", '')
			RETURN  1			
		end if
		if 	getitemstring(lrow, "momast_copy_esdat") > getitemstring(lrow, "momast_copy_eedat") then
			f_message_chk(35,'[생산종료일]') 
			tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_eedat", '')
			tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_fedat", '')
			setitem(lrow, "momast_copy_eedat", '')
			setitem(lrow, "momast_copy_fedat", '')		
			RETURN  1			
		end if
	Case 	"momast_copy_matchk" 
		tab_1.tabpage_3.dw_tabpage3_1.setitem(Lrow, "momast_copy_matchk", gettext())	
	Case 	"momast_copy_routct" 
		sReff   = gettext()
		sPordno = getitemstring(Lrow, "momast_copy_pordno")
		Lchk    = 0
	
	// 최초 작업지시인 경우에 공정이 없으면 Error
		/*	If sREff = 'N' then
				Select count(*) into :Lchk From morout_copy
				 Where Sabu = :gs_sabu And pordno = :sPordno;
				If Lchk < 1 then
					MessageBox("공정선택", "최초 작업지시인 경우에는 공정선택이 되어야 합니다", stopsign!)
					Setitem(Lrow, "momast_copy_routct", 'Y')
					Setitem(Lrow, "momast_copy_timect", 'Y')			
					return 1
				End if
			End if */
	Case 	"momast_copy_mocnt" 
		dcnt   = dec(gettext())
		dyoqty = getitemdecimal(Lrow, "yoqty")
		
		if	dyoqty = 0 or IsNull(dyoqty) Then

			/* 수량을 기준으로 설비별 투입량을 계산하여 적정 횟수 및 수량을 계산 */
			sItnbr = getitemstring(Lrow, "momast_copy_itnbr")
			sreff  = getitemstring(Lrow, "momast_copy_mchno")
			dcnt   = getitemdecimal(Lrow, "momast_copy_mocnt")
			
			Select Nvl(yoqty, 0) into :dyoqty
			From pstmch
			Where itnbr = :sitnbr 
			And mchno = :sreff;
		  
			If sqlca.sqlcode = 0 and dyoqty > 0 then
				this.setitem(Lrow, "momast_copy_pdqty", dcnt * dyoqty)
				this.setitem(Lrow, "yoqty", dyoqty)
			Else
				Setnull( sreff  )
				Setnull( sreff1 )		 
				this.setitem(Lrow, "momast_copy_mocnt", 0)
				this.setitem(Lrow, "momast_copy_pdqty", 0)
				this.setitem(Lrow, "yoqty", 0)		 
				Messagebox("설비", "1회 생산량을 먼저 등록하세요", stopsign!)
				return 1
			End if
		
		End If
		
//		dyoqty = getitemdecimal(Lrow, "yoqty")
		dunprc = dcnt * dyoqty
		this.setitem(Lrow, "momast_copy_pdqty", dunprc)
	Case "momast_copy_mchno" 
		ireturn = 0
		sreff = this.gettext()
		
		if isnull(sreff) or trim(sreff) = '' then
			this.setitem(lrow, "mchmst_mchnam", snull)
			return
		end if
		select mchnam
		  into :sreff1
		  from mchmst
		 where sabu = :gs_sabu and mchno = :sreff;
		if sqlca.sqlcode <> 0 then
			f_message_chk(92,'[설비]')
			setnull(sreff)
			setnull(sreff1)
			ireturn = 1
		end if
		
		 /* 수량을 기준으로 설비별 투입량을 계산하여 적정 횟수 및 수량을 계산 */
		 sItnbr = getitemstring(Lrow, "momast_copy_itnbr")
		 dcnt   = getitemdecimal(Lrow, "momast_copy_mocnt")
		 Select Nvl(yoqty, 0) into :dyoqty
			From pstmch
		  Where itnbr = :sitnbr And mchno = :sreff;
		 If sqlca.sqlcode = 0 and dyoqty > 0 then
			 this.setitem(Lrow, "momast_copy_pdqty", dcnt * dyoqty)
			 this.setitem(Lrow, "yoqty", dyoqty)
		 Else
			 Setnull( sreff  )
			 Setnull( sreff1 )		 
			 this.setitem(Lrow, "momast_copy_mocnt", 0)
			 this.setitem(Lrow, "momast_copy_pdqty", 0)
			 this.setitem(Lrow, "yoqty", 0)		 
			 Messagebox("설비", "1회 생산량을 먼저 등록하세요", stopsign!)
			 return 1
		 End if
		
		this.setitem(lrow, "momast_copy_mchno",  sreff)
		this.setitem(lrow, "mchmst_mchnam", sreff1)
		return ireturn		
End Choose

end event

event dberror;//String  sMsg, sErrorcode, sErrorsyntax, sReturn, sNewline
//Integer iPos, iCount
//
//iCount			= 0
//sNewline			= '~r'
//sReturn			= '~n'
//sErrorcode 		= Left(sqlerrtext, 9)
//iPos 		  		= Len(sqlerrtext) - Pos(sqlerrtext, "No changes made to database.", 1)
//sErrorSyntax	= tRIM(Mid(sqlerrtext, 11, Len(sqlerrtext) - iPos - 11))
//
//For iPos = Len(sErrorSyntax) to 1 STEP -1
//	 sMsg = Mid(sErrorSyntax, ipos, 1)
//	 If sMsg   = sReturn or sMsg = sNewline Then
//		 iCount++
//	 End if
//Next
//
//sErrorSynTax  	= Left(sErrorSyntax, Len(sErrorsyntax) - iCount)
//
//
//str_db_error db_error_msg
//db_error_msg.rowno 	 				= row
//db_error_msg.errorcode 				= sErrorCode
//db_error_msg.errorsyntax_system	= sErrorSyntax
//db_error_msg.errorsyntax_user		= sErrorSyntax
//db_error_msg.errorsqlsyntax			= sqlsyntax
//OpenWithParm(w_error, db_error_msg)
//
//
///*sMsg = "Row No       -> " + String(row) 			 + '~n' + &
//		 "Error Code   -> " + sErrorcode			    + '~n' + &
//		 "Error Syntax -> " + sErrorSyntax			 + '~n' + &
//		 "SqlSyntax    -> " + Sqlsyntax
//	MESSAGEBOX("자료처리중 오류발생", sMsg) */
//
//RETURN 1
end event

event editchanged;ib_any_typing =True

if not (getcolumnname() = "momast_copy_pdqty" or getcolumnname() = "momast_copy_matchk") then
   tab_1.tabpage_2.p_last.enabled = false
	tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
end if

end event

event itemerror;return 1
end event

event rbuttondown;String colname, snull
Long   lrow

SetNull(gs_gubun)
SetNull(gs_code)
SetNull(gs_codename)
SetNull(sNull)

colname = this.getcolumnname()
lrow	  = this.getrow()
if this.accepttext() = -1 then return

if colname = "momast_copy_itnbr" or colname = "itemas_itdcs" or colname = "itemas_ispec" then
   gs_code = this.getitemstring(lrow, "momast_copy_itnbr")
	open(w_itemas_popup)
	
	if isnull(gs_code) or gs_code = "" then return
	
	this.SetItem(lrow,"momast_copy_itnbr",gs_code)
	this.TriggerEvent(ItemChanged!)
elseif colname = "momast_copy_mchno" then
		 open(w_mchmst_popup)
		 if isnull(gs_code) or gs_code = "" then 
			 this.setitem(lrow, "mchmst_mchnam", sNull)
			 return
		 End if
		 this.setitem(lrow, "momast_copy_mchno", gs_code)
		 this.triggerevent(itemchanged!)	
end if

end event

event updatestart;/* Update() function 호출시 user 설정 */
long k, lRowCount

lRowCount = this.RowCount()

FOR k = 1 TO lRowCount
   IF NewModified! = this.GetItemStatus(k, 0, Primary!) THEN
 	   This.SetItem(k,'crt_user',gs_userid)
   ELSEIF DataModified! = this.GetItemStatus(k, 0, Primary!) THEN 		
	   This.SetItem(k,'upd_user',gs_userid)
   END IF	  
NEXT


end event

event doubleclicked;Long Lrow

Lrow = getrow()

if Lrow <  1 then return

gs_code 		= getitemstring(Lrow, "momast_copy_itnbr")
gs_codename = getitemstring(Lrow, "itemas_itdsc")

if isnull(gs_code) or trim(gs_code) = '' or isnull(gs_codename) or trim(gs_codename) = '' then
	return
end if


open(w_pdt_04000_1)

setnull(gs_code)
setnull(gs_codename)
end event

type st_pordno from statictext within tabpage_2
integer x = 59
integer y = 76
integer width = 1138
integer height = 52
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = hangeul!
fontpitch fontpitch = fixed!
fontfamily fontfamily = modern!
string facename = "굴림체"
long textcolor = 8388608
long backcolor = 33027312
boolean enabled = false
string text = "[ 지시번호 ]"
boolean focusrectangle = false
end type

type rr_9 from roundrectangle within tabpage_2
long linecolor = 28144969
integer linethickness = 1
long fillcolor = 33027312
integer x = 32
integer y = 44
integer width = 1189
integer height = 116
integer cornerheight = 40
integer cornerwidth = 55
end type

type tabpage_3 from userobject within tab_1
event create ( )
event destroy ( )
integer x = 18
integer y = 108
integer width = 4521
integer height = 2040
boolean enabled = false
long backcolor = 32106727
string text = "품목"
long tabtextcolor = 33554432
long tabbackcolor = 32106727
long picturemaskcolor = 553648127
rr_6 rr_6
rr_5 rr_5
p_8 p_8
p_7 p_7
p_9 p_9
p_11 p_11
p_10 p_10
dw_tabpage3_1 dw_tabpage3_1
dw_tabpage3_2 dw_tabpage3_2
end type

on tabpage_3.create
this.rr_6=create rr_6
this.rr_5=create rr_5
this.p_8=create p_8
this.p_7=create p_7
this.p_9=create p_9
this.p_11=create p_11
this.p_10=create p_10
this.dw_tabpage3_1=create dw_tabpage3_1
this.dw_tabpage3_2=create dw_tabpage3_2
this.Control[]={this.rr_6,&
this.rr_5,&
this.p_8,&
this.p_7,&
this.p_9,&
this.p_11,&
this.p_10,&
this.dw_tabpage3_1,&
this.dw_tabpage3_2}
end on

on tabpage_3.destroy
destroy(this.rr_6)
destroy(this.rr_5)
destroy(this.p_8)
destroy(this.p_7)
destroy(this.p_9)
destroy(this.p_11)
destroy(this.p_10)
destroy(this.dw_tabpage3_1)
destroy(this.dw_tabpage3_2)
end on

type rr_6 from roundrectangle within tabpage_3
long linecolor = 28144969
integer linethickness = 1
long fillcolor = 32106727
integer x = 23
integer y = 1000
integer width = 4480
integer height = 1028
integer cornerheight = 40
integer cornerwidth = 55
end type

type rr_5 from roundrectangle within tabpage_3
long linecolor = 28144969
integer linethickness = 1
long fillcolor = 33027312
integer x = 23
integer y = 180
integer width = 4480
integer height = 804
integer cornerheight = 40
integer cornerwidth = 55
end type

type p_8 from uo_picture within tabpage_3
integer x = 4315
integer y = 20
integer width = 178
boolean originalsize = true
string picturename = "C:\erpman\image\제품할당_up.gif"
end type

event clicked;call super::clicked;str_02030 parm02030

Long Lrow

tab_1.selecttab(3)
Lrow = tab_1.tabpage_3.dw_tabpage3_1.getrow()
	
if Lrow < 1 then
	Messagebox("제품선택", "제품내역이 선택되어 있지않읍니다" + '~n' + &
								  "작업지시 내역을 Mouse로 Click후 Button을 Click하십시요!", &
								  Stopsign!)
   tab_1.tabpage_3.dw_tabpage3_1.setfocus()
	return
end if

if tab_1.tabpage_3.dw_tabpage3_1.getitemstring(Lrow, "pagbn") = 'N' then
	Messagebox("작업지시", "사양개조용 작업지시가 아닙니다" + '~n' + &
								  "사양개조용 작업지시 내역을 Mouse로 Click후 Button을 Click하십시요!", &
								  Stopsign!)
   tab_1.tabpage_3.dw_tabpage3_1.setfocus()
	return	
end if

parm02030.dwname 		= tab_1.tabpage_3.dw_tabpage3_1
parm02030.sitdsc  	= tab_1.tabpage_3.dw_tabpage3_1.getitemstring(Lrow, "itemas_itdsc")

openwithparm(w_pdt_02030_4, parm02030)
Commit;

tab_1.tabpage_3.dw_tabpage3_1.setfocus()
end event

event ue_lbuttonup;call super::ue_lbuttonup;PictureName = 'C:\erpman\image\제품할당_up.gif'
end event

event ue_lbuttondown;call super::ue_lbuttondown;PictureName = 'C:\erpman\image\제품할당_dn.gif'
end event

type p_7 from uo_picture within tabpage_3
integer x = 4142
integer y = 20
integer width = 178
string picturename = "C:\erpman\image\부하계산_up.gif"
end type

event clicked;call super::clicked;int rtn
string spordno

sPordno = tab_1.tabpage_3.dw_tabpage3_2.getitemstring(1, "morout_copy_pordno")

SetPointer(HourGlass!)
/* 공정별 일정에 대한 부하내역을 적상 */
w_mdi_frame.sle_msg.text = '공정별 부하내역을 계산중입니다....!!'

rtn = sqlca.erp000000810_2(gs_sabu, is_sysno, spordno);
w_mdi_frame.sle_msg.text = ''
If rtn = -1 then
	F_message_chk(41,'[공정별 부하계산]')
	Rollback;
	return;
End if

Commit;

SEtpointer(Arrow!)



end event

event ue_lbuttonup;call super::ue_lbuttonup;PictureName = 'C:\erpman\image\부하계산_up.gif'
end event

event ue_lbuttondown;call super::ue_lbuttondown;PictureName = 'C:\erpman\image\부하계산_dn.gif'
end event

type p_9 from uo_picture within tabpage_3
integer x = 3968
integer y = 20
integer width = 178
string picturename = "C:\erpman\image\공정삭제_up.gif"
end type

event clicked;call super::clicked;Long Lrow
String sOpdsc, sOpseq, sLastc, sDpseq, sLpseq, sNull, sColumn, sBogbn

Lrow = dw_tabpage3_2.getrow()

Setnull(snull)

if Lrow < 1 then
	Messagebox("공정확인", "삭제할 공정을 선택하십시요", stopsign!)
	dw_tabpage3_2.setfocus()
	return
end if

if dw_tabpage3_2.rowcount() = 1 then
	Messagebox("공정확인", "1개의 이상의 공정이 필요합니다", stopsign!)
	dw_tabpage3_2.setfocus()
	return
end if	

sOpdsc 	= dw_tabpage3_2.getitemstring(Lrow, "morout_copy_opdsc")
sOpseq	= dw_tabpage3_2.getitemstring(Lrow, "morout_copy_opseq")
sLastc	= dw_tabpage3_2.getitemstring(Lrow, "morout_copy_lastc")
sColumn  = dw_tabpage3_2.getitemstring(Lrow, "morout_copy_pordno")

if Messagebox("삭제확인", sOpdsc + " 공정을 삭제하시겠읍니까?", question!, yesno!) = 2 then
	dw_tabpage3_2.setfocus()
	return	
end if

SEtpointer(hourglass!)

// 삭제 
dw_tabpage3_2.deleterow(Lrow)

// 동시공정이 있으면 삭제할 수 없음
For Lrow = 1 to dw_tabpage3_2.rowcount()
	 if not isnull(dw_tabpage3_2.getitemstring(Lrow, "morout_copy_do_opseq")) then
		 MessageBox("동시공정", "동시공정이 존재하므로 변경할 수 없읍니다", stopsign!)
		 tab_1.tabpage_3.dw_tabpage3_2.retrieve(gs_sabu, scolumn)		 
		 return
	 end if
Next

// 보고유무 사용구분 검색
sBogbn = '2'
select dataname
  into :sBogbn
  from syscnfg
 where sysgu = 'Y' and serial = '15' and lineno = '6';
if sqlca.sqlcode <> 0 then sBogbn = '2'


// 보고유무를 사용하는 경우에만 공정구분을 정리한다.
if sBogbn = '1' then
	// 현재 공정을 기준으로 정리
	if dw_tabpage3_2.rowcount() > 1 then
		For Lrow = 1 to dw_tabpage3_2.rowcount()
			
			 // 공정구분
			 if 	  Lrow = 1 then
				 dw_tabpage3_2.setitem(Lrow, "morout_copy_lastc", '1')
			 Elseif Lrow = dw_tabpage3_2.rowcount() then
				 dw_tabpage3_2.setitem(Lrow, "morout_copy_lastc", '3')
			 Else
				 dw_tabpage3_2.setitem(Lrow, "morout_copy_lastc", '0')
			 End if
			
			 //도착후 공정 check
			 if Lrow = dw_tabpage3_2.rowcount() then
				 dw_tabpage3_2.setitem(Lrow, "morout_copy_de_opseq", snull)				
			 Else
				 dw_tabpage3_2.setitem(Lrow, "morout_copy_de_opseq", dw_tabpage3_2.getitemstring(Lrow + 1, "morout_copy_opseq"))
			 End if	
	
			 //도착전 공정 check
			 if Lrow = 1 then 
				 dw_tabpage3_2.setitem(Lrow, "morout_copy_pr_opseq", '0000')
			 Else
				 dw_tabpage3_2.setitem(Lrow, "morout_copy_pr_opseq", dw_tabpage3_2.getitemstring(Lrow - 1, "morout_copy_opseq"))
			 End if		 
	
		Next
	else
		dw_tabpage3_2.setitem(1, "morout_copy_lastc", '9')	
		dw_tabpage3_2.setitem(1, "morout_copy_pr_opseq", '0000')	
		dw_tabpage3_2.setitem(1, "morout_copy_de_opseq", snull)	
	end if
end if

if dw_tabpage3_2.update() <> 1 then
	rollback;
 	tab_1.tabpage_3.dw_tabpage3_2.retrieve(gs_sabu, scolumn)
	f_rollback()
end if

// 할당사용공정 변경
// 1. 삭제공정 이후에 Min공정을 적용
// 2. 삭제공정 이전에 Max공정을 적용
// 1,2에 해당되지 않으면 Error처리
Setnull(sDpseq)
Select Min(opseq) Into :sDpseq From morout_copy
 where sabu = :gs_sabu And pordno = :sColumn And opseq > :sOpseq;
if Isnull( sDpseq ) then
	Select Max(opseq) Into :sDpseq From morout_copy
	 where sabu = :gs_sabu And pordno = :sColumn And opseq < :sOpseq;
end if

if Isnull( sDpseq ) then
	rollback;
 	tab_1.tabpage_3.dw_tabpage3_2.retrieve(gs_sabu, scolumn)
	Messagebox("공정검색", "작업지시에 대한 공정을 검색할 수 없읍니다", stopsign!)
	return
end if	

if MessageBox("자재확인", "자재를 삭제하시겠읍니까?", question!, yesno!) = 1 then
	Delete
	  From holdstock_copy
	 Where sabu = :gs_sabu And Pordno = :sColumn And Opseq = :sOpseq;
else
	Update holdstock_copy
		Set opseq = :sDpseq
	 Where sabu = :gs_sabu And Pordno = :sColumn And Opseq = :sOpseq;
end if

SEtpointer(Arrow!)

Commit;

Messagebox("삭제완료", sOpdsc + " 공정이 삭제되었읍니다", information!)	
end event

event ue_lbuttonup;call super::ue_lbuttonup;PictureName = 'C:\erpman\image\공정삭제_up.gif'
end event

event ue_lbuttondown;call super::ue_lbuttondown;PictureName = 'C:\erpman\image\공정삭제_dn.gif'
end event

type p_11 from uo_picture within tabpage_3
integer x = 3794
integer y = 20
integer width = 178
string picturename = "C:\erpman\image\공정수정_up.gif"
end type

event clicked;call super::clicked;SetNull(gs_code)			// 작업지시번호
SetNull(gs_codename)		// 공정코드

Long Lrow
String sMsg, sPordno

Lrow = tab_1.tabpage_3.dw_tabpage3_2.getrow()
if Lrow < 1 then return

gs_code 		= tab_1.tabpage_3.dw_tabpage3_2.getitemstring(Lrow, "morout_copy_pordno")   // 작업지시번호
gs_codename = tab_1.tabpage_3.dw_tabpage3_2.getitemstring(Lrow, "morout_copy_opseq")   // 공정코드
sPordno     = gs_code

open(w_pdt_02030_3)

sMsg = message.stringparm
if sMsg = 'Y' then
	tab_1.tabpage_3.dw_tabpage3_2.retrieve(gs_sabu, sPordno)
End if

SetNull(gs_code)			// 작업지시번호
SetNull(gs_codename)		// 공정코드
end event

event ue_lbuttonup;call super::ue_lbuttonup;PictureName = 'C:\erpman\image\공정수정_up.gif'
end event

event ue_lbuttondown;call super::ue_lbuttondown;PictureName = 'C:\erpman\image\공정수정_dn.gif'
end event

type p_10 from uo_picture within tabpage_3
integer x = 3621
integer y = 20
integer width = 178
string picturename = "C:\erpman\image\공정추가_up.gif"
end type

event clicked;call super::clicked;SetNull(gs_code)			// 작업지시번호
SetNull(gs_codename)		// 공정코드

String sMsg, sPordno

if tab_1.tabpage_3.dw_tabpage3_1.rowcount() > 0 then
	gs_code = tab_1.tabpage_3.dw_tabpage3_1.getitemstring(tab_1.tabpage_3.dw_tabpage3_1.getrow(), "momast_copy_pordno")   // 작업지시번호
End if

if IsNull( gs_code ) then
	MessageBox("공정추가", "계산후 공정을 추가하십시요" + "작업지시번호가 생성되어야 합니다", stopsign!)
	return
End if

sPordno = gs_code

open(w_pdt_02030_3)

sMsg = message.stringparm
if sMsg = 'Y' then
	tab_1.tabpage_3.dw_tabpage3_2.retrieve(gs_sabu, spordno)
End if

SetNull(gs_code)			// 작업지시번호
SetNull(gs_codename)		// 공정코드
end event

event ue_lbuttonup;call super::ue_lbuttonup;PictureName = 'C:\erpman\image\공정추가_up.gif'
end event

event ue_lbuttondown;call super::ue_lbuttondown;PictureName = 'C:\erpman\image\공정추가_dn.gif'
end event

type dw_tabpage3_1 from datawindow within tabpage_3
event ue_key pbm_dwnkey
event ue_pressenter pbm_dwnprocessenter
integer x = 46
integer y = 192
integer width = 4439
integer height = 784
integer taborder = 10
boolean bringtotop = true
string dataobject = "d_pdt_02030_1"
boolean border = false
end type

event ue_key;Long lrow
lrow = this.getrow()


if keydown(keyf1!) then
	this.triggerevent(rbuttondown!)
end if

IF keydown(keyF2!) THEN
	IF This.GetColumnName() = "momast_copy_itnbr" Then
		open(w_itemas_popup2)
		if isnull(gs_code) or gs_code = "" then return
		
		this.SetItem(this.getrow(),"momast_copy_itnbr",gs_code)
		this.TriggerEvent(ItemChanged!)
	end if
END IF

end event

event ue_pressenter;Send(Handle(this),256,9,0)
Return 1
end event

event dberror;String  sMsg, sErrorcode, sErrorsyntax, sReturn, sNewline
Integer iPos, iCount

iCount			= 0
sNewline			= '~r'
sReturn			= '~n'
sErrorcode 		= Left(sqlerrtext, 9)
iPos 		  		= Len(sqlerrtext) - Pos(sqlerrtext, "No changes made to database.", 1)
sErrorSyntax	= tRIM(Mid(sqlerrtext, 11, Len(sqlerrtext) - iPos - 11))

For iPos = Len(sErrorSyntax) to 1 STEP -1
	 sMsg = Mid(sErrorSyntax, ipos, 1)
	 If sMsg   = sReturn or sMsg = sNewline Then
		 iCount++
	 End if
Next

sErrorSynTax  	= Left(sErrorSyntax, Len(sErrorsyntax) - iCount)


str_db_error db_error_msg
db_error_msg.rowno 	 				= row
db_error_msg.errorcode 				= sErrorCode
db_error_msg.errorsyntax_system	= sErrorSyntax
db_error_msg.errorsyntax_user		= sErrorSyntax
db_error_msg.errorsqlsyntax			= sqlsyntax
OpenWithParm(w_error, db_error_msg)


/*sMsg = "Row No       -> " + String(row) 			 + '~n' + &
		 "Error Code   -> " + sErrorcode			    + '~n' + &
		 "Error Syntax -> " + sErrorSyntax			 + '~n' + &
		 "SqlSyntax    -> " + Sqlsyntax
	MESSAGEBOX("자료처리중 오류발생", sMsg) */

RETURN 1
end event

event editchanged;ib_any_typing =True


end event

event itemchanged;string   snull, sitnbr, sreff, sreff1, sitdsc, sispec, sjijil, sispec_code, scvcod, &
			sdptno, spurgc, sporgu, scvnas, stuncu, sIogbn, sPordno, sopseq, sopdsc
long     lrow, Lrow1
integer  ireturn
Decimal  {5} dunprc
String		ls_pspec

setnull(snull)

lrow   = this.getrow()
this.accepttext()

/* 작업지시구분 check */
If this.Getcolumnname() = "momast_copy_porgu" then
	
	tab_1.tabpage_2.p_last.enabled = false	
	tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
	
	tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_porgu", gettext())
	if isnull(f_get_reffer('60', this.gettext())) then
		f_message_chk(79,'[작업지시구분]') 
		this.setitem(lrow, "momast_copy_porgu", '')
		tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_porgu", '')
		RETURN  1
	END IF

	this.setitem(lrow, "pagbn", 'N')		
	this.setitem(lrow, "momast_copy_purgc", 'N')
	this.setitem(lrow, "momast_copy_pa_pordno", '')
	this.setitem(lrow, "momast_copy_pa_ospeq", '')
	this.setitem(lrow, "momast_copy_st_opseq", '')
	this.setitem(lrow, "momast_copy_cvcod", '')
	this.setitem(lrow, "vndmst_cvnas2", '')
	this.setitem(lrow, "momast_copy_unprc", 0)	
	
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "pagbn", 'N')		
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_purgc", 'N')
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_pa_pordno", '')
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_pa_ospeq", '')
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_st_opseq", '')
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_cvcod", '')
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "vndmst_cvnas2", '')
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_unprc", 0)	
	
	sPordno = getitemstring(Lrow, "momast_copy_pordno")
	
elseif this.getcolumnname() = "momst_copy_purgc" then		// 외주구분
	if gettext() <> 'N' then
		// 외주가 아닌 경우에는 자재 출고 구분을 자동출고 구분을 Setting한다.
		Select Iogbn Into :sIogbn from iomatrix where sabu = '1' and autpdt = 'Y';
		if sqlca.sqlcode <> 0 then
			setitem(lrow, "momast_copy_purgc", 'N')
			tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_purgc", 'N')
			Messagebox("생산출고", "자동출고용 수불구분을 검색할 수 없읍니다", stopsign!)
			return 1
		end if

		sDptno = getitemstring(lrow, "momast_copy_pdtgu")
		select cvcod into :sCvcod from vndmst where cvgu = '5' and jumaeip = :sDptno;
		
		Update Holdstock_copy
			Set out_store = :sCvcod,
				 Hold_gu	  = :sIogbn
		 Where sabu = :gs_sabu and Pordno = :sPordno;
		Commit;	
		
		tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_cvcod", '')
		tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "vndmst_cvnas2", '')
		tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_unprc", 0)			
		
		setitem(lrow, "momast_copy_cvcod", '')
		setitem(lrow, "vndmst_cvnas2", '')
		setitem(lrow, "momast_copy_unprc", 0)			
		
		// 전체외주인 경우에는 공정생성및 시간계산을 제외한다.
		tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_routct", 'Y')
		tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_timect", 'Y')				
		
	else	//전체외주
		this.setitem(lrow, "momast_copy_purgc", 'Y')
		tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_purgc", 'Y')		
		sitnbr 		= this.getitemstring(lrow, "momast_copy_itnbr")
		ls_pspec = this.getitemstring(lrow, "momast_copy_pspec")
		f_buy_unprc(sitnbr, ls_pspec, '9999', scvcod, scvnas, dUnprc, sTuncu)
		
		// 외주인 경우에는 자재 출고 구분을 외주출고 구분을 Setting한다.
		Select Iogbn Into :sIogbn from iomatrix where sabu = '1' and autvnd = 'Y';
		if sqlca.sqlcode <> 0 then
			setitem(lrow, "momast_copy_purgc", 'N')
			tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_purgc", 'N')
			Messagebox("사급출고", "사급출고용 수불구분을 검색할 수 없읍니다", stopsign!)
			return 1
		end if
		Update Holdstock_copy
			Set out_store = :sCvcod,
				 Hold_gu	  = :sIogbn
		 Where sabu = :gs_sabu and Pordno = :sPordno;
		Commit;
		
		this.setitem(Lrow, "momast_copy_cvcod",  scvcod)
		this.setitem(Lrow, "vndmst_cvnas2", scvnas)
		this.setitem(Lrow, "momast_copy_unprc",  dUnprc)			
		
		tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_cvcod",  scvcod)
		tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "vndmst_cvnas2", scvnas)
		tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_unprc",  dUnprc)		
		
		
		// 전체외주인 경우에는 공정생성및 시간계산을 제외한다.
		tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_routct", 'N')
		tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_timect", 'N')		
		
	end if	
elseif this.getcolumnname() = "pagbn" then	
		 tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "pagbn", getitemstring(Lrow, "pagbn"))	
elseif this.getcolumnname() = "momast_copy_jidat" then
	if f_datechk(gettext()) = -1 then
		this.setitem(lrow, "momast_copy_jidat", f_today())
		f_message_chk(35, '[지시일자]')
		return 1
	else
		tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_jidat",  gettext())				
	end if	
ELSEIF this.GetColumnName() = "momast_copy_itnbr"	THEN
	
	tab_1.tabpage_2.p_last.enabled = false	
	tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
	sItnbr 		= trim(this.GetText())
	ls_pspec 	= this.getitemstring(lrow, "momast_copy_pspec")
	ireturn = f_get_name4('품번', 'Y', sitnbr, sitdsc, sispec, sjijil, sispec_code)
	this.setitem(lrow, "momast_copy_itnbr", sitnbr)	
	this.setitem(lrow, "itemas_itdsc", sitdsc)	
	this.setitem(lrow, "itemas_ispec", sispec)
	this.setitem(lrow, "itemas_jijil", sjijil)	
	this.setitem(lrow, "itemas_ispec_code", sispec_code)
	
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_itnbr", sitnbr)	
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "itemas_itdsc", sitdsc)	
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "itemas_ispec", sispec)
	
	select fun_get_pdtgu(:sitnbr, '1') into :sdptno 
	from dual;	
	this.setitem(lrow, "momast_copy_pdtgu", sdptno)
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_pdtgu", sdptno)
	
	wf_item_check(lrow, sitnbr, ls_pspec,  '9999')

	RETURN ireturn
ELSEIF this.GetColumnName() = "itemas_itdsc"	THEN
	
	tab_1.tabpage_2.p_last.enabled = false	
	tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
	sItdsc = trim(this.GetText())
	ireturn = f_get_name4('품명', 'Y', sitnbr, sitdsc, sispec, sjijil, sispec_code)
	this.setitem(lrow, "momast_copy_itnbr", sitnbr)	
	this.setitem(lrow, "itemas_itdsc", sitdsc)	
	this.setitem(lrow, "itemas_ispec", sispec)
	this.setitem(lrow, "itemas_jijil", sjijil)	
	this.setitem(lrow, "itemas_ispec_code", sispec_code)
		
	ls_pspec 	= this.getitemstring(lrow, "momast_copy_pspec")
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_itnbr", sitnbr)	
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "itemas_itdsc", sitdsc)	
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "itemas_ispec", sispec)
	
	select fun_get_pdtgu(:sitnbr, '1') into :sdptno 
	from dual;	
	this.setitem(lrow, "momast_copy_pdtgu", sdptno)	
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_pdtgu", sdptno)
	
	wf_item_check(lrow, sitnbr, ls_pspec, '9999')
	RETURN ireturn
ELSEIF this.GetColumnName() = "itemas_ispec"	THEN
	
	tab_1.tabpage_2.p_last.enabled = false	
	tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
	sIspec = trim(this.GetText())
	ireturn = f_get_name4('규격', 'Y', sitnbr, sitdsc, sispec, sjijil, sispec_code)
	this.setitem(lrow, "momast_copy_itnbr", sitnbr)	
	this.setitem(lrow, "itemas_itdsc", sitdsc)	
	this.setitem(lrow, "itemas_ispec", sispec)
	this.setitem(lrow, "itemas_jijil", sjijil)	
	this.setitem(lrow, "itemas_ispec_code", sispec_code)
		
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_itnbr", sitnbr)	
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "itemas_itdsc", sitdsc)	
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "itemas_ispec", sispec)
	ls_pspec 	= this.getitemstring(lrow, "momast_copy_pspec")
	
	select fun_get_pdtgu(:sitnbr, '1') into :sdptno 
	from dual;	
	this.setitem(lrow, "momast_copy_pdtgu", sdptno)	
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_pdtgu", sdptno)
	
	wf_item_check(lrow, sitnbr, ls_pspec, '9999')
	RETURN ireturn
ELSEIF this.GetColumnName() = "itemas_jijil"	THEN
	
	tab_1.tabpage_2.p_last.enabled = false	
	tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
	sjijil = trim(this.GetText())
	ireturn = f_get_name4('재질', 'Y', sitnbr, sitdsc, sispec, sjijil, sispec_code)
	this.setitem(lrow, "momast_copy_itnbr", sitnbr)	
	this.setitem(lrow, "itemas_itdsc", sitdsc)	
	this.setitem(lrow, "itemas_ispec", sispec)
	this.setitem(lrow, "itemas_jijil", sjijil)	
	this.setitem(lrow, "itemas_ispec_code", sispec_code)
		
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_itnbr", sitnbr)	
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "itemas_itdsc", sitdsc)	
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "itemas_ispec", sispec)
	
	select fun_get_pdtgu(:sitnbr, '1') into :sdptno 
	from dual;	
	this.setitem(lrow, "momast_copy_pdtgu", sdptno)	
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_pdtgu", sdptno)
	ls_pspec = this.getitemstring(lrow, "momast_copy_pspec")
	
	wf_item_check(lrow, sitnbr, ls_pspec, '9999')
	RETURN ireturn
ELSEIF this.GetColumnName() = "itemas_ispec_code"	THEN
	
	tab_1.tabpage_2.p_last.enabled = false	
	tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
	sIspec_code = trim(this.GetText())
	ireturn = f_get_name4('규격코드', 'Y', sitnbr, sitdsc, sispec, sjijil, sispec_code)
	this.setitem(lrow, "momast_copy_itnbr", sitnbr)	
	this.setitem(lrow, "itemas_itdsc", sitdsc)	
	this.setitem(lrow, "itemas_ispec", sispec)
	this.setitem(lrow, "itemas_jijil", sjijil)	
	this.setitem(lrow, "itemas_ispec_code", sispec_code)
		
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_itnbr", sitnbr)	
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "itemas_itdsc", sitdsc)	
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "itemas_ispec", sispec)
	
	select fun_get_pdtgu(:sitnbr, '1') into :sdptno 
	from dual;	
	this.setitem(lrow, "momast_copy_pdtgu", sdptno)	
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_pdtgu", sdptno)
	
	ls_pspec = this.getitemstring(lrow, "momast_copy_pspec")
	wf_item_check(lrow, sitnbr, ls_pspec, '9999')
	RETURN ireturn
elseif getcolumnname() = "momast_copy_pspec"  then
	tab_1.tabpage_2.p_last.enabled = false		
	tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
	tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_pspec", gettext())		

		sPordno 	= getitemstring(Lrow, "momast_copy_pordno")
		spurgc 	= getitemstring(Lrow, "momast_copy_purgc")
		
		if spurgc = 'N' then
			
			tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_purgc", 'N')		
			
			// 외주가 아닌 경우에는 자재 출고 구분을 자동출고 구분을 Setting한다.		
			Select Iogbn Into :sIogbn from iomatrix where sabu = '1' and autpdt = 'Y';
			if sqlca.sqlcode <> 0 then
				setitem(lrow, "momast_copy_purgc", 'N')
				Messagebox("생산출고", "자동출고용 수불구분을 검색할 수 없읍니다", stopsign!)
				return 1
			end if
			
			sDptno = getitemstring(lrow, "momast_copy_pspec")
			
			Update Holdstock_copy
				Set pspec = :sDptno
			 Where sabu = :gs_sabu and Pordno = :sPordno;
					
			Commit;	
			
			// 외주 내역을 clear
			setitem(lrow, "momast_copy_cvcod",  snull)
			setitem(lrow, "vndmst_cvnas2", snull)
			setitem(lrow, "momast_copy_unprc",  0)			
			
			tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_cvcod",  snull)
			tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "vndmst_cvnas2", snull)
			tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_unprc",  0)
			
			// 전체외주인 경우에는 공정생성및 시간계산을 제외한다.
			tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_routct", 'Y')
			tab_1.tabpage_2.dw_tabpage2.setitem(Lrow, "momast_copy_timect", 'Y')						
			
		Else				/* 외주		*/
			tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_purgc", 'Y')
			sitnbr 		= getitemstring(lrow, "momast_copy_itnbr")
			ls_pspec = getitemstring(lrow, "momast_copy_pspec")
			f_buy_unprc(sitnbr, ls_pspec, '9999', scvcod, scvnas, dUnprc, sTuncu)
			
			// 외주인 경우에는 자재 출고 구분을 외주출고 구분을 Setting한다.
			Select Iogbn Into :sIogbn from iomatrix where sabu = '1' and autvnd = 'Y';
			if sqlca.sqlcode <> 0 then
				setitem(lrow, "momast_copy_purgc", 'N')
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_purgc", 'N')
				Messagebox("사급출고", "사급출고용 수불구분을 검색할 수 없읍니다", stopsign!)
				return 1
			end if
			Update Holdstock_copy
				Set out_store 	= :sCvcod,
					 Hold_gu		= :sIogbn,
					 pspec		= :ls_pspec
			 Where sabu = :gs_sabu and Pordno = :sPordno;
			Commit;
			
			if isnull(getitemstring(Lrow, "momast_copy_itnbr")) or trim(getitemstring(Lrow, "momast_copy_itnbr")) = '' then
				setitem(lrow, "momast_copy_cvcod",  snull)
				setitem(lrow, "vndmst_cvnas2", snull)
				setitem(lrow, "momast_copy_unprc",  0)			
				
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_cvcod",  snull)
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "vndmst_cvnas2", snull)
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_unprc",  0)
			Else
				setitem(lrow, "momast_copy_cvcod",  scvcod)
				setitem(lrow, "vndmst_cvnas2", scvnas)
				setitem(lrow, "momast_copy_unprc",  dUnprc)			
				
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_cvcod",  scvcod)
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "vndmst_cvnas2", scvnas)
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_unprc",  dUnprc)		
				tab_1.tabpage_3.dw_tabpage3_1.setitem(lrow, "momast_copy_pspec",  ls_pspec)		
			End if;
			
			// 전체외주인 경우에는 공정생성및 시간계산을 제외한다.
			setitem(Lrow, "momast_copy_routct", 'N')
			setitem(Lrow, "momast_copy_timect", 'N')
		end if	
	
elseif this.getcolumnname() = "momast_copy_pdqty"  then
	
	tab_1.tabpage_2.p_last.enabled = false	
	tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_pdqty", Dec(this.gettext()))
	if dec(this.gettext()) < 1 then
		this.setitem(Lrow, "momast_copy_pdqty", 0)
		tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_pdqty", 0)
		f_message_chk(78,'[지시수량]') 
		RETURN  1	
	end if
elseif this.getcolumnname() = "momast_copy_esdat" then
	
	tab_1.tabpage_2.p_last.enabled = false	
	tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_esdat", this.gettext())
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_fsdat", this.gettext())
	this.setitem(lrow, "momast_copy_fsdat", this.gettext())	
	if isnull(this.gettext()) or trim(this.gettext()) = '' then
		return
	end if
	if f_datechk(this.gettext()) = -1 then
		f_message_chk(35,'[생산시작일]') 
		this.setitem(lrow, "momast_copy_esdat", '')
		this.setitem(lrow, "momast_copy_fsdat", '')
		tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_esdat", '')
		tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_fsdat", '')
		RETURN  1			
	end if
elseif this.getcolumnname() = "momast_copy_eedat" then
	
	tab_1.tabpage_2.p_last.enabled = false	
	tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_eedat", this.gettext())
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_fedat", this.gettext())
	setitem(lrow, "momast_copy_fedat", this.gettext())
	if isnull(this.gettext()) or trim(this.gettext()) = '' then
		return
	end if
	if f_datechk(this.gettext()) = -1 then
		f_message_chk(35,'[생산종료일]') 
		this.setitem(lrow, "momast_copy_eedat", '')
		this.setitem(lrow, "momast_copy_fedat", '')
		tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_eedat", '')
		tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_fedat", '')
		RETURN  1			
	end if
	if this.getitemstring(lrow, "momast_copy_esdat") > this.getitemstring(lrow, "momast_copy_eedat") then
		f_message_chk(35,'[생산종료일]') 
		this.setitem(lrow, "momast_copy_eedat", '')
		this.setitem(lrow, "momast_copy_fedat", '')
		tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_eedat", '')
		tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_fedat", '')
		RETURN  1			
	end if
elseif this.getcolumnname() = "momast_copy_cvcod"	 then
	
	tab_1.tabpage_2.p_last.enabled = false	
	tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
	scvcod = this.gettext()
	ireturn = f_get_name2('V1', 'Y', scvcod, sitdsc, sispec)    //1이면 실패, 0이 성공	
	if ireturn = 0 then
		sitnbr = this.getitemstring(lrow, "momast_copy_itnbr")
		select unprc into :dunprc from danmst
			 where itnbr = :sitnbr and cvcod = :scvcod and opseq = '9999';
		 if sqlca.sqlcode <> 0 then
	 		 f_message_chk(82,'[ ' + sitdsc + ' ]')
			 dunprc = 0
		 end if
	end if	
	this.setitem(lrow, "momast_copy_cvcod", scvcod)	
	this.setitem(lrow, "vndmst_cvnas2", sitdsc)	
   this.setitem(lrow, "momast_copy_unprc", dunprc)
	
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_cvcod", scvcod)	
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "vndmst_cvnas2", sitdsc)	
   tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_unprc", dunprc)	
	
	RETURN ireturn
elseif this.getcolumnname() = "momast_copy_unprc"  then
   tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_unprc", Dec(this.gettext()))
	if dec(this.gettext()) < 1 then
		this.setitem(Lrow, "momast_copy_unprc", 0)
	   tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_unprc", 0)
		f_message_chk(80,'[외주단가]') 
		RETURN  1	
	end if	
elseif this.getcolumnname() = "momast_copy_purgc"  then	
	
	tab_1.tabpage_2.p_last.enabled = false	
	tab_1.tabpage_2.p_last.PictureName = "C:\erpman\image\작업지시_d.gif"
	this.setitem(lrow, "momast_copy_cvcod", '')
	this.setitem(lrow, "vndmst_cvnas2", '')
	this.setitem(lrow, "momast_copy_unprc", 0)
	
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_cvcod", '')
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "vndmst_cvnas2", '')
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_unprc", 0)	
elseif this.getcolumnname() = "momast_copy_pa_pordno" then
	sreff = this.getitemstring(lrow, "momast_copy_pa_pordno")
	tab_1.tabpage_2.dw_tabpage2.getitemstring(lrow, "momast_copy_pa_pordno")
	
	Select itnbr, pspec, pdsts into :sitnbr, :sispec, :sreff1 from momast_copy
	 where sabu = :gs_sabu and pordno = :sreff;
	if sqlca.sqlcode <> 0 then
		f_message_chk(77,'[작업지시번호]')
		this.setitem(lrow, "momast_copy_pa_pordno", '')
		this.setitem(lrow, "momast_copy_pa_ospeq", '')
		
		tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_pa_pordno", '')
		tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_pa_ospeq", '')		
		return 1
	end if
	if sreff1 <> '1' and sreff1 <> '2' then
		f_message_chk(84,'[작업지시상태]')
		this.setitem(lrow, "momast_copy_pa_pordno", '')
		this.setitem(lrow, "momast_copy_pa_ospeq", '')
		
		tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_pa_pordno", '')
		tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_pa_ospeq", '')				
		return 1
	end if
	if this.getitemstring(lrow, "momast_copy_itnbr") <> sitnbr or &
		this.getitemstring(lrow, "momast_copy_pspec") <> sispec then
		f_message_chk(85,'[품목,사양]')
		this.setitem(lrow, "momast_copy_pa_pordno", '')
		this.setitem(lrow, "momast_copy_pa_ospeq", '')
		
		tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_pa_pordno", '')
		tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_pa_ospeq", '')				
		return 1
	end if
elseif this.getcolumnname() = "momast_copy_pa_ospeq" then
	sitnbr  = this.getitemstring(lrow, "momast_copy_itnbr")
	spordno = this.getitemstring(lrow, "momast_copy_pa_pordno")	
	sopseq  = this.getitemstring(lrow, "momast_copy_pa_ospeq")
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_pa_pordno", sopseq)	

	setnull(sopdsc)
	Select opdsc into :sopdsc from morout
	 Where sabu = :gs_sabu And pordno = :spordno And opseq = :sopseq;
	
   if isnull(sopdsc) then 
		this.setitem(lrow, "momast_copy_pa_ospeq", '')
		tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_pa_ospeq", '')
		return 1
	end if
elseif this.getcolumnname() = "momast_copy_st_opseq" then
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_st_opseq", this.gettext())		
elseif this.getcolumnname() = "momast_copy_matchk" then
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_matchk", this.gettext())		
elseif this.getcolumnname() = "momast_copy_pdprc" then
	tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_pdprc", dec(this.gettext()))
end if
end event

event itemerror;return 1
end event

event rbuttondown;String colname
Long   lrow

SetNull(gs_gubun)
SetNull(gs_code)
SetNull(gs_codename)

colname = this.getcolumnname()
lrow	  = this.getrow()
if this.accepttext() = -1 then return

if colname = "momast_copy_itnbr" or colname = "itemas_itdcs" or colname = "itemas_ispec" then
   gs_code = this.getitemstring(lrow, "momast_copy_itnbr")
	open(w_itemas_popup)
	
	if isnull(gs_code) or gs_code = "" then return
	
	this.SetItem(1,"momast_copy_itnbr",gs_code)
	this.TriggerEvent(ItemChanged!)
	
elseif colname = "momast_copy_cvcod" then
		 gs_code 	 = this.getitemstring(lrow, "momast_copy_itnbr")
		 gs_codename = '9999'
		 open(w_danmst_popup)
		 if isnull(gs_code) or gs_code = "" then return
		 this.setitem(lrow, "momast_copy_cvcod", gs_code)
		 this.triggerevent(itemchanged!)
		 
elseif colname = "momast_copy_pa_pordno" or &
		 colname = "momast_copy_pa_ospeq"  then		 
		 
		 gs_code 		= this.getitemstring(lrow, "momast_copy_itnbr")
		 gs_codename 	= this.getitemstring(lrow, "momast_copy_pspec")
		 gs_gubun		= trim(this.getitemstring(lrow, "itemas_itdsc")) + ' ' + &
		 					  trim(this.getitemstring(lrow, "itemas_itdsc"))
		 open(w_pdt_02030_2)
		 if isnull(gs_code) or gs_code = "" then return
		 this.setitem(lrow, "momast_copy_pa_pordno", gs_code)
		 this.setitem(lrow, "momast_copy_pa_ospeq", gs_codename)
		 tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_pa_pordno", gs_code)
		 tab_1.tabpage_2.dw_tabpage2.setitem(lrow, "momast_copy_pa_ospeq",  gs_codename)
elseif colname = "momast_copy_st_opseq" then
		 gs_code = this.getitemstring(lrow, "momast_copy_itnbr")
		 openwithparm(w_routng_popup, gs_code)
		 if isnull(gs_code) or gs_code = "" then return
		 this.setitem(lrow, "momast_copy_st_opseq", gs_code)
		 this.triggerevent(itemchanged!)
end if

end event

event rowfocuschanged;String  sColumn, sitnbr
integer ichk
Long Lrow, Lfind

If Currentrow > 0 then
	

	/* 품목별 상세/공정내역 error check */	
	If tab_1.tabpage_3.dw_tabpage3_1.accepttext() = -1 then
		return 1
	end if
	If tab_1.tabpage_3.dw_tabpage3_2.accepttext() = -1 then
		return 1
	end if

	iChk =  wf_requiredchk_tabpage31(lrow, scolumn) 
	w_mdi_frame.sle_msg.text = ''	
	if iChk = -1 then
		tab_1.tabpage_3.dw_tabpage3_2.setcolumn(scolumn)
		tab_1.tabpage_3.dw_tabpage3_2.scrolltorow(lrow)
		tab_1.tabpage_3.dw_tabpage3_2.setfocus()
	Else
		sColumn = this.getitemstring(Currentrow, "momast_copy_pordno")
		sItnbr  = this.getitemstring(Currentrow, "momast_copy_itnbr")
		tab_1.tabpage_3.dw_tabpage3_2.retrieve(gs_sabu, scolumn)		
	end if
	
else
	tab_1.tabpage_3.dw_tabpage3_2.reset()
end if
end event

event updatestart;/* Update() function 호출시 user 설정 */
long k, lRowCount

lRowCount = this.RowCount()

FOR k = 1 TO lRowCount
   IF NewModified! = this.GetItemStatus(k, 0, Primary!) THEN
 	   This.SetItem(k,'crt_user',gs_userid)
   ELSEIF DataModified! = this.GetItemStatus(k, 0, Primary!) THEN 		
	   This.SetItem(k,'upd_user',gs_userid)
   END IF	  
NEXT


end event

event scrollvertical;long ll_numrows

string ls_firstrow, ls_lastrow

ll_numrows = RowCount()

ls_firstrow = Object.Datawindow.FirstRowOnPage

ls_lastrow = Object.Datawindow.LastRowOnPage

setrow(dec(ls_lastrow))
scrolltorow(dec(ls_lastrow))

RETURN 0
end event

type dw_tabpage3_2 from datawindow within tabpage_3
event ue_key pbm_dwnkey
event ue_pressenter pbm_dwnprocessenter
integer x = 37
integer y = 1016
integer width = 4453
integer height = 1004
integer taborder = 30
boolean bringtotop = true
string dataobject = "d_pdt_02030_4"
boolean vscrollbar = true
boolean border = false
boolean livescroll = true
end type

event ue_key;if key  = keyf1! then
	this.triggerevent(rbuttondown!)
end if
end event

event ue_pressenter;Send(Handle(this),256,9,0)
Return 1
end event

event itemchanged;string   snull, sitnbr, sreff, sreff1, sitdsc, sispec, scvcod, sopseq, stoday, sPordno, &
			sIogbn, sDptno, sOpdsc, sPurgc, stuncu, scvnas
long     lrow
integer  ireturn
Decimal  {5} dunprc
String		ls_pspec

setnull(snull)

lrow   = dw_tabpage3_2.getrow()

if accepttext() = -1 then
	Messagebox("자료확인", "자료확인시 오류 발생", stopsign!)
	return 1
end if

if this.getcolumnname() = "morout_copy_esdat" then
	ib_rcal = true
	if isnull(this.gettext()) or trim(this.gettext()) = '' then
		f_message_chk(35,'[생산시작일]') 
		this.setitem(lrow, "morout_copy_esdat", '')
		this.setitem(lrow, "morout_copy_fsdat", '')
		RETURN  1
	end if
	if f_datechk(this.gettext()) = -1 then
		f_message_chk(35,'[생산시작일]') 
		this.setitem(lrow, "morout_copy_esdat", '')
		this.setitem(lrow, "morout_copy_fsdat", '')		
		RETURN  1			
	end if
	this.setitem(lrow, "morout_copy_fsdat", this.gettext())
elseif this.getcolumnname() = "morout_copy_eedat" then
	ib_rcal = true	
	if isnull(this.gettext()) or trim(this.gettext()) = '' then
		f_message_chk(35,'[생산종료일]') 
		this.setitem(lrow, "morout_copy_esdat", '')
		this.setitem(lrow, "morout_copy_eedat", '')
		this.setitem(lrow, "morout_copy_fsdat", '')
		this.setitem(lrow, "morout_copy_fedat", '')		
		RETURN  1			
	end if
	if f_datechk(this.gettext()) = -1 then
		f_message_chk(35,'[생산종료일]') 
		this.setitem(lrow, "morout_copy_esdat", '')
		this.setitem(lrow, "morout_copy_eedat", '')
		this.setitem(lrow, "morout_copy_fsdat", '')
		this.setitem(lrow, "morout_copy_fedat", '')		
		RETURN  1			
	end if
	if this.getitemstring(lrow, "morout_copy_esdat") > this.gettext() then
		f_message_chk(35,'[생산종료일]') 
		this.setitem(lrow, "morout_copy_esdat", '')
		this.setitem(lrow, "morout_copy_eedat", '')
		this.setitem(lrow, "morout_copy_fsdat", '')
		this.setitem(lrow, "morout_copy_fedat", '')
		RETURN  1			
	end if
	this.setitem(lrow, "morout_copy_fedat", this.gettext())
elseif this.getcolumnname() = "morout_copy_wkctr" then
	ireturn = 0
	sreff = this.gettext()
	select a.wkctr, a.wcdsc, b.jocod, b.jonam
	  into :sitnbr, :sreff1, :sitdsc, :sispec
	  from wrkctr a, jomast b
	 where a.wkctr = :sreff and a.jocod = b.jocod (+);
	if sqlca.sqlcode <> 0 then
		f_message_chk(90,'[작업장]')
		setnull(sreff1)		
		setnull(sitnbr)
		setnull(sitdsc)
		setnull(sispec)
		ireturn = 1
	end if
	if not isnull(sreff1)  and isnull(sitdsc) then
		f_message_chk(91,'[조]')
		setnull(sreff1)
		setnull(sitnbr)
		setnull(sitdsc)
		setnull(sispec)
		ireturn = 1
	end if
	this.setitem(lrow, "morout_copy_wkctr", sitnbr)
	this.setitem(lrow, "wrkctr_wcdsc", sreff1)
	this.setitem(lrow, "morout_copy_jocod", sitdsc)
	this.setitem(lrow, "jomast_jonam", sispec)
	return ireturn
elseif this.getcolumnname() = "morout_copy_mchcod" then
	ireturn = 0
	sreff = this.getitemstring(lrow, "morout_copy_mchcod")
	select mchnam
	  into :sreff1
	  from mchmst
	 where sabu = :gs_sabu and mchno = :sreff;
	if sqlca.sqlcode <> 0 then
		f_message_chk(92,'[설비]')
		setnull(sreff)
		setnull(sreff1)
		ireturn = 1
	end if
	this.setitem(lrow, "mchmst_mchnam", sreff1)
	return ireturn	
elseif this.getcolumnname() = "morout_copy_purgc"  then	
	this.setitem(lrow, "morout_copy_wicvcod", '')
	this.setitem(lrow, "vndmst_cvnas2", '')
	this.setitem(lrow, "morout_copy_wiunprc", 0)
	
	sPordno = dw_tabpage3_1.getitemstring(dw_tabpage3_1.getrow(), "momast_copy_pordno")
	sItnbr  = getitemstring(lrow, "morout_copy_itnbr")	
	sopseq  = getitemstring(lrow, "morout_copy_opseq")	
	sopdsc  = getitemstring(lrow, "morout_copy_opdsc")	
	sPurgc  = this.gettext()
	
	if sPurgc = 'N' then
		// 외주가 아닌 경우에는 자재 출고 구분을 자동출고 구분을 Setting한다.
		Select Iogbn Into :sIogbn from iomatrix where sabu = '1' and autpdt = 'Y';
		if sqlca.sqlcode <> 0 then
			Messagebox("생산출고", "자동출고용 수불구분을 검색할 수 없읍니다", stopsign!)
			return 1
		end if

		sDptno = dw_tabpage3_1.getitemstring(dw_tabpage3_1.getrow(), "momast_copy_pdtgu")

		// 2001/05/11 유 추가 ==> 소진창고 최우선순위 추가 
		select depot_no 
		  into :sCvcod
		  from routng
		 where itnbr = :sItnbr and opseq = :sopseq ;			
	
		if isnull(sCvcod) or sCvcod = '' then 
			select cvcod   into :sCvcod
			  from vndmst where cvgu = '5' and jumaeip = :sDptno and rownum = 1;
		end if
			
		Update Holdstock_copy
			Set out_store = :sCvcod,
				 Hold_gu	  = :sIogbn, 
				 out_chk	  = '1',
				 naougu	  = '1' 				 
		 Where sabu = :gs_sabu and Pordno = :sPordno and opseq = :sOpseq;
			
		Commit;	
		
	Else
			
		sitnbr 		= tab_1.tabpage_3.dw_tabpage3_2.getitemstring(1, "morout_copy_itnbr")
		ls_pspec 	= tab_1.tabpage_3.dw_tabpage3_2.getitemstring(1, "morout_copy_pspec")
		
		f_buy_unprc(sitnbr, ls_pspec, sopseq, scvcod, scvnas, dUnprc, sTuncu)				
		
		select cvcod, unprc into :sCvcod, :dUnprc from danmst
			 where itnbr = :sitnbr and opseq = :sopseq and sltcd = 'Y';
			 
		 if sqlca.sqlcode <> 0 then
	 		 f_message_chk(82,'[ ' + sOpdsc + ' ]')
		 end if
		 
		setitem(Lrow, "morout_copy_wicvcod", sCvcod)
		setitem(lrow, "morout_copy_wiunprc", dunprc)
		ireturn = f_get_name2('V1', 'Y', scvcod, sitdsc, sispec)    //1이면 실패, 0이 성공
		setitem(Lrow, "vndmst_cvnas2", sItdsc)		 
		
		// 외주인 경우에는 자재 출고 구분을 외주출고 구분을 Setting한다.
		Select Iogbn Into :sIogbn from iomatrix where sabu = '1' and autvnd = 'Y';
		if sqlca.sqlcode <> 0 then
			Messagebox("사급출고", "사급출고용 수불구분을 검색할 수 없읍니다", stopsign!)
			return 1
		end if
		Update Holdstock_copy
			Set out_store = :sCvcod,
				 Hold_gu	  = :sIogbn, 
				 out_chk	  = '2',
				 naougu	  = '2' 
		 Where sabu = :gs_sabu and Pordno = :sPordno and opseq = :sOpseq;
		Commit;		
		
	end if	
	
elseif this.getcolumnname() = "morout_copy_wicvcod"	then
	scvcod = this.getitemstring(lrow, "morout_copy_wicvcod")
	sopseq = this.getitemstring(lrow, "morout_copy_opseq")
	ireturn = f_get_name2('V1', 'Y', scvcod, sitdsc, sispec)    //1이면 실패, 0이 성공	
	if ireturn = 0 then
		sitnbr = tab_1.tabpage_3.dw_tabpage3_2.getitemstring(1, "morout_copy_itnbr")
		select unprc into :dunprc from danmst
			 where itnbr = :sitnbr and cvcod = :scvcod and opseq = :sopseq and sltcd = 'Y';
		 if sqlca.sqlcode <> 0 then
	 		 f_message_chk(82,'[ ' + sitdsc + ' ]')
			 scvcod = ''
			 dunprc = 0
			 sitnbr = ''
			 sitdsc = ''
			 ireturn = 1
		 else
			 this.setitem(lrow, "morout_copy_wiunprc", dunprc)
		 end if
	end if	
	
	sPordno = dw_tabpage3_1.getitemstring(dw_tabpage3_1.getrow(), "momast_copy_pordno")
	sopseq  = getitemstring(lrow, "morout_copy_opseq")		
	
	// 할당의 소진처를 변경
	Update Holdstock_copy
		Set out_store = sCvcod
	 Where sabu = :gs_sabu and Pordno = :sPordno;
	Commit;			
	
	this.setitem(lrow, "morout_copy_wicvcod", scvcod)	
	this.setitem(lrow, "vndmst_cvnas2",  sitdsc)
   this.setitem(lrow, "morout_copy_wiunprc", dunprc)
	RETURN ireturn
elseif this.getcolumnname() = "morout_copy_wiunprc"  then
//	if dec(this.gettext()) < 1 then
//		f_message_chk(80,'[외주단가]') 
//		RETURN  1	
//	end if	
elseif this.getcolumnname() = "morout_copy_estim"  then
	if dec(this.gettext()) < 1 then
		f_message_chk(93,'[작업예상시간]') 
		RETURN  1	
	end if
end if
end event

event itemerror;return 1
end event

event rbuttondown;string colname
long   lrow

SETNULL(gs_gubun)
setnull(gs_code)
setnull(gs_codename)

colname = this.getcolumnname()
lrow    = this.getrow()

if     colname = "morout_copy_mchcod" then
		 gs_code = this.gettext()
		 gs_gubun    = this.getitemstring(lrow, "morout_copy_wkctr")
		 gs_codename = this.getitemstring(lrow, "wrkctr_wcdsc")
		 open(w_mchmst_popup)
		 if isnull(gs_code) or gs_code = "" then return
		 this.setitem(lrow, "morout_copy_mchcod", gs_code)
		 this.triggerevent(itemchanged!)
elseif colname = "morout_copy_wicvcod" then
		 gs_code = tab_1.tabpage_3.dw_tabpage3_2.getitemstring(lrow, "morout_copy_itnbr")
		 gs_codename = this.getitemstring(lrow, "morout_copy_opseq")
		 open(w_danmst_popup)
		 if isnull(gs_code) or gs_code = "" then return
		 this.setitem(lrow, "morout_copy_wicvcod", gs_code)
		 this.triggerevent(itemchanged!)
elseif colname = "morout_copy_wkctr" then
		 gs_code = this.gettext()
		 open(w_workplace_popup)
		 if isnull(gs_code) or gs_code = "" then return
		 this.setitem(lrow, "morout_copy_wkctr", gs_code)
		 this.triggerevent(itemchanged!)
end if


end event

type tabpage_4 from userobject within tab_1
integer x = 18
integer y = 108
integer width = 4521
integer height = 2040
boolean enabled = false
long backcolor = 32106727
string text = "자재검토"
long tabtextcolor = 33554432
long tabbackcolor = 32106727
long picturemaskcolor = 536870912
rr_8 rr_8
p_6 p_6
p_5 p_5
dw_jego dw_jego
dw_head dw_head
end type

on tabpage_4.create
this.rr_8=create rr_8
this.p_6=create p_6
this.p_5=create p_5
this.dw_jego=create dw_jego
this.dw_head=create dw_head
this.Control[]={this.rr_8,&
this.p_6,&
this.p_5,&
this.dw_jego,&
this.dw_head}
end on

on tabpage_4.destroy
destroy(this.rr_8)
destroy(this.p_6)
destroy(this.p_5)
destroy(this.dw_jego)
destroy(this.dw_head)
end on

type rr_8 from roundrectangle within tabpage_4
long linecolor = 28144969
integer linethickness = 1
long fillcolor = 32106727
integer x = 27
integer y = 276
integer width = 4457
integer height = 1740
integer cornerheight = 40
integer cornerwidth = 55
end type

type p_6 from uo_picture within tabpage_4
integer x = 4315
integer y = 20
integer width = 178
boolean originalsize = true
string picturename = "C:\erpman\image\행삭제2_up.gif"
end type

event clicked;call super::clicked;Long Lrow

If Messagebox("할당삭제",  "삭제하시겠읍니까?", question!, yesno!, 2) = 2 then
	dw_jego.setfocus()
	Return
end if

For Lrow = 1 to dw_jego.rowcount()
	 

	if dw_jego.getitemstring(Lrow, "delgu") = 'Y' then
		dw_jego.deleterow(Lrow)
		Lrow = Lrow - 1
	end if

Next

end event

event ue_lbuttonup;call super::ue_lbuttonup;PictureName = 'C:\erpman\image\행삭제2_up.gif'
end event

event ue_lbuttondown;call super::ue_lbuttondown;PictureName = 'C:\erpman\image\행삭제2_dn.gif'
end event

type p_5 from uo_picture within tabpage_4
integer x = 4142
integer y = 20
integer width = 178
string picturename = "C:\erpman\image\행추가2_up.gif"
end type

event clicked;call super::clicked;Long Lrow
String sToday
integer iJ

sToday = f_today()

SEtpointer(hourglass!)
/* 할당번호 채번 */
iJ = sqlca.fun_junpyo(gs_sabu, stoday, 'B0')
if iJ < 1 then
	f_message_chk(51,'[할당번호]') 
	rollback;
	return 
end if

Commit;

Lrow = dw_jego.insertrow(0)

// 기본적인 내용을 setting
dw_jego.setitem(Lrow, "sabu", gs_sabu)											// 사업장구분
dw_jego.setitem(Lrow, "hold_no", stoday + String(iJ, '0000') + '001')	// 할당번호
dw_jego.setitem(Lrow, "hold_date", sToday)										// 할당일자
dw_jego.setitem(Lrow, "pspec", '.')													// 사양
dw_jego.setitem(Lrow, "pordno", 	dw_head.getitemstring(1, "pordno"))		// 작업지시번호
dw_jego.setitem(Lrow, "hosts", 'N')													// 할당상태
dw_jego.setitem(Lrow, "master_no", is_sysno)                            // master_no

dw_jego.scrolltorow(Lrow)
dw_jego.setrow(Lrow)
dw_jego.setfocus()
SEtpointer(Arrow!)

end event

event ue_lbuttonup;call super::ue_lbuttonup;PictureName = 'C:\erpman\image\행추가2_up.gif'
end event

event ue_lbuttondown;call super::ue_lbuttondown;PictureName = 'C:\erpman\image\행추가2_dn.gif'
end event

type dw_jego from datawindow within tabpage_4
event ue_key pbm_dwnkey
event ue_processenter pbm_dwnprocessenter
integer x = 32
integer y = 284
integer width = 4439
integer height = 1716
integer taborder = 10
boolean bringtotop = true
string dataobject = "d_pdt_02030_12_TWO"
boolean hscrollbar = true
boolean vscrollbar = true
boolean border = false
boolean hsplitscroll = true
boolean livescroll = true
end type

event ue_key;Long lrow
lrow = this.getrow()

if keydown(keyf1!) then
	this.triggerevent(rbuttondown!)
end if

IF keydown(keyF2!) THEN
	IF This.GetColumnName() = "itnbr" Then
		open(w_itemas_popup2)
		if isnull(gs_code) or gs_code = "" then return
		
		this.SetItem(this.getrow(),"itnbr",gs_code)
		this.TriggerEvent(ItemChanged!)
	end if
END IF

end event

event ue_processenter;Send(Handle(this),256,9,0)
Return 1
end event

event itemchanged;Long Lrow, L2row
String sItnbr, sItdsc, sIspec, sAutvnd, sNull, sOpdsc, sOpseq, sPurgc, sPordno, sCvcod, sprvdat, &
		 sRqdat, sdepot_no, sdeptcode, sban, sjaje, sittyp, sCvnas, sPspec, sgijun, sout_store, &
		 STDITNBR, shname, sjijil, sispec_code
Integer iReturn
Decimal {3} dJego_qty, dValid_qty, dValid_qty1, dupjego, dupvalid
String	ls_saupj, ls_first

Setnull(sNull)

Lrow = this.getrow()

this.accepttext()

dw_ban.accepttext() 		// 반제품 출고 기준창고
dw_jaje.accepttext()		// 부품   출고 기준창고
sBan		= dw_ban.getitemstring(1, "ban_code")
sJaje		= dw_jaje.getitemstring(1, "jaje_code")
spordno 	= dw_head.getitemstring(1, "pordno")

ls_saupj	= dw_saupj.GetItemString(1, "saupj")
sitnbr 		= dw_head.getitemstring(1, "itnbr")

IF GetColumnName() = "opseq"	THEN
	sOpseq = trim(GetText())
	
	/* 소진창고 */
	Select c.cvcod, c.deptcode into :sdepot_no, :sdeptcode
	  from momast_copy a, vndmst c
	 where a.sabu  = :gs_sabu and a.pordno like :sPordno
		and a.pdtgu = c.jumaeip (+);
		
    	IF	sdepot_no = '' or isNull(sdepot_no)	then 
			Select cvcod  into :sdepot_no  from vndmst
			 where cvgu = '5' and juprod   = '3'    	and ipjogun = :ls_saupj and rownum = 1;	 
	End If
	SetNull(ls_first)
	// 표준공정의 소진창고를 확인하여 있으면 제일우선순의로 사용.
	select depot_no			  into :ls_first
		from routng
	 where itnbr = :sitnbr and opseq = :sOPSEQ ;
	If	Not isNull(ls_first) and ls_first <> ''	then
		sDepot_no	= ls_first
	End If	
	
		
	Setitem(Lrow, "Req_dept", 	sDeptcode)
	
	/* 전체외주인 경우에만 허용함 */
	if sOPSEQ = '9999' then
		Setitem(Lrow, "opdsc", sNull)
		IF dw_head.getitemstring(1, "purgc") = 'N' then
			Messagebox("공정", "외주작업이 아니므로 입력할 수 없읍니다", stopsign!)
			Setitem(Lrow, "opseq", 		sNull)
			Setitem(Lrow, "opdsc", 		sNull)
			Setitem(Lrow, "hold_gu", 	sNull)
			Setitem(Lrow, "out_store", sNull)
			Setitem(Lrow, "req_dept", 	sNull)
			Setitem(Lrow, "in_store", 	sNull)
			Setitem(Lrow, "naougu", 	sNull)
			Setitem(Lrow, "out_chk", 	sNull)
			return 1
		Else
			/* 외주출고 에 대한 출고구분을 검색 (외주사급출고는 1개이어야 한다). */
			Select iogbn into :sautvnd from iomatrix 
			 where sabu = :gs_sabu and autvnd = 'Y';
			 
			if sqlca.sqlcode <> 0 then
				Messagebox("외주사급출고", "사급출고구분을 검색할 수 없읍니다", stopsign!)
				Setitem(Lrow, "opseq", 		sNull)
				Setitem(Lrow, "opdsc", 		sNull)
				Setitem(Lrow, "hold_gu", 	sNull)
				Setitem(Lrow, "out_store", sNull)
				Setitem(Lrow, "req_dept", 	sNull)
				Setitem(Lrow, "in_store", 	sNull)
				Setitem(Lrow, "naougu", 	sNull)
				Setitem(Lrow, "out_chk", 	sNull)
				return 1				
			end if
			 
			sRqdat = dw_head.getitemstring(1, "esdat")			
			sCvcod = dw_head.getitemstring(1, "cvcod")

			Setitem(Lrow, "hold_gu", 		sautvnd)
			Setitem(Lrow, "rqdat", 	 		sRqdat)
			Setitem(Lrow, "out_store", 	sCvcod)
			Setitem(Lrow, "in_store", 		sCvcod)
			
			select cvnas2 into :sCvnas from vndmst
			 Where cvcod = :sCvcod;
			 
			if sqlca.sqlcode <> 0 then
				Messagebox("외주거래처", "외주거래처를 검색할 수 없읍니다", stopsign!)
				Setitem(Lrow, "opseq", 		sNull)
				Setitem(Lrow, "opdsc", 		sNull)
				Setitem(Lrow, "hold_gu", 	sNull)
				Setitem(Lrow, "out_store", sNull)
				Setitem(Lrow, "req_dept", 	sNull)
				Setitem(Lrow, "in_store", 	sNull)
				Setitem(Lrow, "naougu", 	sNull)
				Setitem(Lrow, "out_chk", 	sNull)
				return 1				
			end if			 
			 
			Setitem(Lrow, "cvnas", sCvnas)
			Setitem(Lrow, "naougu",   '2')
			Setitem(Lrow, "out_chk",  '2')
			return
		End if
	End if
	
	/* 공정검색 */
	stditnbr	= dw_head.getitemstring(1, "stditnbr")
	Select opdsc, purgc into :sOpdsc, :spurgc 
	  from morout_copy
	 Where sabu = :gs_sabu And pordno = :spordno And opseq = :sOpseq;
	If sqlca.sqlcode <> 0 then
		Messagebox("공정", "해당품목에 공정순서가 없읍니다", stopsign!)
		Setitem(Lrow, "opseq", 		sNull)
		Setitem(Lrow, "opdsc", 		sNull)
		Setitem(Lrow, "hold_gu", 	sNull)
		Setitem(Lrow, "out_store", sNull)
		Setitem(Lrow, "req_dept", 	sNull)
		Setitem(Lrow, "in_store", 	sNull)
		Setitem(Lrow, "naougu", 	sNull)
		Setitem(Lrow, "out_chk", 	sNull)
		return 1
	End if
	
	/* 작업지시 공정검색 */
	Select purgc, wicvcod, esdat into :sPurgc, :scvcod, :sRqdat 
	  from morout_copy
	 Where sabu = :gs_sabu and pordno = :sPordno and opseq = :soPseq;
	If sqlca.sqlcode <> 0 then
		Messagebox("공정", "작업지시되지 않은 공정입니다.", stopsign!)
		Setitem(Lrow, "opseq", 		sNull)
		Setitem(Lrow, "opdsc", 		sNull)
		Setitem(Lrow, "hold_gu", 	sNull)
		Setitem(Lrow, "out_store", sNull)
		Setitem(Lrow, "req_dept", 	sNull)
		Setitem(Lrow, "in_store", 	sNull)
		Setitem(Lrow, "naougu", 	sNull)
		Setitem(Lrow, "out_chk", 	sNull)
		return 1
	End if

	Setitem(Lrow, "opdsc", sOpdsc)
	
	if spurgc = 'N' then
		
		Select iogbn into :sautvnd from iomatrix 
		 where sabu = :gs_sabu and autpdt = 'Y';
		 
		If sqlca.sqlcode <> 0 then
			Messagebox("할당구분", "할당구분을 검색할 수 없읍니다.", stopsign!)
			Setitem(Lrow, "opseq", 		sNull)
			Setitem(Lrow, "opdsc", 		sNull)
			Setitem(Lrow, "hold_gu", 	sNull)
			Setitem(Lrow, "out_store", sNull)
			Setitem(Lrow, "req_dept", 	sNull)
			Setitem(Lrow, "in_store", 	sNull)
			Setitem(Lrow, "naougu", 	sNull)
			Setitem(Lrow, "out_chk", 	sNull)
			return 1
		End if		 

		Setitem(Lrow, "Out_store", sDepot_no)
		
		select cvnas2 into :sCvnas from vndmst
		 Where cvcod = :sDepot_no;
		 
		if sqlca.sqlcode <> 0 then
			Messagebox("소진처창고", "소진처창고를 검색할 수 없읍니다", stopsign!)
			Setitem(Lrow, "opseq", 		sNull)
			Setitem(Lrow, "opdsc", 		sNull)
			Setitem(Lrow, "hold_gu", 	sNull)
			Setitem(Lrow, "out_store", sNull)
			Setitem(Lrow, "req_dept", 	sNull)
			Setitem(Lrow, "in_store", 	sNull)
			Setitem(Lrow, "naougu", 	sNull)
			Setitem(Lrow, "out_chk", 	sNull)
			return 1				
		end if			 
		 
		Setitem(Lrow, "cvnas", sCvnas)
		Setitem(Lrow, "hold_gu",  	sAutvnd)
		Setitem(Lrow, "in_store", 	sNull)
		Setitem(Lrow, "rqdat", 		sRqdat)
		Setitem(Lrow, "naougu",   '1')
		Setitem(Lrow, "out_chk",  '1')
	Else
		
		Select iogbn into :sautvnd from iomatrix 
		 where sabu = :gs_sabu and autvnd = 'Y';		
		 
		If sqlca.sqlcode <> 0 then
			Messagebox("사급구분", "사급구분을 검색할 수 없읍니다.", stopsign!)
			Setitem(Lrow, "opseq", 		sNull)
			Setitem(Lrow, "opdsc", 		sNull)
			Setitem(Lrow, "hold_gu", 	sNull)
			Setitem(Lrow, "out_store", sNull)
			Setitem(Lrow, "req_dept", 	sNull)
			Setitem(Lrow, "in_store", 	sNull)
			Setitem(Lrow, "naougu", 	sNull)
			Setitem(Lrow, "out_chk", 	sNull)
			return 1
		End if		 		 
		
		Setitem(Lrow, "Out_store", sCvcod)		

		select cvnas2 into :sCvnas from vndmst
		 Where cvcod = :sCvcod;
		 
		if sqlca.sqlcode <> 0 then
			Messagebox("외주거래처", "외주거래처를 검색할 수 없읍니다", stopsign!)
			Setitem(Lrow, "opseq", 		sNull)
			Setitem(Lrow, "opdsc", 		sNull)
			Setitem(Lrow, "hold_gu", 	sNull)
			Setitem(Lrow, "out_store", sNull)
			Setitem(Lrow, "req_dept", 	sNull)
			Setitem(Lrow, "in_store", 	sNull)
			Setitem(Lrow, "naougu", 	sNull)
			Setitem(Lrow, "out_chk", 	sNull)
			return 1				
		end if			 
		 
		Setitem(Lrow, "cvnas", 		sCvnas)
		Setitem(Lrow, "hold_gu",  	sAutvnd)		
		Setitem(Lrow, "in_store", 	sCvcod)
		Setitem(Lrow, "rqdat", 		sRqdat)
		Setitem(Lrow, "naougu",   '2')
		Setitem(Lrow, "out_chk",  '2')
	End if

	RETURN ireturn
ElseIF GetColumnName() = "itnbr"	THEN
	sItnbr = trim(GetText())
	ireturn = f_get_name4('품번', 'Y', sitnbr, sitdsc, sispec, sjijil, sispec_code)
	setitem(lrow, "itnbr", sitnbr)	
	setitem(lrow, "itdsc", sitdsc)	
	setitem(lrow, "ispec", sispec)
	setitem(lrow, "jijil", sjijil)	
	setitem(lrow, "ispec_code", sispec_code)
	
	// 품목구분을 검색하여 할당창고를 저장
	if ireturn = 0 then
		select ittyp into :sittyp from itemas where itnbr = :sitnbr;
		if sittyp = '2' then
			setitem(lrow, "hold_store", sban)
			sgijun = sban
		else
			setitem(lrow, "hold_store", sjaje)			
			sgijun = sjaje
		end if 
		
		select cvnas into :shname
		  from vndmst where cvcod = :sgijun;		
		 setitem(lrow, "vndmst_cvnas", shname)

		// 전체창고 현재고
		dJego_qty 	= 0;
		dValid_qty	= 0;
		sPspec		= tab_1.tabpage_4.dw_jego.getitemstring(Lrow, "pspec")
		select sum(nvl(jego_qty, 0)), sum(nvl(valid_qty, 0)) into :djego_qty, :dvalid_qty
		  from stock
		 where itnbr = :sItnbr and pspec = :sPspec;
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "jego_qty", 						dJego_qty)
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "holdstock_copy_prgo_qty", 	dvalid_qty)
		
		// 관리창고 현재고
		dJego_qty 	= 0;
		select nvl(jego_qty, 0) into :djego_qty 
		  from stock
		 where depot_no = :sgijun and itnbr = :sItnbr and pspec = :sPspec;
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "stock_valid_qty", 			dJego_qty)
		
		// 업체창고 현재고, 가용재고
		dupjego 	= 0
		dupvalid	= 0
		sout_store	= tab_1.tabpage_4.dw_jego.getitemstring(Lrow, "out_store")		
		select sum(nvl(jego_qty, 0)), sum(nvl(jego_qty - hold_qty, 0))
		  into :dupjego, :dupvalid
		  from stock_vendor
		 where cvcod = :sout_store and itnbr = :sitnbr and pspec = :spspec;
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "ven_jego", dupjego)
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "ven_valid", dupvalid)		
		
	end if
	
//	tab_1.tabpage_4.dw_jego.setitem(lrow, "itnbr", sitnbr)	
//	tab_1.tabpage_4.dw_jego.setitem(lrow, "itdsc", sitdsc)	
//	tab_1.tabpage_4.dw_jego.setitem(lrow, "ispec", sispec)	
	RETURN ireturn
ELSEIF GetColumnName() = "itdsc"	THEN
	sItdsc = trim(GetText())
	ireturn = f_get_name4('품명', 'Y', sitnbr, sitdsc, sispec, sjijil, sispec_code)
	setitem(lrow, "itnbr", sitnbr)	
	setitem(lrow, "itdsc", sitdsc)	
	setitem(lrow, "ispec", sispec)
	setitem(lrow, "jijil", sjijil)	
	setitem(lrow, "ispec_code", sispec_code)
	
	// 품목구분을 검색하여 할당창고를 저장
	if ireturn = 0 then
		select ittyp into :sittyp from itemas where itnbr = :sitnbr;
		if sittyp = '2' then
			setitem(lrow, "hold_store", sban)
			sgijun = sban
		else
			setitem(lrow, "hold_store", sjaje)			
			sgijun = sjaje
		end if 
		
		select cvnas into :shname
		  from vndmst where cvcod = :sgijun;		
		 setitem(lrow, "vndmst_cvnas", shname)		
		
		// 전체창고 현재고
		dJego_qty 	= 0
		dValid_qty	= 0 
		sPspec		= tab_1.tabpage_4.dw_jego.getitemstring(Lrow, "pspec")
		select sum(nvl(jego_qty, 0)), sum(nvl(valid_qty, 0)) into :djego_qty, :dvalid_qty
		  from stock
		 where itnbr = :sItnbr and pspec = :sPspec;
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "jego_qty", 						dJego_qty)
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "holdstock_copy_prgo_qty", 	dvalid_qty)
		
		// 관리창고 현재고
		dJego_qty 	= 0
		select nvl(jego_qty, 0) into :djego_qty 
		  from stock
		 where depot_no = :sgijun and itnbr = :sItnbr and pspec = :sPspec;
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "stock_valid_qty", 			dJego_qty)	
		
		// 업체창고 현재고, 가용재고
		dupjego 	= 0
		dupvalid	= 0
		sout_store	= tab_1.tabpage_4.dw_jego.getitemstring(Lrow, "out_store")		
		select sum(nvl(jego_qty, 0)), sum(nvl(jego_qty - hold_qty, 0))
		  into :dupjego, :dupvalid
		  from stock_vendor
		 where cvcod = :sout_store and itnbr = :sitnbr and pspec = :spspec;
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "ven_jego", dupjego)
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "ven_valid", dupvalid)
	end if	
	
	RETURN ireturn
ELSEIF GetColumnName() = "ispec"	THEN
	sIspec = trim(GetText())
	ireturn = f_get_name4('규격', 'Y', sitnbr, sitdsc, sispec, sjijil, sispec_code)
	setitem(lrow, "itnbr", sitnbr)	
	setitem(lrow, "itdsc", sitdsc)	
	setitem(lrow, "ispec", sispec)
	setitem(lrow, "jijil", sjijil)	
	setitem(lrow, "ispec_code", sispec_code)
	
	// 품목구분을 검색하여 할당창고를 저장
	if ireturn = 0 then
		select ittyp into :sittyp from itemas where itnbr = :sitnbr;
		if sittyp = '2' then
			setitem(lrow, "hold_store", sban)
			sgijun = sban
		else
			setitem(lrow, "hold_store", sjaje)			
			sgijun = sjaje
		end if 
		
		select cvnas into :shname
		  from vndmst where cvcod = :sgijun;		
		 setitem(lrow, "vndmst_cvnas", shname)		
		
		// 전체창고 현재고
		dJego_qty 	= 0;
		dValid_qty	= 0;
		sPspec		= tab_1.tabpage_4.dw_jego.getitemstring(Lrow, "pspec")
		select sum(nvl(jego_qty, 0)), sum(nvl(valid_qty, 0)) into :djego_qty, :dvalid_qty
		  from stock
		 where itnbr = :sItnbr and pspec = :sPspec;
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "jego_qty", 						dJego_qty)
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "holdstock_copy_prgo_qty", 	dvalid_qty)
		
		// 관리창고 현재고
		dJego_qty 	= 0;
		select nvl(jego_qty, 0) into :djego_qty 
		  from stock
		 where depot_no = :sgijun and itnbr = :sItnbr and pspec = :sPspec;
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "stock_valid_qty", 			dJego_qty)		
		
		// 업체창고 현재고, 가용재고
		dupjego 	= 0
		dupvalid	= 0
		sout_store	= tab_1.tabpage_4.dw_jego.getitemstring(Lrow, "out_store")		
		select sum(nvl(jego_qty, 0)), sum(nvl(jego_qty - hold_qty, 0))
		  into :dupjego, :dupvalid
		  from stock_vendor
		 where cvcod = :sout_store and itnbr = :sitnbr and pspec = :spspec;
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "ven_jego", dupjego)
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "ven_valid", dupvalid)		
	end if	
	RETURN ireturn
ELSEIF GetColumnName() = "jijil"	THEN
	sjijil = trim(GetText())
	ireturn = f_get_name4('재질', 'Y', sitnbr, sitdsc, sispec, sjijil, sispec_code)
	setitem(lrow, "itnbr", sitnbr)	
	setitem(lrow, "itdsc", sitdsc)	
	setitem(lrow, "ispec", sispec)
	setitem(lrow, "jijil", sjijil)	
	setitem(lrow, "ispec_code", sispec_code)
	
	// 품목구분을 검색하여 할당창고를 저장
	if ireturn = 0 then
		select ittyp into :sittyp from itemas where itnbr = :sitnbr;
		if sittyp = '2' then
			setitem(lrow, "hold_store", sban)
			sgijun = sban
		else
			setitem(lrow, "hold_store", sjaje)			
			sgijun = sjaje
		end if 
		
		select cvnas into :shname
		  from vndmst where cvcod = :sgijun;		
		 setitem(lrow, "vndmst_cvnas", shname)		
		
		// 전체창고 현재고
		dJego_qty 	= 0;
		dValid_qty	= 0;
		sPspec		= tab_1.tabpage_4.dw_jego.getitemstring(Lrow, "pspec")
		select sum(nvl(jego_qty, 0)), sum(nvl(valid_qty, 0)) into :djego_qty, :dvalid_qty
		  from stock
		 where itnbr = :sItnbr and pspec = :sPspec;
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "jego_qty", 						dJego_qty)
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "holdstock_copy_prgo_qty", 	dvalid_qty)
		
		// 관리창고 현재고
		dJego_qty 	= 0;
		select nvl(jego_qty, 0) into :djego_qty 
		  from stock
		 where depot_no = :sgijun and itnbr = :sItnbr and pspec = :sPspec;
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "stock_valid_qty", 			dJego_qty)		
		
		// 업체창고 현재고, 가용재고
		dupjego 	= 0
		dupvalid	= 0
		sout_store	= tab_1.tabpage_4.dw_jego.getitemstring(Lrow, "out_store")		
		select sum(nvl(jego_qty, 0)), sum(nvl(jego_qty - hold_qty, 0))
		  into :dupjego, :dupvalid
		  from stock_vendor
		 where cvcod = :sout_store and itnbr = :sitnbr and pspec = :spspec;
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "ven_jego", dupjego)
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "ven_valid", dupvalid)		
	end if	
	RETURN ireturn
ELSEIF GetColumnName() = "ispec_code"	THEN
	sIspec_code = trim(GetText())
	ireturn = f_get_name4('규격코드', 'Y', sitnbr, sitdsc, sispec, sjijil, sispec_code)
	setitem(lrow, "itnbr", sitnbr)	
	setitem(lrow, "itdsc", sitdsc)	
	setitem(lrow, "ispec", sispec)
	setitem(lrow, "jijil", sjijil)	
	setitem(lrow, "ispec_code", sispec_code)
	
	// 품목구분을 검색하여 할당창고를 저장
	if ireturn = 0 then
		select ittyp into :sittyp from itemas where itnbr = :sitnbr;
		if sittyp = '2' then
			setitem(lrow, "hold_store", sban)
			sgijun = sban
		else
			setitem(lrow, "hold_store", sjaje)			
			sgijun = sjaje
		end if 
		
		select cvnas into :shname
		  from vndmst where cvcod = :sgijun;		
		 setitem(lrow, "vndmst_cvnas", shname)		
		
		// 전체창고 현재고
		dJego_qty 	= 0;
		dValid_qty	= 0;
		sPspec		= tab_1.tabpage_4.dw_jego.getitemstring(Lrow, "pspec")
		select sum(nvl(jego_qty, 0)), sum(nvl(valid_qty, 0)) into :djego_qty, :dvalid_qty
		  from stock
		 where itnbr = :sItnbr and pspec = :sPspec;
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "jego_qty", 						dJego_qty)
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "holdstock_copy_prgo_qty", 	dvalid_qty)
		
		// 관리창고 현재고
		dJego_qty 	= 0;
		select nvl(jego_qty, 0) into :djego_qty 
		  from stock
		 where depot_no = :sgijun and itnbr = :sItnbr and pspec = :sPspec;
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "stock_valid_qty", 			dJego_qty)		
		
		// 업체창고 현재고, 가용재고
		dupjego 	= 0
		dupvalid	= 0
		sout_store	= tab_1.tabpage_4.dw_jego.getitemstring(Lrow, "out_store")		
		select sum(nvl(jego_qty, 0)), sum(nvl(jego_qty - hold_qty, 0))
		  into :dupjego, :dupvalid
		  from stock_vendor
		 where cvcod = :sout_store and itnbr = :sitnbr and pspec = :spspec;
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "ven_jego", dupjego)
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "ven_valid", dupvalid)		
	end if	
	RETURN ireturn
ELSEIF GetColumnName() = "pspec"	THEN
	spspec = trim(GetText())
	sitnbr = getitemstring(lrow, "itnbr")
	sitdsc = getitemstring(lrow, "itdsc")
	sispec = getitemstring(lrow, "ispec")
	
	// 품목구분을 검색하여 할당창고를 저장
	if ireturn = 0 then
		select ittyp into :sittyp from itemas where itnbr = :sitnbr;
		if sittyp = '2' then
			setitem(lrow, "hold_store", sban)
			sgijun = sban
		else
			setitem(lrow, "hold_store", sjaje)			
			sgijun = sjaje
		end if 
		
		select cvnas into :shname
		  from vndmst where cvcod = :sgijun;		
		 setitem(lrow, "vndmst_cvnas", shname)		
		
		// 전체창고 현재고
		dJego_qty 	= 0;
		dValid_qty	= 0;
		select sum(nvl(jego_qty, 0)), sum(nvl(valid_qty, 0)) into :djego_qty, :dvalid_qty
		  from stock
		 where itnbr = :sItnbr and pspec = :sPspec;
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "jego_qty", 						dJego_qty)
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "holdstock_copy_prgo_qty", 	dvalid_qty)
		
		// 관리창고 현재고
		dJego_qty 	= 0;
		select nvl(jego_qty, 0) into :djego_qty 
		  from stock
		 where depot_no = :sgijun and itnbr = :sItnbr and pspec = :sPspec;
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "stock_valid_qty", 			dJego_qty)		
		
		// 업체창고 현재고, 가용재고
		dupjego 	= 0
		dupvalid	= 0
		sout_store	= tab_1.tabpage_4.dw_jego.getitemstring(Lrow, "out_store")		
		select sum(nvl(jego_qty, 0)), sum(nvl(jego_qty - hold_qty, 0))
		  into :dupjego, :dupvalid
		  from stock_vendor
		 where cvcod = :sout_store and itnbr = :sitnbr and pspec = :spspec;
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "ven_jego", dupjego)
		tab_1.tabpage_4.dw_jego.setitem(Lrow, "ven_valid", dupvalid)		
		
	end if	
	
	RETURN ireturn	
ELSEIF GetColumnName() = "heybin4"	THEN	
	L2row = tab_1.tabpage_2.dw_tabpage2.getrow()
	djego_qty = Dec(gettext())
	dvalid_qty = tab_1.tabpage_2.dw_tabpage2.getitemdecimal(L2row, "momast_copy_mocnt")
	setitem(Lrow, "hold_qty", djego_qty * dvalid_qty)
ELSEIF GetColumnName() = "out_store"	THEN
	sout_store = trim(GetText())
	sban = getitemstring(Lrow, "hold_gu")
	
	Select autvnd into :sautvnd
	  From iomatrix where sabu = :gs_sabu And iogbn = :sBan;
	  
	select cvgu, cvnas into :sittyp, :sgijun
	  from vndmst where cvcod = :sout_store;
	if sqlca.sqlcode <> 0 then
		Messagebox("소진처", "코드가 부정확합니다", stopsign!)
		setitem(Lrow, "out_store", snull)
		setitem(Lrow, "cvnas",     snull)
		return 1
	Elseif sautvnd = 'N' and sittyp <> '5' then		// 생산출고인데 소진처가 창고가 아니면 error
		Messagebox("소진처", "사내제작이므로 창고코드를 선택하십시요", stopsign!)
		setitem(Lrow, "out_store", snull)
		setitem(Lrow, "cvnas",     snull)		
		return 1		
	Elseif sautvnd = 'Y' and sittyp =  '5' then		// 생산출고인데 소진처가 창고이면      error		
		Messagebox("소진처", "외주사급이므로 거래처코드를 선택하십시요", stopsign!)
		setitem(Lrow, "out_store", snull)
		setitem(Lrow, "cvnas",     snull)		
		return 1	
	Else
		setitem(Lrow, "cvnas", sgijun)
	End if
ELSEIF GetColumnName() = "hold_store"	THEN
	
	sout_store = trim(GetText())
	sban = getitemstring(Lrow, "hold_gu")
	
	Select autvnd into :sautvnd
	  From iomatrix where sabu = :gs_sabu And iogbn = :sBan;
	  
	select cvgu, cvnas into :sittyp, :sgijun
	  from vndmst where cvcod = :sout_store;
	if sqlca.sqlcode <> 0 then
		Messagebox("출고요청처", "코드가 부정확합니다", stopsign!)
		setitem(Lrow, "hold_store",   snull)
		setitem(Lrow, "vndmst_cvnas", snull)		
		return 1
	Elseif sautvnd = 'N' and sittyp <> '5' then		// 생산출고인데 소진처가 창고가 아니면 error
		Messagebox("출고요청처", "사내제작이므로 창고코드를 선택하십시요", stopsign!)
		setitem(Lrow, "hold_store",   snull)
		setitem(Lrow, "vndmst_cvnas", snull)
		return 1		
	Elseif sautvnd = 'Y' and sittyp =  '5' then		// 생산출고인데 소진처가 창고이면      error		
		Messagebox("출고요청처", "외주사급이므로 거래처코드를 선택하십시요", stopsign!)
		setitem(Lrow, "hold_store",   snull)
		setitem(Lrow, "vndmst_cvnas", snull)
		return 1				
	Else
		setitem(Lrow, "vndmst_cvnas", sgijun)				
	End if	
End if

end event

event rbuttondown;String colname
Long   lrow

SetNull(gs_gubun)
SetNull(gs_code)
SetNull(gs_codename)

colname = this.getcolumnname()
lrow	  = this.getrow()
if this.accepttext() = -1 then return

if colname = "itnbr" or colname = "itdcs" or colname = "ispec" then
   gs_code = this.getitemstring(lrow, "itnbr")
	open(w_itemas_popup)
	
	if isnull(gs_code) or gs_code = "" then return
	
	this.SetItem(lrow,"itnbr",gs_code)
	this.TriggerEvent(ItemChanged!)
elseif colname = 'out_store' then
   gs_code = this.getitemstring(lrow, "out_store")
	open(w_vndmst_popup)
	
	if isnull(gs_code) or gs_code = "" then return
	
	this.SetItem(lrow,"out_store",gs_code)
	this.TriggerEvent(ItemChanged!)	
elseif colname = 'hold_store' then
   gs_code = this.getitemstring(lrow, "hold_store")
	open(w_vndmst_popup)
	
	if isnull(gs_code) or gs_code = "" then return
	
	this.SetItem(lrow,"hold_store",gs_code)
	this.TriggerEvent(ItemChanged!)		
end if

end event

event itemerror;return 1
end event

event updatestart;/* Update() function 호출시 user 설정 */
long k, lRowCount

lRowCount = this.RowCount()

FOR k = 1 TO lRowCount
   IF NewModified! = this.GetItemStatus(k, 0, Primary!) THEN
 	   This.SetItem(k,'crt_user',gs_userid)
   ELSEIF DataModified! = this.GetItemStatus(k, 0, Primary!) THEN 		
	   This.SetItem(k,'upd_user',gs_userid)
   END IF	  
NEXT


end event

event doubleclicked;Long Lrow, lReq
string sitnbr

Lrow = getrow()

if Lrow > 0 then
	
	Lreq =  Messagebox("대체품 & 재고정보" ,"대체품 재고정보를 보시겠읍니까?", question!, yesnocancel!)
	
	if Lreq = 1 then
		gs_code = getitemstring(Lrow, "itnbr")
		open(w_pdt_07200_5)
	Elseif lreq = 2 then
		gs_code 		= getitemstring(Lrow, "itnbr")
		gs_codename = getitemstring(Lrow, "itdsc")
		if isnull(gs_code) or trim(gs_code) = '' or isnull(gs_codename) or trim(gs_codename) = '' then
			return
		end if
		open(w_pdt_04000_1)
		setnull(gs_code)
		setnull(gs_codename)	
	End if
	
end if
end event

type dw_head from datawindow within tabpage_4
integer x = 23
integer y = 32
integer width = 3831
integer height = 228
integer taborder = 40
string dataobject = "d_pdt_02030_14"
boolean border = false
boolean livescroll = true
end type

type tabpage_5 from userobject within tab_1
event create ( )
event destroy ( )
integer x = 18
integer y = 108
integer width = 4521
integer height = 2040
boolean enabled = false
long backcolor = 32106727
string text = "부하검토"
long tabtextcolor = 33554432
long tabbackcolor = 32106727
long picturemaskcolor = 536870912
rr_11 rr_11
rr_10 rr_10
gb_4 gb_4
dw_buha1 dw_buha1
gb_12 gb_12
tv_1 tv_1
dw_buha2 dw_buha2
pb_graph pb_graph
pb_space pb_space
p_print1 p_print1
p_retrieve1 p_retrieve1
rb_1 rb_1
rb_data rb_data
rb_graph rb_graph
dw_buha3 dw_buha3
end type

on tabpage_5.create
this.rr_11=create rr_11
this.rr_10=create rr_10
this.gb_4=create gb_4
this.dw_buha1=create dw_buha1
this.gb_12=create gb_12
this.tv_1=create tv_1
this.dw_buha2=create dw_buha2
this.pb_graph=create pb_graph
this.pb_space=create pb_space
this.p_print1=create p_print1
this.p_retrieve1=create p_retrieve1
this.rb_1=create rb_1
this.rb_data=create rb_data
this.rb_graph=create rb_graph
this.dw_buha3=create dw_buha3
this.Control[]={this.rr_11,&
this.rr_10,&
this.gb_4,&
this.dw_buha1,&
this.gb_12,&
this.tv_1,&
this.dw_buha2,&
this.pb_graph,&
this.pb_space,&
this.p_print1,&
this.p_retrieve1,&
this.rb_1,&
this.rb_data,&
this.rb_graph,&
this.dw_buha3}
end on

on tabpage_5.destroy
destroy(this.rr_11)
destroy(this.rr_10)
destroy(this.gb_4)
destroy(this.dw_buha1)
destroy(this.gb_12)
destroy(this.tv_1)
destroy(this.dw_buha2)
destroy(this.pb_graph)
destroy(this.pb_space)
destroy(this.p_print1)
destroy(this.p_retrieve1)
destroy(this.rb_1)
destroy(this.rb_data)
destroy(this.rb_graph)
destroy(this.dw_buha3)
end on

type rr_11 from roundrectangle within tabpage_5
long linecolor = 28144969
integer linethickness = 1
long fillcolor = 32106727
integer x = 937
integer y = 200
integer width = 3493
integer height = 1820
integer cornerheight = 40
integer cornerwidth = 55
end type

type rr_10 from roundrectangle within tabpage_5
long linecolor = 28144969
integer linethickness = 1
long fillcolor = 33027312
integer x = 46
integer y = 200
integer width = 855
integer height = 1820
integer cornerheight = 40
integer cornerwidth = 55
end type

type gb_4 from groupbox within tabpage_5
integer x = 87
integer y = 340
integer width = 773
integer height = 116
integer taborder = 20
integer textsize = -2
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 33027312
end type

type dw_buha1 from datawindow within tabpage_5
event ue_key pbm_dwnkey
event ue_presssenter pbm_dwnprocessenter
integer x = 119
integer y = 356
integer width = 704
integer height = 88
integer taborder = 50
boolean bringtotop = true
string dataobject = "d_pdt_02605_00_1"
boolean border = false
boolean livescroll = true
end type

event ue_key;IF keydown(keyF1!) THEN
	TriggerEvent(RbuttonDown!)
END IF
end event

event ue_presssenter;Send(Handle(this),256,9,0)
Return 1
end event

event itemchanged;if dwo.name = "gu2" then
	if dec(gettext()) < getitemdecimal(1, "gu1") then
		MessageBox("구간", "구간의 범위가 부정확합니다", stopsign!)
		setitem(1, "gu2", 10)
		return 1
	end if
end if
end event

event itemerror;RETURN 1
end event

event rbuttondown;Long  Curr_Row

Curr_Row  =  GetRow()

IF this.GetColumnName() = "gu1" THEN
	Open(w_gugan_popup)
   
	IF isnull(gs_code) OR gs_code = '' THEN RETURN
   SetItem(Curr_Row,"gu1",gs_code) 

ELSEIF this.GetColumnName() = "gu2" THEN
	Open(w_gugan_popup)
   
	IF isnull(gs_code) OR gs_code = '' THEN RETURN
   SetItem(Curr_Row,"gu2",gs_code) 

END IF
end event

type gb_12 from groupbox within tabpage_5
integer x = 87
integer y = 220
integer width = 773
integer height = 108
integer taborder = 70
integer textsize = -2
integer weight = 700
fontcharset fontcharset = hangeul!
fontpitch fontpitch = fixed!
fontfamily fontfamily = modern!
string facename = "굴림체"
long textcolor = 33554432
long backcolor = 33027312
end type

type tv_1 from treeview within tabpage_5
integer x = 82
integer y = 460
integer width = 777
integer height = 1536
integer taborder = 20
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = hangeul!
fontpitch fontpitch = fixed!
fontfamily fontfamily = modern!
string facename = "굴림체"
long textcolor = 33554432
long backcolor = 33027312
string picturename[] = {"ShowWatch5!","AddWatch5!","DeleteWatch5!"}
long picturemaskcolor = 553648127
string statepicturename[] = {"ShowWatch5!","AddWatch5!","DeleteWatch5!"}
long statepicturemaskcolor = 553648127
end type

event selectionchanged;Integer				i_main, i_sub1, i_sub2, i_loc, gu1, gu2
TreeViewItem		tv_Current
String            current_data, Ls_loc, Syymm
Long 					Lrow

tab_1.tabpage_5.dw_buha1.accepttext()
gu1 = tab_1.tabpage_5.dw_buha1.getitemdecimal(1, "gu1")
gu2 = tab_1.tabpage_5.dw_buha1.getitemdecimal(1, "gu2")

SetPointer(HourGlass!)

if isnull(syymm) or trim(syymm) = '' then
	syymm = '%'
else
	syymm = syymm + '%'
end if

/* 현재의 레벨을 구한다.**************************************************************/
this.GetItem(newhandle, tv_Current)

i_Level = tv_Current.Level

current_data = String(tv_Current.Data)
trscode = current_data
trsname = String(tv_Current.label)
p_retrieve1.triggerevent(clicked!)



end event

type dw_buha2 from datawindow within tabpage_5
integer x = 965
integer y = 208
integer width = 3397
integer height = 1776
integer taborder = 60
boolean bringtotop = true
string dataobject = "d_pdt_02605_01"
boolean hscrollbar = true
boolean vscrollbar = true
boolean border = false
boolean hsplitscroll = true
boolean livescroll = true
end type

type pb_graph from picturebutton within tabpage_5
integer x = 55
integer y = 16
integer width = 174
integer height = 160
integer taborder = 40
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = hangeul!
fontpitch fontpitch = fixed!
fontfamily fontfamily = modern!
string facename = "돋움체"
boolean enabled = false
boolean originalsize = true
string picturename = "C:\erpman\image\GRAPH.BMP"
string disabledname = "C:\erpman\image\falseGRAPH.bmp"
alignment htextalign = left!
end type

event clicked;SetPointer(HourGlass!)

// Open the response window to set the graph type. Pass it the graph
// object and it will do the rest.

OpenWithParm (w_graph_type, dw_buha2)

end event

type pb_space from picturebutton within tabpage_5
integer x = 229
integer y = 16
integer width = 174
integer height = 160
integer taborder = 30
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = hangeul!
fontpitch fontpitch = fixed!
fontfamily fontfamily = modern!
string facename = "돋움체"
boolean enabled = false
string picturename = "C:\erpman\image\SPACE.bmp"
string disabledname = "C:\erpman\image\falseSPACE.bmp"
alignment htextalign = left!
end type

event clicked;SetPointer(HourGlass!)

// Open the response window to set the graph type. Pass it the graph
// object and it will do the rest.
OpenWithParm (w_graph_spacing, dw_buha2)

end event

type p_print1 from picture within tabpage_5
event ue_mousemove pbm_mousemove
event ue_lbuttondown pbm_lbuttondown
event ue_lbuttonup pbm_lbuttonup
integer x = 4251
integer y = 32
integer width = 178
integer height = 144
boolean bringtotop = true
string pointer = "C:\erpman\cur\print.cur"
boolean enabled = false
string picturename = "C:\erpman\image\인쇄_d.gif"
boolean focusrectangle = false
end type

event ue_lbuttondown;iv_b_down = true
p_print1.PictureName = 'C:\erpman\image\조회1_dn.gif'

end event

event ue_lbuttonup;iv_b_down = false

p_print1.PictureName = 'C:\erpman\image\조회1_up.gif'

end event

event clicked;gi_page = dw_buha2.GetItemNumber(1,"last_page")
OpenWithParm(w_print_options, dw_buha2)


end event

type p_retrieve1 from picture within tabpage_5
event ue_mousemove pbm_mousemove
event ue_lbuttondown pbm_lbuttondown
event ue_lbuttonup pbm_lbuttonup
integer x = 4064
integer y = 32
integer width = 178
integer height = 144
boolean bringtotop = true
string pointer = "C:\erpman\cur\retrieve.cur"
boolean originalsize = true
string picturename = "C:\erpman\image\조회1_up.gif"
boolean focusrectangle = false
end type

event ue_lbuttondown;iv_b_down = true

PictureName = 'C:\erpman\image\조회1_dn.gif'

end event

event ue_lbuttonup;iv_b_down = false
PictureName = 'C:\erpman\image\조회1_up.gif'
end event

event clicked;if rb_graph.checked then
	wf_treeview_retrieve()
elseif rb_data.checked then
	wf_treeview_retrieve1()	
else
	wf_treeview_retrieve2()		
end if
end event

type rb_1 from radiobutton within tabpage_5
integer x = 622
integer y = 240
integer width = 219
integer height = 76
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = hangeul!
fontpitch fontpitch = fixed!
fontfamily fontfamily = modern!
string facename = "굴림체"
long textcolor = 33554432
long backcolor = 33027312
string text = "일정"
end type

event clicked;tv_1.visible = false
gb_4.visible = false
dw_buha1.visible = false
dw_buha3.visible = false

tab_1.tabpage_5.pb_graph.enabled = false
tab_1.tabpage_5.pb_space.enabled = false




end event

type rb_data from radiobutton within tabpage_5
integer x = 398
integer y = 240
integer width = 219
integer height = 76
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = hangeul!
fontpitch fontpitch = fixed!
fontfamily fontfamily = modern!
string facename = "굴림체"
long textcolor = 33554432
long backcolor = 33027312
string text = "자료"
end type

event clicked;tv_1.visible = false
gb_4.visible = false
dw_buha1.visible = false

tab_1.tabpage_5.pb_graph.enabled = false
tab_1.tabpage_5.pb_space.enabled = false

dw_buha3.reset()
dw_buha3.insertrow(0)
dw_buha3.visible = true

end event

type rb_graph from radiobutton within tabpage_5
integer x = 105
integer y = 240
integer width = 279
integer height = 76
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = hangeul!
fontpitch fontpitch = fixed!
fontfamily fontfamily = modern!
string facename = "굴림체"
long textcolor = 33554432
long backcolor = 33027312
string text = "그래프"
boolean checked = true
end type

event clicked;tv_1.visible = true
gb_4.visible = true
dw_buha1.visible = true
dw_buha3.visible = false
end event

type dw_buha3 from datawindow within tabpage_5
event ue_key pbm_dwnkey
event ue_pressenter pbm_dwnprocessenter
boolean visible = false
integer x = 78
integer y = 336
integer width = 791
integer height = 1672
integer taborder = 20
boolean bringtotop = true
string dataobject = "d_pdt_02600_00"
boolean border = false
boolean livescroll = true
end type

event ue_key;IF keydown(keyF1!) THEN
	TriggerEvent(RbuttonDown!)
END IF
end event

event ue_pressenter;send(handle(this), 256, 9, 0)

return 1
end event

event itemchanged;String sJoCode,Joname,snull,sGuCode,sGugan, sgubun

sgubun = getitemstring(1, "gubun")

if this.getcolumnname() = "gubun" then
	setitem(1, "jo1", snull)
	setitem(1, "joname1", snull)
	setitem(1, "jo2", snull)
	setitem(1, "joname2", snull)	
elseIF THIS.GetColumnName() = "jo1" THEN
	 sJoCode = this.GetText()
	 
	IF sJoCode = "" or isnull(sJoCode) then 
		this.setitem(1,"jo1",snull)
		this.setitem(1,"joname1",snull)		
		return
	END IF
	
	choose case sgubun 
			 case '1'
					this.setitem(1,"joname1",f_get_reffer('03',sjocode))
			 case '2'
					SELECT  JOMAST.JONAM
					  INTO :Joname
					  FROM  JOMAST 
					 WHERE  JOMAST.JOCOD = :sJoCode ;
 
					this.setitem(1,"joname1",Joname)
			 case '3'
					SELECT  wcdsc
					  INTO :Joname
					  FROM  wrkctr
					 WHERE  wkctr = :sJoCode ;
 
					this.setitem(1,"joname1",Joname)								
			 case '4'
					this.setitem(1,"joname1",f_get_reffer('21',sjocode))				
			 case '5'  // 작업지시인 경우에는 현재의 작업지시번호를 준다
					this.object.text_ordno.visible = 0				
					this.object.pordno.visible = 0
	End choose
	
ELSEIF THIS.GetColumnName() = "jo2" THEN
	 sJoCode = this.GetText()
	 
	IF sJoCode = "" or isnull(sJoCode) then 
		this.setitem(1,"jo2",snull)
		this.setitem(1,"joname2",snull)		
		return
	END IF

	choose case sgubun 
			 case '1'
					this.setitem(1,"joname2",f_get_reffer('03',sjocode))
			 case '2'
					SELECT  JOMAST.JONAM
					  INTO :Joname
					  FROM  JOMAST 
					 WHERE  JOMAST.JOCOD = :sJoCode ;
 
					this.setitem(1,"joname2",Joname)
			 case '3'
					SELECT  wcdsc
					  INTO :Joname
					  FROM  wrkctr
					 WHERE  wkctr = :sJoCode ;
 
					this.setitem(1,"joname2",Joname)								
			 case '4'
					this.setitem(1,"joname2",f_get_reffer('21',sjocode))				
	End choose

ELSEIF this.GetColumnName() = "gu1" THEN      
	 sGuCode = THIS.GetText()
	 
	 IF sGuCode = '' OR ISNULL(sGuCode) THEN
	    MessageBox("확인","구간을 입력하세요")
		 dw_buha3.SetColumn("gu1") 
		 dw_buha3.SetFocus()
		 Return 1 
	 ELSE
		 SELECT RESCAL.GUGAN 
	     INTO: sGugan	
	     FROM RESCAL   	
	    WHERE RESCAL.GUGAN = :sGuCode ; 
		 IF SQLCA.SQLCODE <> 0 THEN
			 MessageBox("확인","등록되어있지 않은 구간입니다")
			 dw_buha3.SetItem(1,"gu1",SNull)
			 dw_buha3.SetFocus()
		    Return 1 
		 END IF	
	 END IF	
ELSEIF this.GetColumnName() = "gu2" THEN      
	 sGuCode = THIS.GetText()
	 
	 IF sGuCode = '' OR ISNULL(sGuCode) THEN
	    MessageBox("확인","구간을 입력하세요")
		 dw_buha3.SetColumn("gu2") 
		 dw_buha3.SetFocus()
		 Return 1 
	 ELSE
		 SELECT RESCAL.GUGAN 
	     INTO: sGugan	
	     FROM RESCAL   	
	    WHERE RESCAL.GUGAN = :sGuCode ; 
		 IF SQLCA.SQLCODE <> 0 THEN
			 MessageBox("확인","등록되어있지 않은 구간입니다")
			 dw_buha3.SetItem(1,"gu2",SNull)
			 dw_buha3.SetFocus()
		    Return 1 
		 END IF	
	 END IF	
END IF	
	
end event

event itemerror;return 1
end event

event rbuttondown;gs_code = ''
gs_codename = ''

string sgubun

sgubun = getitemstring(1, "gubun")
IF this.GetColumnName() = "jo1" THEN
	choose case sgubun
			 case '1'
					gs_code = '03'
					Open(w_reffpf_all_popup)				
			 case '2'
				   Open(w_jomas_popup)				
			 case '3'
				   Open(w_workplace_popup)								
			 case '4'
					gs_code = '21'
					Open(w_reffpf_all_popup)
	End choose				
	
   IF isnull(gs_code) OR gs_code = '' THEN RETURN

   dw_buha3.SetItem(1,"jo1",gs_code)
   dw_buha3.SetItem(1,"joname1",gs_codename)
ELSEIF this.GetColumnName() = "jo2" THEN
	choose case sgubun
			 case '1'
					gs_code = '03'
					Open(w_reffpf_all_popup)				
			 case '2'
				   Open(w_jomas_popup)				
			 case '3'
				   Open(w_workplace_popup)								
			 case '4'
					gs_code = '21'
					Open(w_reffpf_all_popup)
	End choose				
	
   IF isnull(gs_code) OR gs_code = '' THEN RETURN

   dw_buha3.SetItem(1,"jo2",gs_code)
   dw_buha3.SetItem(1,"joname2",gs_codename)

ELSEIF this.GetColumnName() = "gu1" THEN
	Open(w_gugan_popup)
   
	IF isnull(gs_code) OR gs_code = '' THEN RETURN
   dw_buha3.SetItem(1,"gu1",gs_code) 

ELSEIF this.GetColumnName() = "gu2" THEN
	Open(w_gugan_popup)
   
	IF isnull(gs_code) OR gs_code = '' THEN RETURN
   dw_buha3.SetItem(1,"gu2",gs_code) 
	
ELSEIF this.GetColumnName() = "pordno" THEN
	Open(w_jisi_popup)
   
	IF isnull(gs_code) OR gs_code = '' THEN RETURN
   dw_buha3.SetItem(1,"pordno",gs_code) 	

END IF
end event

type dw_ban from datawindow within w_pdt_02030_two
integer x = 91
integer y = 48
integer width = 768
integer height = 88
integer taborder = 40
boolean bringtotop = true
string dataobject = "d_pdt_02030_40"
boolean border = false
boolean livescroll = true
end type

type dw_jaje from datawindow within w_pdt_02030_two
integer x = 809
integer y = 48
integer width = 741
integer height = 88
integer taborder = 60
boolean bringtotop = true
string dataobject = "d_pdt_02030_42"
boolean border = false
boolean livescroll = true
end type

type st_2 from statictext within w_pdt_02030_two
integer x = 1568
integer y = 60
integer width = 407
integer height = 64
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = hangeul!
fontpitch fontpitch = fixed!
fontfamily fontfamily = modern!
string facename = "굴림체"
long backcolor = 33027312
boolean enabled = false
string text = "생성 작지번호"
boolean focusrectangle = false
end type

type sle_bal from singlelineedit within w_pdt_02030_two
event ue_key pbm_keydown
integer x = 1984
integer y = 52
integer width = 274
integer height = 80
integer taborder = 80
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = hangeul!
fontpitch fontpitch = fixed!
fontfamily fontfamily = modern!
string facename = "굴림체"
long textcolor = 33554432
long backcolor = 33027312
boolean autohscroll = false
textcase textcase = upper!
integer limit = 8
end type

event ue_key;//if key = KeyEnter! then
//	cb_mod.setfocus()
//end if
end event

event modified;//string sBaljpno, sNull
//LonG   lCount
//
//setnull(snull)
//
//sBaljpno = trim(this.text)
//
//  SELECT COUNT(*)
//    INTO :lCount
//    FROM POMAST  
//   WHERE SABU    =    '1'   
//     AND BALJPNO LIKE :sBaljpno||'%' ;
//
//IF lCount > 0 THEN
//	MessageBox("확 인", "등록된 발주번호입니다. 생성할 발주번호를 확인하세요!")
//	this.text = sNull
//	return 1
//END IF	
//
end event

type st_3 from statictext within w_pdt_02030_two
integer x = 2295
integer y = 60
integer width = 297
integer height = 64
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = hangeul!
fontpitch fontpitch = fixed!
fontfamily fontfamily = modern!
string facename = "굴림체"
long backcolor = 33027312
boolean enabled = false
string text = "사업장구분"
boolean focusrectangle = false
end type

type dw_saupj from datawindow within w_pdt_02030_two
integer x = 2597
integer y = 44
integer width = 846
integer height = 80
integer taborder = 90
boolean bringtotop = true
string title = "none"
string dataobject = "D_PDT_02030_44"
boolean border = false
boolean livescroll = true
end type

type rr_1 from roundrectangle within w_pdt_02030_two
long linecolor = 28144969
integer linethickness = 1
long fillcolor = 33027312
integer x = 37
integer y = 16
integer width = 3447
integer height = 144
integer cornerheight = 40
integer cornerwidth = 55
end type

